if(function(t){"use strict";var e={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(e.exports={},define((function(){return e.exports}))):e.exports="undefined"!=typeof window?window:t:e.exports=exports,function(t){if(!e)var e=1e-6;if(!r)var r="undefined"!=typeof Float32Array?Float32Array:Array;if(!n)var n=Math.random;var a={setMatrixArrayType:function(t){r=t}};void 0!==t&&(t.glMatrix=a);var i=Math.PI/180;a.toRadian=function(t){return t*i};var o={create:function(){var t=new r(2);return t[0]=0,t[1]=0,t},clone:function(t){var e=new r(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var n=new r(2);return n[0]=t,n[1]=e,n},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,r){return t[0]=e,t[1]=r,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}};o.sub=o.subtract,o.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t},o.mul=o.multiply,o.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t},o.div=o.divide,o.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},o.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},o.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},o.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t},o.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(r*r+n*n)},o.dist=o.distance,o.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1];return r*r+n*n},o.sqrDist=o.squaredDistance,o.length=function(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)},o.len=o.length,o.squaredLength=function(t){var e=t[0],r=t[1];return e*e+r*r},o.sqrLen=o.squaredLength,o.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},o.normalize=function(t,e){var r=e[0],n=e[1],a=r*r+n*n;return a>0&&(a=1/Math.sqrt(a),t[0]=e[0]*a,t[1]=e[1]*a),t},o.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},o.cross=function(t,e,r){var n=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=n,t},o.lerp=function(t,e,r,n){var a=e[0],i=e[1];return t[0]=a+n*(r[0]-a),t[1]=i+n*(r[1]-i),t},o.random=function(t,e){e=e||1;var r=2*n()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},o.transformMat2=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[2]*a,t[1]=r[1]*n+r[3]*a,t},o.transformMat2d=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[2]*a+r[4],t[1]=r[1]*n+r[3]*a+r[5],t},o.transformMat3=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[3]*a+r[6],t[1]=r[1]*n+r[4]*a+r[7],t},o.transformMat4=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[4]*a+r[12],t[1]=r[1]*n+r[5]*a+r[13],t},o.forEach=function(){var t=o.create();return function(e,r,n,a,i,o){var s,u;for(r||(r=2),n||(n=0),u=a?Math.min(a*r+n,e.length):e.length,s=n;s<u;s+=r)t[0]=e[s],t[1]=e[s+1],i(t,t,o),e[s]=t[0],e[s+1]=t[1];return e}}(),o.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},void 0!==t&&(t.vec2=o);var s={create:function(){var t=new r(3);return t[0]=0,t[1]=0,t[2]=0,t},clone:function(t){var e=new r(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},fromValues:function(t,e,n){var a=new r(3);return a[0]=t,a[1]=e,a[2]=n,a},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}};s.sub=s.subtract,s.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t},s.mul=s.multiply,s.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t},s.div=s.divide,s.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},s.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},s.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},s.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t},s.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(r*r+n*n+a*a)},s.dist=s.distance,s.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],a=e[2]-t[2];return r*r+n*n+a*a},s.sqrDist=s.squaredDistance,s.length=function(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)},s.len=s.length,s.squaredLength=function(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n},s.sqrLen=s.squaredLength,s.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},s.normalize=function(t,e){var r=e[0],n=e[1],a=e[2],i=r*r+n*n+a*a;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i),t},s.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},s.cross=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=r[0],s=r[1],u=r[2];return t[0]=a*u-i*s,t[1]=i*o-n*u,t[2]=n*s-a*o,t},s.lerp=function(t,e,r,n){var a=e[0],i=e[1],o=e[2];return t[0]=a+n*(r[0]-a),t[1]=i+n*(r[1]-i),t[2]=o+n*(r[2]-o),t},s.random=function(t,e){e=e||1;var r=2*n()*Math.PI,a=2*n()-1,i=Math.sqrt(1-a*a)*e;return t[0]=Math.cos(r)*i,t[1]=Math.sin(r)*i,t[2]=a*e,t},s.transformMat4=function(t,e,r){var n=e[0],a=e[1],i=e[2];return t[0]=r[0]*n+r[4]*a+r[8]*i+r[12],t[1]=r[1]*n+r[5]*a+r[9]*i+r[13],t[2]=r[2]*n+r[6]*a+r[10]*i+r[14],t},s.transformMat3=function(t,e,r){var n=e[0],a=e[1],i=e[2];return t[0]=n*r[0]+a*r[3]+i*r[6],t[1]=n*r[1]+a*r[4]+i*r[7],t[2]=n*r[2]+a*r[5]+i*r[8],t},s.transformQuat=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=r[0],s=r[1],u=r[2],c=r[3],l=c*n+s*i-u*a,f=c*a+u*n-o*i,h=c*i+o*a-s*n,d=-o*n-s*a-u*i;return t[0]=l*c+d*-o+f*-u-h*-s,t[1]=f*c+d*-s+h*-o-l*-u,t[2]=h*c+d*-u+l*-s-f*-o,t},s.rotateX=function(t,e,r,n){var a=[],i=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],i[0]=a[0],i[1]=a[1]*Math.cos(n)-a[2]*Math.sin(n),i[2]=a[1]*Math.sin(n)+a[2]*Math.cos(n),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t},s.rotateY=function(t,e,r,n){var a=[],i=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],i[0]=a[2]*Math.sin(n)+a[0]*Math.cos(n),i[1]=a[1],i[2]=a[2]*Math.cos(n)-a[0]*Math.sin(n),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t},s.rotateZ=function(t,e,r,n){var a=[],i=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],i[0]=a[0]*Math.cos(n)-a[1]*Math.sin(n),i[1]=a[0]*Math.sin(n)+a[1]*Math.cos(n),i[2]=a[2],t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t},s.forEach=function(){var t=s.create();return function(e,r,n,a,i,o){var s,u;for(r||(r=3),n||(n=0),u=a?Math.min(a*r+n,e.length):e.length,s=n;s<u;s+=r)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],i(t,t,o),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2];return e}}(),s.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},void 0!==t&&(t.vec3=s);var u={create:function(){var t=new r(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},clone:function(t){var e=new r(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},fromValues:function(t,e,n,a){var i=new r(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=a,i},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},set:function(t,e,r,n,a){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}};u.sub=u.subtract,u.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t},u.mul=u.multiply,u.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t},u.div=u.divide,u.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},u.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},u.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},u.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t},u.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],a=e[2]-t[2],i=e[3]-t[3];return Math.sqrt(r*r+n*n+a*a+i*i)},u.dist=u.distance,u.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],a=e[2]-t[2],i=e[3]-t[3];return r*r+n*n+a*a+i*i},u.sqrDist=u.squaredDistance,u.length=function(t){var e=t[0],r=t[1],n=t[2],a=t[3];return Math.sqrt(e*e+r*r+n*n+a*a)},u.len=u.length,u.squaredLength=function(t){var e=t[0],r=t[1],n=t[2],a=t[3];return e*e+r*r+n*n+a*a},u.sqrLen=u.squaredLength,u.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},u.normalize=function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=r*r+n*n+a*a+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t[3]=e[3]*o),t},u.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},u.lerp=function(t,e,r,n){var a=e[0],i=e[1],o=e[2],s=e[3];return t[0]=a+n*(r[0]-a),t[1]=i+n*(r[1]-i),t[2]=o+n*(r[2]-o),t[3]=s+n*(r[3]-s),t},u.random=function(t,e){return e=e||1,t[0]=n(),t[1]=n(),t[2]=n(),t[3]=n(),u.normalize(t,t),u.scale(t,t,e),t},u.transformMat4=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3];return t[0]=r[0]*n+r[4]*a+r[8]*i+r[12]*o,t[1]=r[1]*n+r[5]*a+r[9]*i+r[13]*o,t[2]=r[2]*n+r[6]*a+r[10]*i+r[14]*o,t[3]=r[3]*n+r[7]*a+r[11]*i+r[15]*o,t},u.transformQuat=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=r[0],s=r[1],u=r[2],c=r[3],l=c*n+s*i-u*a,f=c*a+u*n-o*i,h=c*i+o*a-s*n,d=-o*n-s*a-u*i;return t[0]=l*c+d*-o+f*-u-h*-s,t[1]=f*c+d*-s+h*-o-l*-u,t[2]=h*c+d*-u+l*-s-f*-o,t},u.forEach=function(){var t=u.create();return function(e,r,n,a,i,o){var s,u;for(r||(r=4),n||(n=0),u=a?Math.min(a*r+n,e.length):e.length,s=n;s<u;s+=r)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],i(t,t,o),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),u.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},void 0!==t&&(t.vec4=u);var c={create:function(){var t=new r(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},clone:function(t){var e=new r(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},transpose:function(t,e){if(t===e){var r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=r*i-a*n;return o?(o=1/o,t[0]=i*o,t[1]=-n*o,t[2]=-a*o,t[3]=r*o,t):null},adjoint:function(t,e){var r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=r[0],u=r[1],c=r[2],l=r[3];return t[0]=n*s+i*u,t[1]=a*s+o*u,t[2]=n*c+i*l,t[3]=a*c+o*l,t}};c.mul=c.multiply,c.rotate=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=Math.sin(r),u=Math.cos(r);return t[0]=n*u+i*s,t[1]=a*u+o*s,t[2]=n*-s+i*u,t[3]=a*-s+o*u,t},c.scale=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=r[0],u=r[1];return t[0]=n*s,t[1]=a*s,t[2]=i*u,t[3]=o*u,t},c.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},c.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},c.LDU=function(t,e,r,n){return t[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-t[2]*r[1],[t,e,r]},void 0!==t&&(t.mat2=c);var l={create:function(){var t=new r(6);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},clone:function(t){var e=new r(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},invert:function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=r*i-n*a;return u?(u=1/u,t[0]=i*u,t[1]=-n*u,t[2]=-a*u,t[3]=r*u,t[4]=(a*s-i*o)*u,t[5]=(n*o-r*s)*u,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=r[0],l=r[1],f=r[2],h=r[3],d=r[4],_=r[5];return t[0]=n*c+i*l,t[1]=a*c+o*l,t[2]=n*f+i*h,t[3]=a*f+o*h,t[4]=n*d+i*_+s,t[5]=a*d+o*_+u,t}};l.mul=l.multiply,l.rotate=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=Math.sin(r),l=Math.cos(r);return t[0]=n*l+i*c,t[1]=a*l+o*c,t[2]=n*-c+i*l,t[3]=a*-c+o*l,t[4]=s,t[5]=u,t},l.scale=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=r[0],l=r[1];return t[0]=n*c,t[1]=a*c,t[2]=i*l,t[3]=o*l,t[4]=s,t[5]=u,t},l.translate=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=r[0],l=r[1];return t[0]=n,t[1]=a,t[2]=i,t[3]=o,t[4]=n*c+i*l+s,t[5]=a*c+o*l+u,t},l.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},l.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},void 0!==t&&(t.mat2d=l);var f={create:function(){var t=new r(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new r(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(t===e){var r=e[1],n=e[2],a=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=n,t[7]=a}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},invert:function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],l=e[8],f=l*o-s*c,h=-l*i+s*u,d=c*i-o*u,_=r*f+n*h+a*d;return _?(_=1/_,t[0]=f*_,t[1]=(-l*n+a*c)*_,t[2]=(s*n-a*o)*_,t[3]=h*_,t[4]=(l*r-a*u)*_,t[5]=(-s*r+a*i)*_,t[6]=d*_,t[7]=(-c*r+n*u)*_,t[8]=(o*r-n*i)*_,t):null},adjoint:function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],l=e[8];return t[0]=o*l-s*c,t[1]=a*c-n*l,t[2]=n*s-a*o,t[3]=s*u-i*l,t[4]=r*l-a*u,t[5]=a*i-r*s,t[6]=i*c-o*u,t[7]=n*u-r*c,t[8]=r*o-n*i,t},determinant:function(t){var e=t[0],r=t[1],n=t[2],a=t[3],i=t[4],o=t[5],s=t[6],u=t[7],c=t[8];return e*(c*i-o*u)+r*(-c*a+o*s)+n*(u*a-i*s)},multiply:function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],l=e[7],f=e[8],h=r[0],d=r[1],_=r[2],v=r[3],p=r[4],m=r[5],g=r[6],E=r[7],x=r[8];return t[0]=h*n+d*o+_*c,t[1]=h*a+d*s+_*l,t[2]=h*i+d*u+_*f,t[3]=v*n+p*o+m*c,t[4]=v*a+p*s+m*l,t[5]=v*i+p*u+m*f,t[6]=g*n+E*o+x*c,t[7]=g*a+E*s+x*l,t[8]=g*i+E*u+x*f,t}};f.mul=f.multiply,f.translate=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],l=e[7],f=e[8],h=r[0],d=r[1];return t[0]=n,t[1]=a,t[2]=i,t[3]=o,t[4]=s,t[5]=u,t[6]=h*n+d*o+c,t[7]=h*a+d*s+l,t[8]=h*i+d*u+f,t},f.rotate=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],l=e[7],f=e[8],h=Math.sin(r),d=Math.cos(r);return t[0]=d*n+h*o,t[1]=d*a+h*s,t[2]=d*i+h*u,t[3]=d*o-h*n,t[4]=d*s-h*a,t[5]=d*u-h*i,t[6]=c,t[7]=l,t[8]=f,t},f.scale=function(t,e,r){var n=r[0],a=r[1];return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=a*e[3],t[4]=a*e[4],t[5]=a*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},f.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},f.fromQuat=function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=r+r,s=n+n,u=a+a,c=r*o,l=n*o,f=n*s,h=a*o,d=a*s,_=a*u,v=i*o,p=i*s,m=i*u;return t[0]=1-f-_,t[3]=l-m,t[6]=h+p,t[1]=l+m,t[4]=1-c-_,t[7]=d-v,t[2]=h-p,t[5]=d+v,t[8]=1-c-f,t},f.normalFromMat4=function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],l=e[8],f=e[9],h=e[10],d=e[11],_=e[12],v=e[13],p=e[14],m=e[15],g=r*s-n*o,E=r*u-a*o,x=r*c-i*o,T=n*u-a*s,b=n*c-i*s,y=a*c-i*u,A=l*v-f*_,w=l*p-h*_,M=l*m-d*_,R=f*p-h*v,F=f*m-d*v,S=h*m-d*p,B=g*S-E*F+x*R+T*M-b*w+y*A;return B?(B=1/B,t[0]=(s*S-u*F+c*R)*B,t[1]=(u*M-o*S-c*w)*B,t[2]=(o*F-s*M+c*A)*B,t[3]=(a*F-n*S-i*R)*B,t[4]=(r*S-a*M+i*w)*B,t[5]=(n*M-r*F-i*A)*B,t[6]=(v*y-p*b+m*T)*B,t[7]=(p*x-_*y-m*E)*B,t[8]=(_*b-v*x+m*g)*B,t):null},f.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},f.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},void 0!==t&&(t.mat3=f);var h={create:function(){var t=new r(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},clone:function(t){var e=new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transpose:function(t,e){if(t===e){var r=e[1],n=e[2],a=e[3],i=e[6],o=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=i,t[11]=e[14],t[12]=a,t[13]=o,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],l=e[8],f=e[9],h=e[10],d=e[11],_=e[12],v=e[13],p=e[14],m=e[15],g=r*s-n*o,E=r*u-a*o,x=r*c-i*o,T=n*u-a*s,b=n*c-i*s,y=a*c-i*u,A=l*v-f*_,w=l*p-h*_,M=l*m-d*_,R=f*p-h*v,F=f*m-d*v,S=h*m-d*p,B=g*S-E*F+x*R+T*M-b*w+y*A;return B?(B=1/B,t[0]=(s*S-u*F+c*R)*B,t[1]=(a*F-n*S-i*R)*B,t[2]=(v*y-p*b+m*T)*B,t[3]=(h*b-f*y-d*T)*B,t[4]=(u*M-o*S-c*w)*B,t[5]=(r*S-a*M+i*w)*B,t[6]=(p*x-_*y-m*E)*B,t[7]=(l*y-h*x+d*E)*B,t[8]=(o*F-s*M+c*A)*B,t[9]=(n*M-r*F-i*A)*B,t[10]=(_*b-v*x+m*g)*B,t[11]=(f*x-l*b-d*g)*B,t[12]=(s*w-o*R-u*A)*B,t[13]=(r*R-n*w+a*A)*B,t[14]=(v*E-_*T-p*g)*B,t[15]=(l*T-f*E+h*g)*B,t):null},adjoint:function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],l=e[8],f=e[9],h=e[10],d=e[11],_=e[12],v=e[13],p=e[14],m=e[15];return t[0]=s*(h*m-d*p)-f*(u*m-c*p)+v*(u*d-c*h),t[1]=-(n*(h*m-d*p)-f*(a*m-i*p)+v*(a*d-i*h)),t[2]=n*(u*m-c*p)-s*(a*m-i*p)+v*(a*c-i*u),t[3]=-(n*(u*d-c*h)-s*(a*d-i*h)+f*(a*c-i*u)),t[4]=-(o*(h*m-d*p)-l*(u*m-c*p)+_*(u*d-c*h)),t[5]=r*(h*m-d*p)-l*(a*m-i*p)+_*(a*d-i*h),t[6]=-(r*(u*m-c*p)-o*(a*m-i*p)+_*(a*c-i*u)),t[7]=r*(u*d-c*h)-o*(a*d-i*h)+l*(a*c-i*u),t[8]=o*(f*m-d*v)-l*(s*m-c*v)+_*(s*d-c*f),t[9]=-(r*(f*m-d*v)-l*(n*m-i*v)+_*(n*d-i*f)),t[10]=r*(s*m-c*v)-o*(n*m-i*v)+_*(n*c-i*s),t[11]=-(r*(s*d-c*f)-o*(n*d-i*f)+l*(n*c-i*s)),t[12]=-(o*(f*p-h*v)-l*(s*p-u*v)+_*(s*h-u*f)),t[13]=r*(f*p-h*v)-l*(n*p-a*v)+_*(n*h-a*f),t[14]=-(r*(s*p-u*v)-o*(n*p-a*v)+_*(n*u-a*s)),t[15]=r*(s*h-u*f)-o*(n*h-a*f)+l*(n*u-a*s),t},determinant:function(t){var e=t[0],r=t[1],n=t[2],a=t[3],i=t[4],o=t[5],s=t[6],u=t[7],c=t[8],l=t[9],f=t[10],h=t[11],d=t[12],_=t[13],v=t[14],p=t[15];return(e*o-r*i)*(f*p-h*v)-(e*s-n*i)*(l*p-h*_)+(e*u-a*i)*(l*v-f*_)+(r*s-n*o)*(c*p-h*d)-(r*u-a*o)*(c*v-f*d)+(n*u-a*s)*(c*_-l*d)},multiply:function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],l=e[7],f=e[8],h=e[9],d=e[10],_=e[11],v=e[12],p=e[13],m=e[14],g=e[15],E=r[0],x=r[1],T=r[2],b=r[3];return t[0]=E*n+x*s+T*f+b*v,t[1]=E*a+x*u+T*h+b*p,t[2]=E*i+x*c+T*d+b*m,t[3]=E*o+x*l+T*_+b*g,E=r[4],x=r[5],T=r[6],b=r[7],t[4]=E*n+x*s+T*f+b*v,t[5]=E*a+x*u+T*h+b*p,t[6]=E*i+x*c+T*d+b*m,t[7]=E*o+x*l+T*_+b*g,E=r[8],x=r[9],T=r[10],b=r[11],t[8]=E*n+x*s+T*f+b*v,t[9]=E*a+x*u+T*h+b*p,t[10]=E*i+x*c+T*d+b*m,t[11]=E*o+x*l+T*_+b*g,E=r[12],x=r[13],T=r[14],b=r[15],t[12]=E*n+x*s+T*f+b*v,t[13]=E*a+x*u+T*h+b*p,t[14]=E*i+x*c+T*d+b*m,t[15]=E*o+x*l+T*_+b*g,t}};h.mul=h.multiply,h.translate=function(t,e,r){var n,a,i,o,s,u,c,l,f,h,d,_,v=r[0],p=r[1],m=r[2];return e===t?(t[12]=e[0]*v+e[4]*p+e[8]*m+e[12],t[13]=e[1]*v+e[5]*p+e[9]*m+e[13],t[14]=e[2]*v+e[6]*p+e[10]*m+e[14],t[15]=e[3]*v+e[7]*p+e[11]*m+e[15]):(n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],l=e[7],f=e[8],h=e[9],d=e[10],_=e[11],t[0]=n,t[1]=a,t[2]=i,t[3]=o,t[4]=s,t[5]=u,t[6]=c,t[7]=l,t[8]=f,t[9]=h,t[10]=d,t[11]=_,t[12]=n*v+s*p+f*m+e[12],t[13]=a*v+u*p+h*m+e[13],t[14]=i*v+c*p+d*m+e[14],t[15]=o*v+l*p+_*m+e[15]),t},h.scale=function(t,e,r){var n=r[0],a=r[1],i=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*a,t[5]=e[5]*a,t[6]=e[6]*a,t[7]=e[7]*a,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},h.rotate=function(t,r,n,a){var i,o,s,u,c,l,f,h,d,_,v,p,m,g,E,x,T,b,y,A,w,M,R,F,S=a[0],B=a[1],C=a[2],I=Math.sqrt(S*S+B*B+C*C);return Math.abs(I)<e?null:(S*=I=1/I,B*=I,C*=I,i=Math.sin(n),s=1-(o=Math.cos(n)),u=r[0],c=r[1],l=r[2],f=r[3],h=r[4],d=r[5],_=r[6],v=r[7],p=r[8],m=r[9],g=r[10],E=r[11],x=S*S*s+o,T=B*S*s+C*i,b=C*S*s-B*i,y=S*B*s-C*i,A=B*B*s+o,w=C*B*s+S*i,M=S*C*s+B*i,R=B*C*s-S*i,F=C*C*s+o,t[0]=u*x+h*T+p*b,t[1]=c*x+d*T+m*b,t[2]=l*x+_*T+g*b,t[3]=f*x+v*T+E*b,t[4]=u*y+h*A+p*w,t[5]=c*y+d*A+m*w,t[6]=l*y+_*A+g*w,t[7]=f*y+v*A+E*w,t[8]=u*M+h*R+p*F,t[9]=c*M+d*R+m*F,t[10]=l*M+_*R+g*F,t[11]=f*M+v*R+E*F,r!==t&&(t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t)},h.rotateX=function(t,e,r){var n=Math.sin(r),a=Math.cos(r),i=e[4],o=e[5],s=e[6],u=e[7],c=e[8],l=e[9],f=e[10],h=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=i*a+c*n,t[5]=o*a+l*n,t[6]=s*a+f*n,t[7]=u*a+h*n,t[8]=c*a-i*n,t[9]=l*a-o*n,t[10]=f*a-s*n,t[11]=h*a-u*n,t},h.rotateY=function(t,e,r){var n=Math.sin(r),a=Math.cos(r),i=e[0],o=e[1],s=e[2],u=e[3],c=e[8],l=e[9],f=e[10],h=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*a-c*n,t[1]=o*a-l*n,t[2]=s*a-f*n,t[3]=u*a-h*n,t[8]=i*n+c*a,t[9]=o*n+l*a,t[10]=s*n+f*a,t[11]=u*n+h*a,t},h.rotateZ=function(t,e,r){var n=Math.sin(r),a=Math.cos(r),i=e[0],o=e[1],s=e[2],u=e[3],c=e[4],l=e[5],f=e[6],h=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*a+c*n,t[1]=o*a+l*n,t[2]=s*a+f*n,t[3]=u*a+h*n,t[4]=c*a-i*n,t[5]=l*a-o*n,t[6]=f*a-s*n,t[7]=h*a-u*n,t},h.fromRotationTranslation=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=n+n,u=a+a,c=i+i,l=n*s,f=n*u,h=n*c,d=a*u,_=a*c,v=i*c,p=o*s,m=o*u,g=o*c;return t[0]=1-(d+v),t[1]=f+g,t[2]=h-m,t[3]=0,t[4]=f-g,t[5]=1-(l+v),t[6]=_+p,t[7]=0,t[8]=h+m,t[9]=_-p,t[10]=1-(l+d),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},h.fromQuat=function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=r+r,s=n+n,u=a+a,c=r*o,l=n*o,f=n*s,h=a*o,d=a*s,_=a*u,v=i*o,p=i*s,m=i*u;return t[0]=1-f-_,t[1]=l+m,t[2]=h-p,t[3]=0,t[4]=l-m,t[5]=1-c-_,t[6]=d+v,t[7]=0,t[8]=h+p,t[9]=d-v,t[10]=1-c-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},h.frustum=function(t,e,r,n,a,i,o){var s=1/(r-e),u=1/(a-n),c=1/(i-o);return t[0]=2*i*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*i*u,t[6]=0,t[7]=0,t[8]=(r+e)*s,t[9]=(a+n)*u,t[10]=(o+i)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*i*2*c,t[15]=0,t},h.perspective=function(t,e,r,n,a){var i=1/Math.tan(e/2),o=1/(n-a);return t[0]=i/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(a+n)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*a*n*o,t[15]=0,t},h.ortho=function(t,e,r,n,a,i,o){var s=1/(e-r),u=1/(n-a),c=1/(i-o);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*s,t[13]=(a+n)*u,t[14]=(o+i)*c,t[15]=1,t},h.lookAt=function(t,r,n,a){var i,o,s,u,c,l,f,d,_,v,p=r[0],m=r[1],g=r[2],E=a[0],x=a[1],T=a[2],b=n[0],y=n[1],A=n[2];return Math.abs(p-b)<e&&Math.abs(m-y)<e&&Math.abs(g-A)<e?h.identity(t):(f=p-b,d=m-y,_=g-A,i=x*(_*=v=1/Math.sqrt(f*f+d*d+_*_))-T*(d*=v),o=T*(f*=v)-E*_,s=E*d-x*f,(v=Math.sqrt(i*i+o*o+s*s))?(i*=v=1/v,o*=v,s*=v):(i=0,o=0,s=0),u=d*s-_*o,c=_*i-f*s,l=f*o-d*i,(v=Math.sqrt(u*u+c*c+l*l))?(u*=v=1/v,c*=v,l*=v):(u=0,c=0,l=0),t[0]=i,t[1]=u,t[2]=f,t[3]=0,t[4]=o,t[5]=c,t[6]=d,t[7]=0,t[8]=s,t[9]=l,t[10]=_,t[11]=0,t[12]=-(i*p+o*m+s*g),t[13]=-(u*p+c*m+l*g),t[14]=-(f*p+d*m+_*g),t[15]=1,t)},h.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},h.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},void 0!==t&&(t.mat4=h);var d={create:function(){var t=new r(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}};d.rotationTo=function(){var t=s.create(),e=s.fromValues(1,0,0),r=s.fromValues(0,1,0);return function(n,a,i){var o=s.dot(a,i);return o<-.999999?(s.cross(t,e,a),s.length(t)<1e-6&&s.cross(t,r,a),s.normalize(t,t),d.setAxisAngle(n,t,Math.PI),n):o>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(s.cross(t,a,i),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=1+o,d.normalize(n,n))}}(),d.setAxes=function(){var t=f.create();return function(e,r,n,a){return t[0]=n[0],t[3]=n[1],t[6]=n[2],t[1]=a[0],t[4]=a[1],t[7]=a[2],t[2]=-r[0],t[5]=-r[1],t[8]=-r[2],d.normalize(e,d.fromMat3(e,t))}}(),d.clone=u.clone,d.fromValues=u.fromValues,d.copy=u.copy,d.set=u.set,d.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},d.setAxisAngle=function(t,e,r){r*=.5;var n=Math.sin(r);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(r),t},d.add=u.add,d.multiply=function(t,e,r){var n=e[0],a=e[1],i=e[2],o=e[3],s=r[0],u=r[1],c=r[2],l=r[3];return t[0]=n*l+o*s+a*c-i*u,t[1]=a*l+o*u+i*s-n*c,t[2]=i*l+o*c+n*u-a*s,t[3]=o*l-n*s-a*u-i*c,t},d.mul=d.multiply,d.scale=u.scale,d.rotateX=function(t,e,r){r*=.5;var n=e[0],a=e[1],i=e[2],o=e[3],s=Math.sin(r),u=Math.cos(r);return t[0]=n*u+o*s,t[1]=a*u+i*s,t[2]=i*u-a*s,t[3]=o*u-n*s,t},d.rotateY=function(t,e,r){r*=.5;var n=e[0],a=e[1],i=e[2],o=e[3],s=Math.sin(r),u=Math.cos(r);return t[0]=n*u-i*s,t[1]=a*u+o*s,t[2]=i*u+n*s,t[3]=o*u-a*s,t},d.rotateZ=function(t,e,r){r*=.5;var n=e[0],a=e[1],i=e[2],o=e[3],s=Math.sin(r),u=Math.cos(r);return t[0]=n*u+a*s,t[1]=a*u-n*s,t[2]=i*u+o*s,t[3]=o*u-i*s,t},d.calculateW=function(t,e){var r=e[0],n=e[1],a=e[2];return t[0]=r,t[1]=n,t[2]=a,t[3]=-Math.sqrt(Math.abs(1-r*r-n*n-a*a)),t},d.dot=u.dot,d.lerp=u.lerp,d.slerp=function(t,e,r,n){var a,i,o,s,u,c=e[0],l=e[1],f=e[2],h=e[3],d=r[0],_=r[1],v=r[2],p=r[3];return(i=c*d+l*_+f*v+h*p)<0&&(i=-i,d=-d,_=-_,v=-v,p=-p),1-i>1e-6?(a=Math.acos(i),o=Math.sin(a),s=Math.sin((1-n)*a)/o,u=Math.sin(n*a)/o):(s=1-n,u=n),t[0]=s*c+u*d,t[1]=s*l+u*_,t[2]=s*f+u*v,t[3]=s*h+u*p,t},d.invert=function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=r*r+n*n+a*a+i*i,s=o?1/o:0;return t[0]=-r*s,t[1]=-n*s,t[2]=-a*s,t[3]=i*s,t},d.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},d.length=u.length,d.len=d.length,d.squaredLength=u.squaredLength,d.sqrLen=d.squaredLength,d.normalize=u.normalize,d.fromMat3=function(t,e){var r,n=e[0]+e[4]+e[8];if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var i=(a+1)%3,o=(a+2)%3;r=Math.sqrt(e[3*a+a]-e[3*i+i]-e[3*o+o]+1),t[a]=.5*r,r=.5/r,t[3]=(e[3*o+i]-e[3*i+o])*r,t[i]=(e[3*i+a]+e[3*a+i])*r,t[o]=(e[3*o+a]+e[3*a+o])*r}return t},d.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},void 0!==t&&(t.quat=d)}(e.exports)}(this),function(t){function e(e,r,n,a){if(this.gl=a=a||t.gl,this._context_id=a.context_id,e&&e.constructor!==Array)throw"FBO textures must be an Array";this.handler=null,this.height=this.width=-1,this.color_textures=[],this.depth_texture=null,this.stencil=!!n,this._stencil_enabled=!1,this._num_binded_textures=0,(e&&e.length||r)&&this.setTextures(e,r),this._old_fbo=null,this._old_viewport=new Float32Array(4)}var r=t.GL={};t.requestAnimationFrame=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},r.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0},r.LEFT_MOUSE_BUTTON=1,r.MIDDLE_MOUSE_BUTTON=2,r.RIGHT_MOUSE_BUTTON=3,r.last_context_id=0,r.TEXTURE_2D=3553,r.TEXTURE_CUBE_MAP=34067,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.HALF_FLOAT_OES=36193,r.DEPTH_COMPONENT16=33189,r.FLOAT_VEC2=35664,r.FLOAT_VEC3=35665,r.FLOAT_VEC4=35666,r.INT_VEC2=35667,r.INT_VEC3=35668,r.INT_VEC4=35669,r.BOOL=35670,r.BOOL_VEC2=35671,r.BOOL_VEC3=35672,r.BOOL_VEC4=35673,r.FLOAT_MAT2=35674,r.FLOAT_MAT3=35675,r.FLOAT_MAT4=35676,r.DEPTH_COMPONENT=6402,r.ALPHA=6406,r.RGB=6407,r.RGBA=6408,r.LUMINANCE=6409,r.LUMINANCE_ALPHA=6410,r.NEAREST=9728,r.LINEAR=9729,r.NEAREST_MIPMAP_NEAREST=9984,r.LINEAR_MIPMAP_NEAREST=9985,r.NEAREST_MIPMAP_LINEAR=9986,r.LINEAR_MIPMAP_LINEAR=9987,r.REPEAT=10497,r.CLAMP_TO_EDGE=33071,r.MIRRORED_REPEAT=33648,r.ZERO=0,r.ONE=1,r.SRC_COLOR=768,r.ONE_MINUS_SRC_COLOR=769,r.SRC_ALPHA=770,r.ONE_MINUS_SRC_ALPHA=771,r.DST_ALPHA=772,r.ONE_MINUS_DST_ALPHA=773,r.DST_COLOR=774,r.ONE_MINUS_DST_COLOR=775,r.SRC_ALPHA_SATURATE=776,r.CONSTANT_COLOR=32769,r.ONE_MINUS_CONSTANT_COLOR=32770,r.CONSTANT_ALPHA=32771,r.ONE_MINUS_CONSTANT_ALPHA=32772,r.VERTEX_SHADER=35633,r.FRAGMENT_SHADER=35632,r.CW=2304,r.CCW=2305,r.FRONT=1028,r.BACK=1029,r.FRONT_AND_BACK=1032,r.NEVER=512,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.NOTEQUAL=517,r.GEQUAL=518,r.ALWAYS=519,r.temp_vec3=vec3.create(),r.temp2_vec3=vec3.create(),r.temp_vec4=vec4.create(),r.temp_quat=quat.create(),r.temp_mat3=mat3.create(),r.temp_mat4=mat4.create(),t.DEG2RAD=.0174532925,t.RAD2DEG=57.295779578552306,t.EPSILON=1e-6,t.isPowerOfTwo=r.isPowerOfTwo=function(t){return 0==Math.log(t)/Math.log(2)%1},t.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date),r.getTime=t.getTime,t.isFunction=function(t){return!!(t&&t.constructor&&t.call&&t.apply)},t.isArray=function(t){return t&&t.constructor===Array},t.isNumber=function(t){return null!=t&&t.constructor===Number},t.cloneObject=r.cloneObject=function(t,e){if(t.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";for(var n in e=e||{},t){var a=t[n];if(null===a)e[n]=null;else switch(a.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:e[n]=new a.constructor(a);break;case Boolean:case Number:case String:e[n]=a;break;case Array:e[n]=a.concat();break;case Object:e[n]=r.cloneObject(a)}}return e},t.regexMap=function(t,e,r){for(var n;null!=(n=t.exec(e));)r(n)},t.createCanvas=r.createCanvas=function(t,e){var r=document.createElement("canvas");return r.width=t,r.height=e,r},t.cloneCanvas=r.cloneCanvas=function(t){var e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0),e},"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var t=document.createElement("canvas");return t.width=this.width,t.height=this.height,(t=t.getContext("2d")).drawImage(this,0,0),t.getImageData(0,0,this.width,this.height).data}),String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(t){var e,r=this;for(e in t)r=r.split(e).join(t[e]);return r},enumerable:!1}),String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var t,e,r=0;if(0==this.length)return r;for(t=0,e=this.length;t<e;++t)r=(r<<5)-r+this.charCodeAt(t),r|=0;return r},enumerable:!1}),Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1}),t.wipeObject=function(t){for(var e in t)t.hasOwnProperty(e)&&delete t[e]},t.extendClass=r.extendClass=function(t,e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r]);if(e.prototype){var n=Object.getOwnPropertyNames(e.prototype);for(r=0;r<n.length;++r){var a=n[r];t.prototype.hasOwnProperty(a)||(e.prototype.__lookupGetter__(a)?t.prototype.__defineGetter__(a,e.prototype.__lookupGetter__(a)):t.prototype[a]=e.prototype[a],e.prototype.__lookupSetter__(a)&&t.prototype.__defineSetter__(a,e.prototype.__lookupSetter__(a)))}}t.hasOwnProperty("superclass")||Object.defineProperty(t,"superclass",{get:function(){return e},enumerable:!1})},t.HttpRequest=r.request=function(t,e,r,n,a){var i=!0;if(a&&void 0!==a.async&&(i=a.async),e){var o,s=null;s=[];for(o in e)s.push(o+"="+e[o]);t=t+"?"+(s=s.join("&"))}var u=new XMLHttpRequest;if(u.open("GET",t,i),u.onload=function(t){this.getResponseHeader("Content-Type"),200!=this.status?(d.trigger(u,"fail",this.status),n&&n(this.status)):(d.trigger(u,"done",this.response),r&&r(this.response))},u.onerror=function(t){d.trigger(u,"fail",t)},a){for(o in a)u[o]=a[o];a.binary&&(u.responseType="arraybuffer")}return u.send(),u},XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(t){return d.bind(this,"done",(function(e,r){t(r)})),this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(t){return d.bind(this,"fail",(function(e,r){t(r)})),this}}),t.getFileExtension=function(t){var e=t.indexOf("?");return-1!=e&&(t=t.substr(0,e)),-1==(e=t.lastIndexOf("."))?"":t.substr(e+1).toLowerCase()},t.loadFileAtlas=r.loadFileAtlas=function(t,e,n){var a=null;return HttpRequest(t,null,(function(t){t=r.processFileAtlas(t),e&&e(t),a&&a(t)}),alert,n),{done:function(t){a=t}}},t.processFileAtlas=r.processFileAtlas=function(t,e){for(var r=t.split("\n"),n={},a=[],i="",o=0,s=r.length;o<s;o++){var u=e?r[o]:r[o].trim();u.length&&("\\"!=u[0]?a.push(u):(a.length&&(n[i]=a.join("\n")),a.length=0,i=u.substr(1)))}return a.length&&(n[i]=a.join("\n")),n},t.hexColorToRGBA=function(){function t(t,e,r){return 0>r&&(r+=1),1<r&&(r-=1),r<1/6?t+6*(e-t)*r:.5>r?e:r<2/3?t+(e-t)*(2/3-r)*6:t}function e(e,r,n,a){if(a=a||vec3.create(),0==r)n=r=e=n;else{var i=.5>n?n*(1+r):n+r-n*r,o=2*n-i;n=t(o,i,e+1/3),r=t(o,i,e),e=t(o,i,e-1/3)}return a[0]=n,a[1]=r,a[2]=e,a}var r={white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,0,0,0]};return function(t,n,a){if(a=void 0===a?1:a,(n=n||new Float32Array(4))[3]=a,"string"!=typeof t)return n;var i=r[t];return void 0!==i?(n.set(i),n[3]=3==n.length?a:n[3]*a,n):-1!=(i=t.indexOf("rgba("))?(t=(t=t.substr(5)).split(","),n[0]=parseInt(t[0])/255,n[1]=parseInt(t[1])/255,n[2]=parseInt(t[2])/255,n[3]=parseFloat(t[3])*a,n):-1!=(i=t.indexOf("hsla("))?(t=(t=t.substr(5)).split(","),e(parseInt(t[0])/360,parseInt(t[1])/100,parseInt(t[2])/100,n),n[3]=parseFloat(t[3])*a,n):(n[3]=a,-1!=(i=t.indexOf("rgb("))?(t=(t=t.substr(3)).split(","),n[0]=parseInt(t[0])/255,n[1]=parseInt(t[1])/255,n[2]=parseInt(t[2])/255,n):-1!=(i=t.indexOf("hsl("))?(t=(t=t.substr(5)).split(","),e(parseInt(t[0])/360,parseInt(t[1])/100,parseInt(t[2])/100,n),n):(t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,r,n){return e+e+r+r+n+n})),(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))?(n[0]=parseInt(a[1],16)/255,n[1]=parseInt(a[2],16)/255,n[2]=parseInt(a[3],16)/255,n):n))}}();var n=function(){function t(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function e(t,e,r,n){var a=new Uint16Array(4),i=new Uint16Array(r*n),o=0,s=0,u=0,c=s=o=0,l=0,f=0,h=0,d=r/4;n/=4;for(var _=0;_<n;_++)for(var v=0;v<d;v++)u=e+4*(_*d+v),a[0]=t[u],a[1]=t[u+1],o=31&a[0],s=2016&a[0],c=63488&a[0],l=31&a[1],f=2016&a[1],h=63488&a[1],a[2]=5*o+3*l>>3|5*s+3*f>>3&2016|5*c+3*h>>3&63488,a[3]=5*l+3*o>>3|5*f+3*s>>3&2016|5*h+3*c>>3&63488,o=t[u+2],i[s=4*_*r+4*v]=a[3&o],i[s+1]=a[o>>2&3],i[s+2]=a[o>>4&3],i[s+3]=a[o>>6&3],i[s+=r]=a[o>>8&3],i[s+1]=a[o>>10&3],i[s+2]=a[o>>12&3],i[s+3]=a[o>>14],o=t[u+3],i[s+=r]=a[3&o],i[s+1]=a[o>>2&3],i[s+2]=a[o>>4&3],i[s+3]=a[o>>6&3],i[s+=r]=a[o>>8&3],i[s+1]=a[o>>10&3],i[s+2]=a[o>>12&3],i[s+3]=a[o>>14];return i}function r(t){for(var e=0,r=t.length,n=0;e<r;e+=4)n=t[e],t[e]=t[e+2],t[e+2]=n}function n(t,n,a,i){var y,A,w,M,R,F,S,B,C,I=new Int32Array(a,0,d);if(I[_]!=o)return console.error("Invalid magic number in DDS header"),0;if(!I[x]&c)return console.error("Unsupported format, must contain a FourCC code"),0;switch(y=I[T]){case l:A=8,w=n?n.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case f:A=16,w=n?n.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case h:A=16,w=n?n.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:A=4,y=null,w=t.RGBA}if(S=1,I[p]&s&&!1!==i&&(S=Math.max(1,I[E])),M=I[g],R=I[m],F=I[v]+4,I[b+1]&u)for(C=0;6>C;++C)for(M=I[g],R=I[m],B=0;B<S;++B)y?(i=Math.max(4,M)/4*Math.max(4,R)/4*A,n=new Uint8Array(a,F,i),t.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+C,B,w,M,R,0,n)):(t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),i=M*R*A,r(n=new Uint8Array(a,F,i)),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+C,B,w,M,R,0,t.RGBA,t.UNSIGNED_BYTE,n)),F+=i,M*=.5,R*=.5;else if(n)for(t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),B=0;B<S;++B)y?(i=Math.max(4,M)/4*Math.max(4,R)/4*A,n=new Uint8Array(a,F,i),t.compressedTexImage2D(t.TEXTURE_2D,B,w,M,R,0,n)):(i=M*R*A,r(n=new Uint8Array(a,F,i)),t.texImage2D(t.TEXTURE_2D,B,w,M,R,0,w,t.UNSIGNED_BYTE,n)),F+=i,M*=.5,R*=.5;else{if(y!=l)return console.error("No manual decoder for",String.fromCharCode(255&y,y>>8&255,y>>16&255,y>>24&255),"and no native support"),0;Math.max(4,M),Math.max(4,R),a=e(n=new Uint16Array(a),F/2,M,R),t.texImage2D(t.TEXTURE_2D,0,t.RGB,M,R,0,t.RGB,t.UNSIGNED_SHORT_5_6_5,a),i&&t.generateMipmap(t.TEXTURE_2D)}return S}function a(t,n){var a,i,y,A,w,M,R,F,S,B,C=new Int32Array(t,0,d);if(C[_]!=o)return console.error("Invalid magic number in DDS header"),0;if(!C[x]&c)return console.error("Unsupported format, must contain a FourCC code"),0;switch(a=C[T]){case l:i=8,y="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case f:i=16,y="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case h:i=16,y="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:i=4,y="RGBA"}F=1,C[p]&s&&!1!==loadMipmaps&&(F=Math.max(1,C[E])),A=C[g],w=C[m],R=C[v]+4;var I=[];if(C[b+1]&u)for(B=0;6>B;++B)for(A=C[g],w=C[m],S=0;S<F;++S)a?(M=Math.max(4,A)/4*Math.max(4,w)/4*i,new Uint8Array(t,R,M),I.push({tex:"TEXTURE_CUBE_MAP",face:B,mipmap:S,internalFormat:y,width:A,height:w,offset:0,dataOffset:R,dataLength:M})):(M=A*w*i,r(new Uint8Array(t,R,M)),I.push({tex:"TEXTURE_CUBE_MAP",face:B,mipmap:S,internalFormat:y,width:A,height:w,offset:0,type:"UNSIGNED_BYTE",dataOffset:R,dataLength:M})),R+=M,A*=.5,w*=.5;else if(n){if(a!=l)return console.error("No manual decoder for",String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255),"and no native support"),0;Math.max(4,A),Math.max(4,w),C=e(new Uint16Array(t),R/2,A,w),I.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:A,height:w,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:C})}else for(S=0;S<F;++S)M=Math.max(4,A)/4*Math.max(4,w)/4*i,new Uint8Array(t,R,M),I.push({tex:"TEXTURE_2D",mipmap:S,internalFormat:y,width:A,height:w,offset:0,type:"UNSIGNED_BYTE",dataOffset:R,dataLength:M}),R+=M,A*=.5,w*=.5;return I}function i(t,e,r,a,i,o){var s=new XMLHttpRequest;return s.open("GET",r,!0),s.responseType="arraybuffer",s.onload=function(){if(200==this.status){var r=new Int32Array(this.response,0,d),s=r[b+1]&u?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D;t.bindTexture(s,a);var c=n(t,e,this.response,i);t.texParameteri(s,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(s,t.TEXTURE_MIN_FILTER,1<c?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.bindTexture(s,null),a.texture_type=s,a.width=r[g],a.height=r[m]}o&&o(a)},s.send(null),a}var o=542327876,s=131072,u=512,c=4,l=t("DXT1"),f=t("DXT3"),h=t("DXT5"),d=31,_=0,v=1,p=2,m=3,g=4,E=7,x=20,T=21,b=27;return{dxtToRgb565:e,uploadDDSLevels:n,loadDDSTextureEx:i,loadDDSTexture:function(t,e,r,n){var a=t.createTexture();return e=t.getExtension("WEBGL_compressed_texture_s3tc"),i(t,e,r,a,!0,n),a},loadDDSTextureFromMemoryEx:function(t,e,r,a,i){var o=new Int32Array(r,0,d),s=!!(o[b+1]&u),c=s?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D;return t.bindTexture(c,a.handler),e=n(t,e,r,i),t.texParameteri(c,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(c,t.TEXTURE_MIN_FILTER,1<e?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),s&&(t.texParameteri(c,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(c,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),t.bindTexture(c,null),a.handler&&(a.texture_type=c,a.width=o[g],a.height=o[m]),a},getDDSTextureFromMemoryEx:function(t){var e=new Int32Array(t,0,d);return{type:e[b+1]&u?"TEXTURE_CUBE_MAP":"TEXTURE_2D",buffers:a(t),data:t,width:e[g],height:e[m]}}}}();if(void 0!==t&&(t.DDS=n),"undefined"==typeof glMatrix)throw"You must include glMatrix on your project";Math.clamp=function(t,e,r){return e>t?e:r<t?r:t},vec3.ZERO=vec3.fromValues(0,0,0),vec3.FRONT=vec3.fromValues(0,0,-1),vec3.UP=vec3.fromValues(0,1,0),vec3.RIGHT=vec3.fromValues(1,0,0),vec2.rotate=function(t,e,r){var n=e[0];e=e[1];var a=Math.cos(r);return r=Math.sin(r),t[0]=n*a-e*r,t[1]=n*r+e*a,t},vec3.zero=function(t){return t[0]=t[1]=0,t},vec2.perpdot=function(t,e){return t[1]*e[0]+-t[0]*e[1]},vec2.computeSignedAngle=function(t,e){return Math.atan2(vec2.perpdot(t,e),vec2.dot(t,e))},vec2.random=function(t){return t[0]=Math.random(),t[1]=Math.random(),t},vec3.zero=function(t){return t[0]=t[1]=t[2]=0,t},vec3.minValue=function(t){return t[0]<t[1]&&t[0]<t[2]?t[0]:t[1]<t[2]?t[1]:t[2]},vec3.maxValue=function(t){return t[0]>t[1]&&t[0]>t[2]?t[0]:t[1]>t[2]?t[1]:t[2]},vec3.minValue=function(t){return t[0]<t[1]&&t[0]<t[2]?t[0]:t[1]<t[2]?t[1]:t[2]},vec3.addValue=function(t,e,r){t[0]=e[0]+r,t[1]=e[1]+r,t[2]=e[2]+r},vec3.subValue=function(t,e,r){t[0]=e[0]-r,t[1]=e[1]-r,t[2]=e[2]-r},vec3.toArray=function(t){return[t[0],t[1],t[2]]},vec3.rotateX=function(t,e,r){var n=e[1],a=e[2],i=Math.cos(r);return r=Math.sin(r),t[0]=e[0],t[1]=n*i-a*r,t[2]=n*r+a*i,t},vec3.rotateY=function(t,e,r){var n=e[0],a=e[2],i=Math.cos(r);return r=Math.sin(r),t[0]=n*i-a*r,t[1]=e[1],t[2]=n*r+a*i,t},vec3.rotateZ=function(t,e,r){var n=e[0],a=e[1],i=Math.cos(r);return r=Math.sin(r),t[0]=n*i-a*r,t[1]=n*r+a*i,t[2]=e[2],t},vec3.angle=function(t,e){return Math.acos(vec3.dot(t,e))},vec3.random=function(t){return t[0]=Math.random(),t[1]=Math.random(),t[2]=Math.random(),t},vec3.polarToCartesian=function(t,e){var r=e[0],n=e[1],a=e[2];return t[0]=r*Math.cos(n)*Math.sin(a),t[1]=r*Math.sin(n),t[2]=r*Math.cos(n)*Math.cos(a),t},vec4.random=function(t){return t[0]=Math.random(),t[1]=Math.random(),t[2]=Math.random(),t[3]=Math.random(),t},vec4.toArray=function(t){return[t[0],t[1],t[2],t[3]]},mat3.IDENTITY=mat3.create(),mat4.IDENTITY=mat4.create(),mat4.toArray=function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},mat4.setUpAndOrthonormalize=function(t,e,r){e!=t&&mat4.copy(t,e),e=t.subarray(0,3),vec3.normalize(t.subarray(4,7),r),t=t.subarray(8,11),vec3.cross(e,r,t),vec3.normalize(e,e),vec3.cross(t,e,r),vec3.normalize(t,t)},mat4.multiplyVec3=function(t,e,r){var n=r[0],a=r[1];return r=r[2],t[0]=e[0]*n+e[4]*a+e[8]*r+e[12],t[1]=e[1]*n+e[5]*a+e[9]*r+e[13],t[2]=e[2]*n+e[6]*a+e[10]*r+e[14],t},mat4.projectVec3=function(t,e,r){var n=r[0],a=r[1];r=r[2];var i=e[1]*n+e[5]*a+e[9]*r+e[13],o=e[2]*n+e[6]*a+e[10]*r+e[14],s=e[3]*n+e[7]*a+e[11]*r+e[15];return t[0]=((e[0]*n+e[4]*a+e[8]*r+e[12])/s+1)/2,t[1]=(i/s+1)/2,t[2]=(o/s+1)/2,t},vec3.project=function(t,e,r,n){n=n||gl.viewport_data;var a=e[0],i=e[1];e=e[2];var o=r[3]*a+r[7]*i+r[11]*e+r[15],s=1-((r[1]*a+r[5]*i+r[9]*e+r[13])/o+1)/2;return t[0]=((r[0]*a+r[4]*i+r[8]*e+r[12])/o+1)/2*n[2]+n[0],t[1]=s*n[3]+n[1],t[2]=o,t};var a,i,o,s,u,c=mat4.create(),l=vec4.create();vec3.unproject=function(t,e,r,n){return l[0]=2*(e[0]-n[0])/n[2]-1,l[1]=2*(e[1]-n[1])/n[3]-1,l[2]=2*e[2]-1,l[3]=1,mat4.invert(c,r)?(vec4.transformMat4(l,l,c),0===l[3]?null:(t[0]=l[0]/l[3],t[1]=l[1]/l[3],t[2]=l[2]/l[3],t)):null},mat4.rotateVec3=function(t,e,r){var n=r[0],a=r[1];return r=r[2],t[0]=e[0]*n+e[4]*a+e[8]*r,t[1]=e[1]*n+e[5]*a+e[9]*r,t[2]=e[2]*n+e[6]*a+e[10]*r,t},mat4.fromTranslationFrontTop=function(t,e,r,n){return vec3.cross(t.subarray(0,3),r,n),t.set(n,4),t.set(r,8),t.set(e,12),t},mat4.translationMatrix=function(t){var e=mat4.create();return e[12]=t[0],e[13]=t[1],e[14]=t[2],e},mat4.setTranslation=function(t,e){return t[12]=e[0],t[13]=e[1],t[14]=e[2],t},mat4.getTranslation=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},mat4.toRotationMat4=function(t,e){return mat4.copy(t,e),t[12]=t[13]=t[14]=0,t},mat4.swapRows=function(t,e,r,n){return t!=e?(mat4.copy(t,e),t[4*r]=e[4*n],t[4*r+1]=e[4*n+1],t[4*r+2]=e[4*n+2],t[4*r+3]=e[4*n+3],t[4*n]=e[4*r],t[4*n+1]=e[4*r+1],t[4*n+2]=e[4*r+2],t[4*n+3]=e[4*r+3],t):(e=new Float32Array(matrix.subarray(4*r,5*r)),matrix.set(matrix.subarray(4*n,5*n),4*r),matrix.set(e,4*n),t)},mat4.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t[6]=e[6]+r[6]*n,t[7]=e[7]+r[7]*n,t[8]=e[8]+r[8]*n,t[9]=e[9]+r[9]*n,t[10]=e[10]+r[10]*n,t[11]=e[11]+r[11]*n,t[12]=e[12]+r[12]*n,t[13]=e[13]+r[13]*n,t[14]=e[14]+r[14]*n,t[15]=e[15]+r[15]*n,t},quat.fromAxisAngle=function(t,e){var r=quat.create();e*=.5;var n=Math.sin(e);return r[0]=n*t[0],r[1]=n*t[1],r[2]=n*t[2],r[3]=Math.cos(e),r},quat.toEuler=function(t,e){var r=Math.atan2(2*e[1]*e[3]-2*e[0]*e[2],1-2*e[1]*e[1]-2*e[2]*e[2]),n=Math.asin(2*e[0]*e[1]+2*e[2]*e[3]),a=Math.atan2(2*e[0]*e[3]-2*e[1]*e[2],1-2*e[0]*e[0]-2*e[2]*e[2]);return t||(t=vec3.create()),vec3.set(t,r,n,a),t},quat.fromEuler=function(t,e){var r=e[0],n=e[1],a=e[2],i=Math.cos(r),o=Math.cos(n),s=Math.cos(a),u=(r=Math.sin(r),n=Math.sin(n),a=Math.sin(a),.5*Math.sqrt(1+i*o+i*s-r*n*a+o*s));return 0==u&&(u=1e-6),quat.set(t,(o*a+i*a+r*n*s)/(4*u),(r*o+r*s+i*n*a)/(4*u),(-r*a+i*n*s+n)/(4*u),u),quat.normalize(t,t),t},quat.fromMat4=function(t,e){var r=e[0]+e[5]+e[10];if(0<r){var n=Math.sqrt(r+1);t[3]=.5*n,n=.5/n,t[0]=(e[9]-e[6])*n,t[1]=(e[2]-e[8])*n,t[2]=(e[4]-e[1])*n}else{r=0,e[5]>e[0]&&(r=1),e[10]>e[4*r+r]&&(r=2);var a=(r+1)%3,i=(a+1)%3;n=Math.sqrt(e[4*r+r]-e[4*a+a]-e[4*i+i]+1);t[r]=.5*n,n=.5/n,t[3]=(e[4*i+a]-e[4*a+i])*n,t[a]=(e[4*a+r]+e[4*r+a])*n,t[i]=(e[4*i+r]+e[4*r+i])*n}quat.normalize(t,t)},quat.fromMat4.lookAt=(a=vec3.create(),function(t,e,r){return r=vec3.dot(vec3.FRONT,e),1e-6>Math.abs(r- -1)?(t.set(vec3.UP),t[3]=Math.PI,t):1e-6>Math.abs(r-1)?quat.identity(t):(r=Math.acos(r),vec3.cross(a,vec3.FRONT,e),vec3.normalize(a,a),quat.setAxisAngle(t,a,r),t)}),r.Indexer=function(){this.unique=[],this.indices=[],this.map={}},r.Indexer.prototype={add:function(t){var e=JSON.stringify(t);return e in this.map||(this.map[e]=this.unique.length,this.unique.push(t)),this.map[e]}},r.Buffer=function(e,n,a,i,o){r.debug&&console.log("GL.Buffer created"),null!==o&&(o=o||t.gl),this.buffer=null,this.target=e,this.gl=o,this.data=n,this.spacing=a||3,this.data&&this.gl&&this.upload(i)},r.Buffer.prototype.forEach=function(t){for(var e=this.data,r=0,n=this.spacing,a=e.length;r<a;r+=n)t(e.subarray(r,r+n),r);return this},r.Buffer.prototype.applyTransform=function(t){for(var e=this.data,r=0,n=this.spacing,a=e.length;r<a;r+=n)n=e.subarray(r,r+n),vec3.transformMat4(n,n,t);return this},r.Buffer.prototype.upload=function(t){var e=this.spacing||3,r=this.gl;if(r){if(!this.data)throw"No data supplied";var n=this.data;if(!n.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||r.createBuffer()){switch(this.buffer.length=n.length,this.buffer.spacing=e,n.constructor){case Int8Array:this.buffer.gl_type=r.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=r.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=r.SHORT;break;case Uint16Array:this.buffer.gl_type=r.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=r.INT;break;case Uint32Array:this.buffer.gl_type=r.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=r.FLOAT;break;default:throw"unsupported buffer type"}r.bindBuffer(this.target,this.buffer),r.bufferData(this.target,n,t||this.stream_type||r.STATIC_DRAW)}}},r.Buffer.prototype.compile=r.Buffer.prototype.upload,r.Buffer.prototype.setData=function(t,e){if(!t.buffer)throw"Data must be typed array";if(e=e||0,this.data){if(this.data.length<t.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";if(this.data!=t)if(this.data.length==t.length)this.data.set(t),this.upload();else{var r=new Uint8Array(t.buffer,t.buffer.byteOffset,t.buffer.byteLength);new Uint8Array(this.data.buffer).set(r,e),this.uploadRange(e,r.length)}}else this.data=t,this.upload()},r.Buffer.prototype.uploadRange=function(t,e){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var r=new Uint8Array(this.data.buffer,t,e),n=this.gl;n.bindBuffer(this.target,this.buffer),n.bufferSubData(this.target,t,r)},r.Buffer.prototype.clone=function(e){var n=new r.Buffer;if(e)for(var a in this)n[a]=this[a];else this.target&&(n.target=this.target),this.gl&&(n.gl=this.gl),this.spacing&&(n.spacing=this.spacing),this.data&&(n.data=new t[this.data.constructor](this.data),n.upload());return n},t.Mesh=r.Mesh=function(e,n,a,i){if(r.debug&&console.log("GL.Mesh created"),null!==i&&(this.gl=i=i||t.gl),this._context_id=i.context_id,this.vertexBuffers={},this.indexBuffers={},this.bounding=this.info=null,(e||n)&&this.addBuffers(e,n,a?a.stream_type:null),a)for(var o in a)this[o]=a[o]},Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}},Mesh.default_datatype=Float32Array,Mesh.prototype.addBuffer=function(t,e){e.target==gl.ARRAY_BUFFER?this.vertexBuffers[t]=e:this.indexBuffers[t]=e,e.attribute||(e.attribute=r.Mesh.common_buffers[t].attribute)},Mesh.prototype.addBuffers=function(t,e,n){var a=0;for(var i in this.vertexBuffers.vertices&&(a=this.vertexBuffers.vertices.data.length/3),t){var o=t[i];if(o){if(o.constructor==r.Buffer)o=o.data;else if("number"!=typeof o[0]){for(var s=[],u=0,c=1e4;u<o.length;u+=c)s=Array.prototype.concat.apply(s,o.slice(u,u+c));o=s}s=r.Mesh.common_buffers[i],o.constructor===Array&&(u=r.Mesh.default_datatype,s&&s.type&&(u=s.type),o=new u(o)),"vertices"==i&&(a=o.length/3),u=o.length/a,s&&s.spacing&&(u=s.spacing),c="a_"+i,s&&s.attribute&&(c=s.attribute),this.createVertexBuffer(i,c,u,o,n)}}if(e)for(i in e)if(o=e[i]){if(o.constructor==r.Buffer&&(o=o.data),"number"!=typeof o[0]){for(s=[],i=0,c=1e4;i<o.length;i+=c)s=Array.prototype.concat.apply(s,o.slice(i,i+c));o=s}o.constructor===Array&&(u=Uint16Array,65536<a&&(u=Uint32Array),o=new u(o)),this.createIndexBuffer(i,o)}},Mesh.prototype.createVertexBuffer=function(t,e,n,a,i){var o=r.Mesh.common_buffers[t];if(!e&&o&&(e=o.attribute),!e)throw"Buffer added to mesh without attribute name";if(!n&&o&&(n=o&&o.spacing?o.spacing:3),!a){if(!(a=this.getNumVertices()))throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";a=new r.Mesh.default_datatype(a*n)}if(!a.buffer)throw"Buffer data MUST be typed array";return(n=this.vertexBuffers[t]=new r.Buffer(gl.ARRAY_BUFFER,a,n,i,this.gl)).name=t,n.attribute=e,n},Mesh.prototype.removeVertexBuffer=function(t){this.vertexBuffers[t]&&delete this.vertexBuffers[t]},Mesh.prototype.getVertexBuffer=function(t){return this.vertexBuffers[t]},Mesh.prototype.createIndexBuffer=function(t,e,n){if(e.constructor===Array){var a=Uint16Array,i=this.vertexBuffers.vertices;i&&(65536<i.data.length/3&&(a=Uint32Array),e=new a(e))}return this.indexBuffers[t]=new r.Buffer(gl.ELEMENT_ARRAY_BUFFER,e,0,n,this.gl)},Mesh.prototype.getBuffer=function(t){return this.vertexBuffers[t]},Mesh.prototype.getIndexBuffer=function(t){return this.indexBuffers[t]},Mesh.prototype.upload=function(t){for(var e in this.vertexBuffers){var r=this.vertexBuffers[e];r.upload(t)}for(var n in this.indexBuffers)(r=this.indexBuffers[n]).upload()},Mesh.prototype.compile=Mesh.prototype.upload,Mesh.prototype.deleteBuffers=function(){for(var t in this.vertexBuffers){var e=this.vertexBuffers[t];this.gl.deleteBuffer(e.buffer)}for(t in this.vertexBuffers={},this.indexBuffers)e=this.indexBuffers[t],this.gl.deleteBuffer(e.buffer);this.indexBuffers[t]={}},Mesh.prototype.bindBuffers=function(t){for(var e in this.vertexBuffers){var r=this.vertexBuffers[e],n=t.attributes[r.attribute||e];null!=n&&r.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,r.buffer),gl.enableVertexAttribArray(n),gl.vertexAttribPointer(n,r.buffer.spacing,r.buffer.gl_type,!1,0,0))}},Mesh.prototype.unbindBuffers=function(t){for(var e in this.vertexBuffers){var r=this.vertexBuffers[e],n=r.attribute||e;null!=t.attributes[n]&&r.buffer&&gl.disableVertexAttribArray(t.attributes[n])}},Mesh.prototype.clone=function(e){e=e||t.gl;var n,a={},i={};for(n in this.vertexBuffers){var o=this.vertexBuffers[n];a[n]=new o.data.constructor(o.data)}for(n in this.indexBuffers)o=this.indexBuffers[n],i[n]=new o.data.constructor(o.data);return new r.Mesh(a,i,void 0,e)},Mesh.prototype.cloneShared=function(e){return e=e||t.gl,new r.Mesh(this.vertexBuffers,this.indexBuffers,void 0,e)},Mesh.prototype.toObject=function(){var t,e={},r={};for(t in this.vertexBuffers){var n=this.vertexBuffers[t];e[t]={spacing:n.spacing,data:new n.data.constructor(n.data)}}for(t in this.indexBuffers)n=this.indexBuffers[t],r[t]={data:new n.data.constructor(n.data)};return{vertexBuffers:e,indexBuffers:r}},Mesh.prototype.generateMetadata=function(){var t={},e=this.vertexBuffers.vertices.data,r=this.indexBuffers.triangles.data;t.vertices=e.length/3,t.faces=r?r.length/3:e.length/9,t.indexed=!!this.metadata.faces,this.metadata=t},Mesh.prototype.toJSON=function(){return""},Mesh.prototype.computeWireframe=function(){var t=this.indexBuffers.triangles,e=this.vertexBuffers.vertices.data.length/3;if(t){var n=t.data,a=new r.Indexer;for(t=0;t<n.length;t+=3)for(var i=n.subarray(t,t+3),o=0;o<i.length;o++){var s=i[o],u=i[(o+1)%i.length];a.add([Math.min(s,u),Math.max(s,u)])}for(n=a.unique,a=65536<e?new Uint32Array(2*n.length):new Uint16Array(2*n.length),t=0,e=n.length;t<e;++t)a.set(n[t],2*t)}else for(t=e/3,a=65536<e?new Uint32Array(6*t):new Uint16Array(6*t),t=0;t<e;t+=3)a[2*t]=t,a[2*t+1]=t+1,a[2*t+2]=t+1,a[2*t+3]=t+2,a[2*t+4]=t+2,a[2*t+5]=t;return this.createIndexBuffer("wireframe",a),this},Mesh.prototype.flipNormals=function(t){var e=this.vertexBuffers.normals;if(e){for(var r=e.data,n=r.length,a=0;a<n;++a)r[a]*=-1;for(e.upload(t),this.indexBuffers.triangles&&this.computeIndices(),n=(r=(e=this.indexBuffers.triangles).data).length,a=0;a<n;a+=3){var i=r[a];r[a]=r[a+1],r[a+1]=i}e.upload(t)}},Mesh.prototype.computeIndices=function(){var t=[],e=[],n=[],a=[],i=this.vertexBuffers.normals,o=this.vertexBuffers.coords,s=this.vertexBuffers.vertices.data,u=null;i&&(u=i.data),i=null,o&&(i=o.data);o={};for(var c=s.length/3,l=0;l<c;++l){var f=s.subarray(3*l,3*(l+1)),h=1e3*f[0]|0,d=0,_=o[h];if(_)for(var v=_.length;d<v;d++)if(.01>vec3.sqrDist(f,t[_[d]])){a.push(d);break}_&&d!=v||(t.push(f),o[h]?o[h].push(d):o[h]=[d],u&&e.push(u.subarray(3*l,3*(l+1))),i&&n.push(i.subarray(2*l,2*(l+1))),a.push(d))}this.vertexBuffers={},this.createVertexBuffer("vertices",r.Mesh.common_buffers.vertices.attribute,3,linearizeArray(t)),u&&this.createVertexBuffer("normals",r.Mesh.common_buffers.normals.attribute,3,linearizeArray(e)),i&&this.createVertexBuffer("coords",r.Mesh.common_buffers.coords.attribute,2,linearizeArray(n)),this.createIndexBuffer("triangles",a)},Mesh.prototype.computeNormals=function(t){var e=this.vertexBuffers.vertices.data,n=new Float32Array(e.length),a=null;this.indexBuffers.triangles&&(a=this.indexBuffers.triangles.data);for(var i,o,s,u,c,l,f=r.temp_vec3,h=r.temp2_vec3,d=a?a.length:e.length,_=0;_<d;_+=3)a?(i=a[_],o=a[_+1],s=a[_+2],u=e.subarray(3*i,3*i+3),c=e.subarray(3*o,3*o+3),l=e.subarray(3*s,3*s+3),i=n.subarray(3*i,3*i+3),o=n.subarray(3*o,3*o+3),s=n.subarray(3*s,3*s+3)):(u=e.subarray(3*_,3*_+3),c=e.subarray(3*_+3,3*_+6),l=e.subarray(3*_+6,3*_+9),i=n.subarray(3*_,3*_+3),o=n.subarray(3*_+3,3*_+6),s=n.subarray(3*_+6,3*_+9)),vec3.sub(f,c,u),vec3.sub(h,l,u),vec3.cross(f,f,h),vec3.normalize(f,f),vec3.add(i,i,f),vec3.add(o,o,f),vec3.add(s,s,f);if(a)for(_=0,d=n.length;_<d;_+=3)e=n.subarray(_,_+3),vec3.normalize(e,e);return(d=this.vertexBuffers.normals)?(d.data=n,d.upload(t),d):this.createVertexBuffer("normals",r.Mesh.common_buffers.normals.attribute,3,n)},Mesh.prototype.computeTangents=function(){var t=this.vertexBuffers.vertices.data,e=this.vertexBuffers.normals.data,r=this.vertexBuffers.coords.data,n=this.indexBuffers.triangles.data;if(t&&e&&r){var a,i,o=t.length/3,s=new Float32Array(4*o),u=new Float32Array(6*o),c=(o=u.subarray(3*o),vec3.create()),l=vec3.create(),f=vec3.create(),h=vec3.create();for(a=0,i=n.length;a<i;a+=3){var d=n[a],_=n[a+1],v=n[a+2],p=t.subarray(3*d,3*d+3),m=t.subarray(3*_,3*_+3),g=t.subarray(3*v,3*v+3),E=r.subarray(2*d,2*d+2),x=r.subarray(2*_,2*_+2),T=r.subarray(2*v,2*v+2),b=m[0]-p[0],y=g[0]-p[0],A=m[1]-p[1],w=g[1]-p[1],M=(m=m[2]-p[2],p=g[2]-p[2],g=x[0]-E[0],T[0]-E[0]);x=x[1]-E[1],T=g*(E=T[1]-E[1])-M*x,T=1e-9>Math.abs(T)?0:1/T;vec3.copy(c,[(E*b-x*y)*T,(E*A-x*w)*T,(E*m-x*p)*T]),vec3.copy(l,[(g*y-M*b)*T,(g*w-M*A)*T,(g*p-M*m)*T]),vec3.add(u.subarray(3*d,3*d+3),u.subarray(3*d,3*d+3),c),vec3.add(u.subarray(3*_,3*_+3),u.subarray(3*_,3*_+3),c),vec3.add(u.subarray(3*v,3*v+3),u.subarray(3*v,3*v+3),c),vec3.add(o.subarray(3*d,3*d+3),o.subarray(3*d,3*d+3),l),vec3.add(o.subarray(3*_,3*_+3),o.subarray(3*_,3*_+3),l),vec3.add(o.subarray(3*v,3*v+3),o.subarray(3*v,3*v+3),l)}for(a=0,i=t.length;a<i;a+=3)t=e.subarray(a,a+3),r=u.subarray(a,a+3),vec3.subtract(f,r,vec3.scale(f,t,vec3.dot(t,r))),vec3.normalize(f,f),t=0>vec3.dot(vec3.cross(h,t,r),o.subarray(a,a+3))?-1:1,s.set([f[0],f[1],f[2],t],a/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,s)}},Mesh.prototype.getNumVertices=function(){var t=this.vertexBuffers.vertices;return t?t.data.length/t.spacing:0},Mesh.computeBounding=function(t,e){if(t){for(var r,n=vec3.clone(t.subarray(0,3)),a=vec3.clone(t.subarray(0,3)),i=3;i<t.length;i+=3)r=t.subarray(i,i+3),vec3.min(n,r,n),vec3.max(a,r,a);return(isNaN(n[0])||isNaN(n[1])||isNaN(n[2])||isNaN(a[0])||isNaN(a[1])||isNaN(a[2]))&&(n[0]=n[1]=n[2]=0,a[0]=a[1]=a[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices")),n=vec3.add(vec3.create(),n,a),vec3.scale(n,n,.5),a=vec3.subtract(vec3.create(),a,n),BBox.setCenterHalfsize(e||BBox.create(),n,a)}},Mesh.prototype.getBoundingBox=function(){return this.bounding||this.updateBounding(),this.bounding},Mesh.prototype.updateBounding=function(){var t=this.vertexBuffers.vertices.data;t&&(this.bounding=r.Mesh.computeBounding(t,this.bounding))},Mesh.prototype.setBounding=function(t,e){this.bounding=BBox.setCenterHalfsize(this.bounding||BBox.create(),t,e)},Mesh.prototype.freeData=function(){for(var t in this.vertexBuffers)this.vertexBuffers[t].data=null,delete this[this.vertexBuffers[t].name];for(var e in this.indexBuffers)this.indexBuffers[e].data=null,delete this[this.indexBuffers[e].name]},Mesh.prototype.configure=function(t,e){var n={},a={};for(var i in e=e||{},t)t[i]&&("indices"==i||"lines"==i||"wireframe"==i||"triangles"==i?a[i]=t[i]:r.Mesh.common_buffers[i]?n[i]=t[i]:e[i]=t[i]);for(a in this.addBuffers(n,a,e.stream_type),e)this[a]=e[a]},Mesh.prototype.totalMemory=function(){var t,e=0;for(t in this.vertexBuffers)e+=this.vertexBuffers[t].data.buffer.byteLength;for(t in this.indexBuffers)e+=this.indexBuffers[t].data.buffer.byteLength;return e},Mesh.prototype.simplify=function(){var t,e=this.getBoundingBox(),n=BBox.getMin(e),a=(e=BBox.getHalfsize(e),e=vec3.scale(vec3.create(),e,2),new r.Mesh),i=vec3.create();for(t in this.vertexBuffers){var o=this.vertexBuffers[t].data,s=new Float32Array(o.length);if("vertices"==t)for(var u=0,c=o.length;u<c;u+=3){var l=o.subarray(u,u+3);vec3.sub(i,l,n),vec3.div(i,i,e),i[0]=Math.round(256*i[0])/256,i[1]=Math.round(256*i[1])/256,i[2]=Math.round(256*i[2])/256,vec3.mul(i,i,e),vec3.add(i,i,n),s.set(i,u)}a.addBuffer()}},Mesh.load=function(t,e,n,a){return(e=e||{}).no_gl&&(a=null),(n=n||new r.Mesh(null,null,null,a)).configure(t,e),n},Mesh.mergeMeshes=function(t,e){function n(t,e,r,n){for(r=e+r;e<r;e+=3){var a=t.subarray(e,e+3);vec3.transformMat4(a,a,n)}}function a(t,e,r,n){for(r=e+r;e<r;e+=2){var a=t.subarray(e,e+2);vec2.transformMat3(a,a,n)}}function i(t,e,r,n){for(r=e+r;e<r;++e)t[e]+=n}e=e||{};for(var o={},s={},u={},c=[],l=0,f=[],h=0;h<t.length;++h){var d=t[h],_=d.mesh,v=l;c.push(v);var p,m=_.vertexBuffers.vertices.data.length/3;l=l+m;for(p in _.vertexBuffers)o[p]=o[p]?o[p]+_.vertexBuffers[p].data.length:_.vertexBuffers[p].data.length;for(p in _.indexBuffers)s[p]=s[p]?s[p]+_.indexBuffers[p].data.length:_.indexBuffers[p].data.length;f.push({name:"mesh_"+h,start:v,length:m,material:""})}for(p in o)null===(h=e[p])?delete o[p]:(h||(h=Float32Array),o[p]=new h(o[p]),u[p]=0);for(p in s)s[p]=new Uint32Array(s[p]),u[p]=0;for(h=0;h<t.length;++h){for(p in m=v=0,(_=(d=t[h]).mesh).vertexBuffers)o[p]&&("vertices"==p&&(m=_.vertexBuffers[p].data.length/3),o[p].set(_.vertexBuffers[p].data,u[p]),d[p+"_matrix"]&&(16==(l=d[p+"_matrix"]).length?n(o[p],u[p],_.vertexBuffers[p].data.length,l):9==l.length&&a(o[p],u[p],_.vertexBuffers[p].data.length,l)),u[p]+=_.vertexBuffers[p].data.length);for(p in _.indexBuffers)s[p].set(_.indexBuffers[p].data,u[p]),i(s[p],u[p],_.indexBuffers[p].data.length,c[h]),u[p]+=_.indexBuffers[p].data.length}return u={info:{groups:f}},"undefined"!=typeof gl?new r.Mesh(o,s,u):{vertexBuffers:o,indexBuffers:s,info:{groups:f}}},Mesh.parsers={},Mesh.encoders={},Mesh.fromURL=function(e,n,a,i){i=i||{},a=a||t.gl;var o=new r.Mesh(void 0,void 0,void 0,a);return o.ready=!1,HttpRequest(e,null,(function(t){var r=e.lastIndexOf(".");r=e.substr(r+1);o.parse(t,r),delete o.ready,n&&n.call(o,o,e)}),(function(t){n&&n(null)}),i),o},Mesh.prototype.parse=function(t,e){e=e.toLowerCase();var n=r.Mesh.parsers[e];if(n)return n.call(null,t,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+e},Mesh.prototype.encode=function(t,e){t=t.toLowerCase();var n=r.Mesh.encoders[t];if(n)return n.call(null,this,e);throw"GL.Mesh.encode: no encoder found for format "+t},Mesh.getScreenQuad=function(e){if(n=(e=e||t.gl).meshes[":screen_quad"])return n;var n=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);n=new r.Mesh({vertices:n,coords:a},void 0,void 0,e);return e.meshes[":screen_quad"]=n},Mesh.plane=function(t,e){(t=t||{}).triangles=[];var n=t.detailX||t.detail||1,a=t.detailY||t.detail||1,i=t.width||t.size||1,o=t.height||t.size||1,s=t.xz,u=(i=.5*i,o=.5*o,[]),c=[],l=[],f=[],h=vec3.fromValues(0,0,1);s&&h.set([0,1,0]);for(var d=0;d<=a;d++)for(var _=d/a,v=0;v<=n;v++){var p=v/n;s?c.push((2*p-1)*i,0,-(2*_-1)*o):c.push((2*p-1)*i,(2*_-1)*o,0),l&&l.push(p,_),f&&f.push(h[0],h[1],h[2]),v<n&&d<a&&(p=v+d*(n+1),s?(u.push(p+1,p+n+1,p),u.push(p+1,p+n+2,p+n+1)):(u.push(p,p+1,p+n+1),u.push(p+n+1,p+1,p+n+2)))}return n=BBox.fromCenterHalfsize([0,0,0],s?[i,0,o]:[i,o,0]),r.Mesh.load({vertices:c,normals:f,coords:l,triangles:u},{bounding:n},e)},Mesh.plane2D=function(t,e){var n=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),a=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(t&&t.size)for(var i=.5*t.size,o=0;o<n.length;++o)n[o]*=i;return new r.Mesh({vertices2D:n,coords:a},null,e)},Mesh.point=function(t){return new r.Mesh({vertices:[0,0,0]})},Mesh.cube=function(t,e){var n=.5*((t=t||{}).size||1),a={};a.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var i=0,o=a.vertices.length;i<o;++i)a.vertices[i]*=n;return a.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),a.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),t.wireframe&&(a.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),t.bounding=BBox.fromCenterHalfsize([0,0,0],[n,n,n]),r.Mesh.load(a,t,e)},Mesh.box=function(t,e){var n=.5*(n=(t=t||{}).sizex||1),a=.5*(a=t.sizey||1),i=.5*(i=t.sizez||1),o={};o.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var s=0,u=o.vertices.length;s<u;s+=3)o.vertices[s]*=n,o.vertices[s+1]*=a,o.vertices[s+2]*=i;return o.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),o.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),t.wireframe&&(o.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),t.bounding=BBox.fromCenterHalfsize([0,0,0],[n,a,i]),r.Mesh.load(o,t,e)},Mesh.circle=function(t,e){var n=(t=t||{}).size||t.radius||1,a=Math.ceil(t.slices||24),i=t.xz||!1,o=t.empty||!1;3>a&&(a=3);var s=2*Math.PI/a,u=vec3.create(),c=vec3.create(),l=vec3.fromValues(0,0,1),f=vec2.fromValues(.5,.5),h=vec2.create();i&&l.set([0,1,0]);var d=i?2:1,_=new Float32Array(3*(a+1)),v=new Float32Array(3*(a+1)),p=new Float32Array(2*(a+1)),m=null;for(_.set(u,0),v.set(l,0),p.set(f,0),u=f=m=0;u<a;++u)m=Math.sin(s*u),f=Math.cos(s*u),c[0]=m*n,c[d]=f*n,h[0]=.5*m+.5,h[1]=.5*f+.5,_.set(c,3*u+3),v.set(l,3*u+3),p.set(h,2*u+2);if(o)v=(_=_.subarray(3)).subarray(3),p=_.subarray(2),m=null;else{for(m=new Uint16Array(3*a),o=2,s=1,i&&(o=1,s=2),u=0;u<a-1;++u)m[3*u]=0,m[3*u+1]=u+o,m[3*u+2]=u+s;m[3*u]=0,i?(m[3*u+1]=u+1,m[3*u+2]=1):(m[3*u+1]=1,m[3*u+2]=u+1)}if(t.bounding=BBox.fromCenterHalfsize([0,0,0],i?[n,0,n]:[n,n,0]),n={vertices:_,normals:v,coords:p,triangles:m},t.wireframe){for(i=new Uint16Array(2*a),u=0;u<a;u++)i[2*u]=u,i[2*u+1]=u+1;i[0]=a,n.wireframe=i}return r.Mesh.load(n,t,e)},Mesh.cylinder=function(t,e){for(var r=(t=t||{}).radius||t.size||1,n=t.height||t.size||2,a=t.subdivisions||64,i=new Float32Array(36*a),o=new Float32Array(36*a),s=new Float32Array(24*a),u=2*Math.PI/a,c=null,l=0;l<a;++l){var f=l*u;c=[Math.sin(f),0,Math.cos(f)];i.set([c[0]*r,.5*n,c[2]*r],18*l),o.set(c,18*l),s.set([l/a,1],12*l),c=[Math.sin(f),0,Math.cos(f)],i.set([c[0]*r,-.5*n,c[2]*r],18*l+3),o.set(c,18*l+3),s.set([l/a,0],12*l+2),c=[Math.sin(f+u),0,Math.cos(f+u)],i.set([c[0]*r,-.5*n,c[2]*r],18*l+6),o.set(c,18*l+6),s.set([(l+1)/a,0],12*l+4),c=[Math.sin(f+u),0,Math.cos(f+u)],i.set([c[0]*r,.5*n,c[2]*r],18*l+9),o.set(c,18*l+9),s.set([(l+1)/a,1],12*l+6),c=[Math.sin(f),0,Math.cos(f)],i.set([c[0]*r,.5*n,c[2]*r],18*l+12),o.set(c,18*l+12),s.set([l/a,1],12*l+8),c=[Math.sin(f+u),0,Math.cos(f+u)],i.set([c[0]*r,-.5*n,c[2]*r],18*l+15),o.set(c,18*l+15),s.set([(l+1)/a,0],12*l+10)}c=18*l;var h=12*l;if(!1===t.caps)i=i.subarray(0,c),o=o.subarray(0,c),s=s.subarray(0,h);else{var d=vec3.fromValues(0,.5*n,0),_=vec3.fromValues(0,-.5*n,0),v=vec3.fromValues(0,1,0),p=vec3.fromValues(0,-1,0);for(l=0;l<a;++l){f=l*u;var m=vec3.fromValues(Math.sin(f),0,Math.cos(f));f=vec3.fromValues(Math.sin(f+u),0,Math.cos(f+u));i.set([m[0]*r,.5*n,m[2]*r],c+18*l),o.set(v,c+18*l),s.set([.5*-m[0]+.5,.5*m[2]+.5],h+12*l),i.set([f[0]*r,.5*n,f[2]*r],c+18*l+3),o.set(v,c+18*l+3),s.set([.5*-f[0]+.5,.5*f[2]+.5],h+12*l+2),i.set(d,c+18*l+6),o.set(v,c+18*l+6),s.set([.5,.5],h+12*l+4),i.set([f[0]*r,-.5*n,f[2]*r],c+18*l+9),o.set(p,c+18*l+9),s.set([.5*f[0]+.5,.5*f[2]+.5],h+12*l+6),i.set([m[0]*r,-.5*n,m[2]*r],c+18*l+12),o.set(p,c+18*l+12),s.set([.5*m[0]+.5,.5*m[2]+.5],h+12*l+8),i.set(_,c+18*l+15),o.set(p,c+18*l+15),s.set([.5,.5],h+12*l+10)}}return a={vertices:i,normals:o,coords:s},t.bounding=BBox.fromCenterHalfsize([0,0,0],[r,.5*n,r]),Mesh.load(a,t,e)},Mesh.sphere=function(t,e){for(var n=(t=t||{}).radius||t.size||1,a=t.lat||t.subdivisions||16,i=t.long||t.subdivisions||16,o=new Float32Array((a+1)*(i+1)*3),s=new Float32Array((a+1)*(i+1)*3),u=new Float32Array((a+1)*(i+1)*2),c=new Uint16Array(a*i*6),l=t.hemi?.5*Math.PI:Math.PI,f=0,h=0,d=0;d<=a;d++){var _=d*l/a,v=Math.sin(_),p=Math.cos(_);for(_=0;_<=i;_++){var m=2*_*Math.PI/i,g=Math.sin(m),E=(m=Math.cos(m)*v,p),x=(g=g*v,1-_/i),T=1-d/a;o.set([n*m,n*E,n*g],f),s.set([m,E,g],f),u.set([x,T],h),f+=3,h+=2}}for(d=f=0;d<a;d++)for(_=0;_<i;_++)h=(l=d*(i+1)+_)+i+1,c.set([h,l,l+1],f),c.set([h+1,h,l+1],f+3),f+=6;if(o={vertices:o,normals:s,coords:u,triangles:c},t.wireframe){for(s=new Uint16Array(i*a*4),f=u=0;f<a;f++){for(c=0;c<i;c++)s[u]=f*(i+1)+c,s[u+1]=f*(i+1)+c+1,u+=2;s[u-2*i]=f*(i+1)+c}for(f=0;f<i;f++)for(c=0;c<a;c++)s[u]=c*(i+1)+f,s[u+1]=(c+1)*(i+1)+f,u+=2;o.wireframe=s}return t.bounding=t.hemi?BBox.fromCenterHalfsize([0,.5*n,0],[n,.5*n,n],n):BBox.fromCenterHalfsize([0,0,0],[n,n,n],n),r.Mesh.load(o,t,e)},Mesh.grid=function(t,e){var n=(t=t||{}).lines||11;0>n&&(n=1);for(var a=t.size||10,i=new Float32Array(12*n),o=.5*a,s=0,u=-o,c=(a=a/(n-1),0);c<n;c++)i[s]=u,i[s+2]=-o,i[s+3]=u,i[s+5]=o,i[s+6]=o,i[s+8]=u,i[s+9]=-o,i[s+11]=u,u+=a,s+=12;return new r.Mesh({vertices:i},t,e)},Mesh.icosahedron=function(t,e){function n(t,e){var r=c[t]<c[e]?c[t]+":"+c[e]:c[e]+":"+c[t],n=p[r];if(n)return n;n=o.length/3,o.push(.5*(o[3*c[t]]+o[3*c[e]]),.5*(o[3*c[t]+1]+o[3*c[e]+1]),.5*(o[3*c[t]+2]+o[3*c[e]+2]));var i=Math.sqrt(o[3*n]*o[3*n]+o[3*n+1]*o[3*n+1]+o[3*n+2]*o[3*n+2]),l=o[3*n]/i,f=o[3*n+1]/i,h=o[3*n+2]/i;return s.push(l,f,h),u.push(Math.atan2(l,h)/Math.PI*.5,Math.acos(f)/Math.PI),o[3*n]*=a/i,o[3*n+1]*=a/i,o[3*n+2]*=a/i,p[r]=n}var a=(t=t||{}).radius||t.size||1,i=void 0===t.subdivisions?0:t.subdivisions;6<i&&(i=6);for(var o=[-1,l=(1+Math.sqrt(5))/2,0,1,l,0,-1,-l,0,1,-l,0,0,-1,l,0,1,l,0,-1,-l,0,1,-l,l,0,-1,l,0,1,-l,0,-1,-l,0,1],s=[],u=[],c=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],l=o.length,f=0;f<l;f+=3){var h=Math.sqrt(o[f]*o[f]+o[f+1]*o[f+1]+o[f+2]*o[f+2]),d=o[f]/h,_=o[f+1]/h,v=o[f+2]/h;s.push(d,_,v),u.push(Math.atan2(d,v),Math.acos(_)),o[f]*=a/h,o[f+1]*=a/h,o[f+2]*=a/h}var p={};for(h=0;h<i;++h){for(d=[],l=c.length,f=0;f<l;f+=3){_=n(f,f+1),v=n(f+1,f+2);var m=n(f+2,f);d.push(c[f],_,m),d.push(c[f+1],v,_),d.push(c[f+2],m,v),d.push(_,v,m)}c=d}return t.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,a],a),new r.Mesh.load({vertices:o,coords:u,normals:s,triangles:c},t,e)},t.Texture=r.Texture=function e(n,a,i,o){if(i=i||{},this.gl=o=o||t.gl,this._context_id=o.context_id,n=parseInt(n),a=parseInt(a),r.debug&&console.log("GL.Texture created: ",n,a),this.handler=o.createTexture(),this.width=n,this.height=a,this.texture_type=i.texture_type||o.TEXTURE_2D,this.format=i.format||e.DEFAULT_FORMAT,this.type=i.type||e.DEFAULT_TYPE,this.magFilter=i.magFilter||i.filter||e.DEFAULT_MAG_FILTER,this.minFilter=i.minFilter||i.filter||e.DEFAULT_MIN_FILTER,this.wrapS=i.wrap||i.wrapS||e.DEFAULT_WRAP_S,this.wrapT=i.wrap||i.wrapT||e.DEFAULT_WRAP_T,this.data=null,e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=o.getParameter(o.MAX_TEXTURE_IMAGE_UNITS)),this.has_mipmaps=!1,this.format==o.DEPTH_COMPONENT&&!o.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==o.FLOAT&&!o.extensions.OES_texture_float)throw"Float Texture not supported";if(this.type==o.HALF_FLOAT_OES&&!o.extensions.OES_texture_half_float)throw"Half Float Texture not supported";if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==o.NEAREST||this.minFilter==o.LINEAR)&&this.wrapS==o.CLAMP_TO_EDGE&&this.wrapT==o.CLAMP_TO_EDGE)){if(!i.ignore_pot)throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";this.minFilter=this.magFilter=o.LINEAR,this.wrapS=this.wrapT=o.CLAMP_TO_EDGE}if(n&&a){o.activeTexture(o.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1),o.bindTexture(this.texture_type,this.handler),o.texParameteri(this.texture_type,o.TEXTURE_MAG_FILTER,this.magFilter),o.texParameteri(this.texture_type,o.TEXTURE_MIN_FILTER,this.minFilter),o.texParameteri(this.texture_type,o.TEXTURE_WRAP_S,this.wrapS),o.texParameteri(this.texture_type,o.TEXTURE_WRAP_T,this.wrapT),i.anisotropic&&o.extensions.EXT_texture_filter_anisotropic&&o.texParameterf(o.TEXTURE_2D,o.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,i.anisotropic);var s=i.pixel_data;s&&!s.buffer&&(this.data=s=new(this.type==o.FLOAT?Float32Array:Uint8Array)(s)),this.texture_type==o.TEXTURE_2D?(o.texImage2D(o.TEXTURE_2D,0,this.format,n,a,0,this.format,this.type,s||null),r.isPowerOfTwo(n)&&r.isPowerOfTwo(a)&&i.minFilter&&i.minFilter!=o.NEAREST&&i.minFilter!=o.LINEAR&&(o.generateMipmap(this.texture_type),this.has_mipmaps=!0)):this.texture_type==o.TEXTURE_CUBE_MAP&&(o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,s||null),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,s||null),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,s||null),o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,s||null),o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,s||null),o.texImage2D(o.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,s||null)),o.bindTexture(this.texture_type,null),o.activeTexture(o.TEXTURE0)}},Texture.DEFAULT_TYPE=r.UNSIGNED_BYTE,Texture.DEFAULT_FORMAT=r.RGBA,Texture.DEFAULT_MAG_FILTER=r.LINEAR,Texture.DEFAULT_MIN_FILTER=r.LINEAR,Texture.DEFAULT_WRAP_S=r.CLAMP_TO_EDGE,Texture.DEFAULT_WRAP_T=r.CLAMP_TO_EDGE,Texture.framebuffer=null,Texture.renderbuffer=null,Texture.loading_color=new Uint8Array([0,0,0,0]),Texture.use_renderbuffer_pool=!0,Texture.prototype.delete=function(){gl.deleteBuffer(this.handler),this.handler=null},Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}},Texture.prototype.toJSON=function(){return""},Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture},Texture.prototype.bind=function(t){null==t&&(t=0);var e=this.gl;return e.activeTexture(e.TEXTURE0+t),e.bindTexture(this.texture_type,this.handler),t},Texture.prototype.unbind=function(t){void 0===t&&(t=0);var e=this.gl;e.activeTexture(e.TEXTURE0+t),e.bindTexture(this.texture_type,null)},Texture.prototype.setParameter=function(t,e){switch(this.bind(0),this.gl.texParameteri(this.texture_type,t,e),t){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=e;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=e;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=e;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=e}},Texture.setUploadOptions=function(e,r){r=r||t.gl,e?(r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0)),r.pixelStorei(r.UNPACK_ALIGNMENT,1)},Texture.prototype.uploadImage=function(t,e){this.bind();var r=this.gl;Texture.setUploadOptions(e,r);try{r.texImage2D(r.TEXTURE_2D,0,this.format,this.format,this.type,t),this.width=t.videoWidth||t.width,this.height=t.videoHeight||t.height,this.data=t}catch(t){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}this.minFilter&&this.minFilter!=r.NEAREST&&this.minFilter!=r.LINEAR&&(r.generateMipmap(this.texture_type),this.has_mipmaps=!0),r.bindTexture(this.texture_type,null)},Texture.prototype.uploadData=function(t,e){var r=this.gl;this.bind(),Texture.setUploadOptions(e,r),r.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,t),this.data=t,this.minFilter&&this.minFilter!=r.NEAREST&&this.minFilter!=r.LINEAR&&(r.generateMipmap(texture.texture_type),this.has_mipmaps=!0),r.bindTexture(this.texture_type,null)},Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}],Texture.prototype.drawTo=function(t,e){var n=this.gl,a=n.getViewport(),i=r.getTime(),o=n.getParameter(n.FRAMEBUFFER_BINDING),s=n._framebuffer=n._framebuffer||n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,s);var u=null;if(Texture.use_renderbuffer_pool){n._renderbuffers_pool||(n._renderbuffers_pool={});var c=this.width+":"+this.height;n._renderbuffers_pool[c]?((u=n._renderbuffers_pool[c]).time=i,n.bindRenderbuffer(n.RENDERBUFFER,u)):(n._renderbuffers_pool[c]=u=n.createRenderbuffer(),u.time=i,u.width=this.width,u.height=this.height,n.bindRenderbuffer(n.RENDERBUFFER,u),setTimeout(function t(){6e4<=r.getTime()-this.time?(console.log("Buffer cleared"),n.deleteRenderbuffer(n._renderbuffers_pool[c]),delete n._renderbuffers_pool[c]):setTimeout(t.bind(this),6e4)}.bind(u),6e4))}else(u=n._renderbuffer=n._renderbuffer||n.createRenderbuffer()).width=this.width,u.height=this.height,n.bindRenderbuffer(n.RENDERBUFFER,u);if(this.format===n.DEPTH_COMPONENT?n.renderbufferStorage(n.RENDERBUFFER,n.RGBA4,this.width,this.height):n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,this.width,this.height),n.viewport(0,0,this.width,this.height),n._current_texture_drawto=this,n._current_fbo_color=s,n._current_fbo_depth=u,this.texture_type==n.TEXTURE_2D)this.format!==n.DEPTH_COMPONENT?(n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.handler,0),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,u)):(n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.RENDERBUFFER,u),n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_2D,this.handler,0)),t(this,e);else if(this.texture_type==n.TEXTURE_CUBE_MAP)for(this.format!==n.DEPTH_COMPONENT?n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,u):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.RENDERBUFFER,u),i=0;6>i;i++)this.format!==n.DEPTH_COMPONENT?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+i,this.handler,0):n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_CUBE_MAP_POSITIVE_X+i,this.handler,0),t(this,i,e);return this.data=null,n._current_texture_drawto=null,n._current_fbo_color=null,n._current_fbo_depth=null,n.bindFramebuffer(n.FRAMEBUFFER,o),n.bindRenderbuffer(n.RENDERBUFFER,null),n.viewport(a[0],a[1],a[2],a[3]),this},Texture.drawTo=function(t,e,r){var n=-1,a=-1,i=null;if(!t&&!r)throw"Textures missing in drawTo";if(t&&t.length)for(var o=0;o<t.length;o++){var s=t[o];if(-1==n)n=s.width;else if(n!=s.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(-1==a)a=s.height;else if(a!=s.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==i)i=s.type;else if(i!=s.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type"}else n=r.width,a=r.height;var u=gl.extensions.WEBGL_draw_buffers;if(!u&&t&&1<t.length)throw"Rendering to several textures not supported";if(i=gl.getViewport(),gl._framebuffer=gl._framebuffer||gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer),gl.viewport(0,0,n,a),o=null,r&&r.format!==gl.DEPTH_COMPONENT||r.type!=gl.UNSIGNED_INT)throw"Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";if(r?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,r.handler,0):((o=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer()).width=n,o.height=a,gl.bindRenderbuffer(gl.RENDERBUFFER,o),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,n,a),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,o)),t){for(n=[],o=0;o<t.length;o++)s=t[o],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+o,gl.TEXTURE_2D,s.handler,0),n.push(gl.COLOR_ATTACHMENT0+o);1<t.length&&u.drawBuffersWEBGL(n)}else(r=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer()).width=n,r.height=a,gl.bindRenderbuffer(gl.RENDERBUFFER,r),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,n,a),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,r);if((n=gl.checkFramebufferStatus(gl.FRAMEBUFFER))!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+n;if(e(),t.length)for(o=0;o<t.length;++o)t[o].data=null;gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(i[0],i[1],i[2],i[3])},Texture.drawToColorAndDepth=function(t,e,r){var n=t.gl;if(e.width!=t.width||e.height!=t.height)throw"Different size between color texture and depth texture";var a=n.getViewport();n._framebuffer=n._framebuffer||n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,n._framebuffer),n.viewport(0,0,t.width,t.height),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t.handler,0),n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_2D,e.handler,0),r(),t.data=null,e.data=null,n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(a[0],a[1],a[2],a[3])},Texture.prototype.copyTo=function(t,e,n){var a=this.gl,i=a.getParameter(a.FRAMEBUFFER_BINDING),o=a.getViewport();if(e||(e=this.texture_type==a.TEXTURE_2D?r.Shader.getScreenShader():r.Shader.getCubemapCopyShader()),a.disable(a.BLEND),a.disable(a.DEPTH_TEST),e&&n&&e.uniforms(n),(n=a.__copy_fbo)||(n=a.__copy_fbo=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,n),a.viewport(0,0,t.width,t.height),this.texture_type==a.TEXTURE_2D)a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t.handler,0),this.toViewport(e);else if(this.texture_type==a.TEXTURE_CUBE_MAP){e.uniforms({u_texture:0}),n=r.temp_mat3;for(var s=0;6>s;s++){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+s,t.handler,0);var u=r.Texture.cubemap_camera_parameters[s];mat3.identity(n),n.set(u.right,0),n.set(u.up,3),n.set(u.dir,6),this.toViewport(e,{u_rotation:n})}}return a.setViewport(o),a.bindFramebuffer(a.FRAMEBUFFER,i),t.minFilter&&t.minFilter!=a.NEAREST&&t.minFilter!=a.LINEAR&&(t.bind(),a.generateMipmap(t.texture_type),t.has_mipmaps=!0),t.data=null,a.bindTexture(t.texture_type,null),this},Texture.prototype.toViewport=function(t,e){t=t||Shader.getScreenShader();var r=Mesh.getScreenQuad();this.bind(0),e&&t.uniforms(e),t.draw(r,gl.TRIANGLES)},Texture.prototype.fill=function(t){var e=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(t[0],t[1],t[2],t[3]),this.drawTo((function(){gl.clear(gl.COLOR_BUFFER_BIT)})),gl.clearColor(e[0],e[1],e[2],e[3])},Texture.prototype.renderQuad=(i=mat3.create(),o=vec2.create(),s=vec2.create(),u=vec4.fromValues(1,1,1,1),function(t,e,r,n,a,c){o[0]=t,o[1]=e,s[0]=r,s[1]=n,a=a||Shader.getQuadShader(this.gl),t=Mesh.getScreenQuad(this.gl),this.bind(0),a.uniforms({u_texture:0,u_position:o,u_color:u,u_size:s,u_viewport:gl.viewport_data.subarray(2,4),u_transform:i}),c&&a.uniforms(c),a.draw(t,gl.TRIANGLES)}),Texture.prototype.applyBlur=function(t,e,n,a,i){var o=this.gl;if(void 0===t&&(t=1),void 0===e&&(e=1),t/=this.width,e/=this.height,o.disable(o.DEPTH_TEST),o.disable(o.BLEND),this===i&&this.texture_type===o.TEXTURE_CUBE_MAP)throw"cannot use applyBlur in a texture with itself when blurring a CUBE_MAP";if(i&&this.texture_type!==i.texture_type)throw"cannot use applyBlur with textures of different texture_type";var s=null,u=o.getParameter(o.FRAMEBUFFER_BINDING),c=o.getViewport(),l=o.__copy_fbo;if(l||(l=o.__copy_fbo=o.createFramebuffer()),o.bindFramebuffer(o.FRAMEBUFFER,l),o.viewport(0,0,this.width,this.height),this.texture_type===o.TEXTURE_2D)s=r.Shader.getBlurShader(),a||(a=new r.Texture(this.width,this.height,this.getProperties())),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a.handler,0),this.toViewport(s,{u_texture:0,u_intensity:n,u_offset:[0,e]}),i=i||this,o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,i.handler,0),a.toViewport(s,{u_intensity:n,u_offset:[t,0]}),s=a;else if(this.texture_type===o.TEXTURE_CUBE_MAP){for((s=r.Shader.getCubemapBlurShader()).uniforms({u_texture:0,u_intensity:n,u_offset:[t,e]}),this.bind(0),(t=Mesh.getScreenQuad()).bindBuffers(s),s.bind(),i||(i=new r.Texture(this.width,this.height,this.getProperties())),e=r.temp_mat3,n=0;6>n;++n)o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+n,i.handler,0),a=r.Texture.cubemap_camera_parameters[n],mat3.identity(e),e.set(a.right,0),e.set(a.up,3),e.set(a.dir,6),s._setUniform("u_rotation",e),o.drawArrays(o.TRIANGLES,0,6);t.unbindBuffers(s),s=i}return o.setViewport(c),o.bindFramebuffer(o.FRAMEBUFFER,u),i.data=null,i.minFilter&&i.minFilter!=o.NEAREST&&i.minFilter!=o.LINEAR&&(i.bind(),o.generateMipmap(i.texture_type),i.has_mipmaps=!0),o.bindTexture(i.texture_type,null),s},Texture.fromURL=function(e,a,i,o){o=o||t.gl,a=a||{};var s=(a=Object.create(a)).texture||new r.Texture(1,1,a,o);64>e.length&&(s.url=e),s.bind();var u=a.temp_color||Texture.loading_color;if(o.pixelStorei(o.UNPACK_ALIGNMENT,4),u=a.type==o.FLOAT?new Float32Array(u):new Uint8Array(u),o.texImage2D(o.TEXTURE_2D,0,s.format,s.width,s.height,0,s.format,s.type,u),o.bindTexture(s.texture_type,null),s.ready=!1,-1!=e.toLowerCase().indexOf(".dds")){u=o.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||o.getExtension("WEBGL_compressed_texture_s3tc");var c=new r.Texture(0,0,a,o);n.loadDDSTextureEx(o,u,e,c.handler,!0,(function(t){s.texture_type=t.texture_type,s.handler=t,delete s.ready,i&&i(s,e)}))}else(o=new Image).src=e,o.onload=function(){a.texture=s,r.Texture.fromImage(this,a),delete s.ready,i&&i(s,e)},o.onerror=function(){i&&i(null)};return s},Texture.fromImage=function(t,e){var n=(e=e||{}).texture||new r.Texture(t.width,t.height,e);return n.uploadImage(t,e),n.bind(),gl.texParameteri(n.texture_type,gl.TEXTURE_MAG_FILTER,n.magFilter),gl.texParameteri(n.texture_type,gl.TEXTURE_MIN_FILTER,n.minFilter),gl.texParameteri(n.texture_type,gl.TEXTURE_WRAP_S,n.wrapS),gl.texParameteri(n.texture_type,gl.TEXTURE_WRAP_T,n.wrapT),r.isPowerOfTwo(n.width)&&r.isPowerOfTwo(n.height)&&e.minFilter&&e.minFilter!=gl.NEAREST&&e.minFilter!=gl.LINEAR&&(n.bind(),gl.generateMipmap(n.texture_type),n.has_mipmaps=!0),gl.bindTexture(n.texture_type,null),n.data=t,e.keep_image&&(n.img=t),n},Texture.fromVideo=function(t,e){var n=(e=e||{}).texture||new r.Texture(t.videoWidth,t.videoHeight,e);return n.bind(),n.uploadImage(t,e),e.minFilter&&e.minFilter!=gl.NEAREST&&e.minFilter!=gl.LINEAR&&(n.bind(),gl.generateMipmap(n.texture_type),n.has_mipmaps=!0,n.data=t),gl.bindTexture(n.texture_type,null),n},Texture.fromTexture=function(t,e){e=e||{};var n=new r.Texture(t.width,t.height,e);return t.copyTo(n),n},Texture.prototype.clone=function(t){var e=this.getProperties();if(t)for(var r in t)e[r]=t[r];return Texture.fromTexture(this,e)},Texture.fromMemory=function(t,e,n,a){var i=(a=a||{}).texture||new r.Texture(t,e,a);Texture.setUploadOptions(a),i.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,i.format,t,e,0,i.format,i.type,n),i.data=n}catch(t){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),i.has_mipmaps=!0),gl.bindTexture(i.texture_type,null),i},Texture.fromDDSInMemory=function(t,e){var a=(e=e||{}).texture||new r.Texture(0,0,e);r.Texture.setUploadOptions(e),a.bind();var i=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");return n.loadDDSTextureFromMemoryEx(gl,i,t,a,!0),gl.bindTexture(a.texture_type,null),a},Texture.fromShader=function(t,e,n,a){return a=a||{},(t=new r.Texture(t,e,a)).drawTo((function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var t=Mesh.getScreenQuad();n.draw(t)})),t},Texture.cubemapFromImages=function(t,e){if(e=e||{},6!=t.length)throw"missing images to create cubemap";var n=t[0].width,a=t[0].height;e.texture_type=gl.TEXTURE_CUBE_MAP;var i=null;e.texture?((i=e.texture).width=n,i.height=a):i=new r.Texture(n,a,e),Texture.setUploadOptions(e),i.bind();try{for(n=0;6>n;n++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,i.format,i.format,i.type,t[n]);i.data=t}catch(t){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return e.minFilter&&e.minFilter!=gl.NEAREST&&e.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),i.has_mipmaps=!0),i.unbind(),i},Texture.cubemapFromImage=function(t,e){if(e=e||{},t.width!=t.height/6&&0!=t.height%6&&!e.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",t.width,t.height),null;var r=t.width,n=t.height;if(void 0!==e.is_cross?(e.faces=Texture.generateCubemapCrossFacesInfo(t.width,e.is_cross),r=n=t.width/4):e.faces?(r=e.width||e.faces[0].width,n=e.height||e.faces[0].height):n/=6,r!=n)return console.log("Texture not valid, width and height for every face must be square"),null;var a=r;e.no_flip=!0;for(var i=[],o=0;6>o;o++){var s=createCanvas(a,a),u=s.getContext("2d");e.faces?u.drawImage(t,e.faces[o].x,e.faces[o].y,e.faces[o].width||a,e.faces[o].height||a,0,0,a,a):u.drawImage(t,0,n*o,r,n,0,0,a,a),i.push(s)}return r=Texture.cubemapFromImages(i,e),e.keep_image&&(r.img=t),r},Texture.generateCubemapCrossFacesInfo=function(t,e){void 0===e&&(e=1);var r=t/4;return[{x:2*r,y:r,width:r,height:r},{x:0,y:r,width:r,height:r},{x:e*r,y:0,width:r,height:r},{x:e*r,y:2*r,width:r,height:r},{x:r,y:r,width:r,height:r},{x:3*r,y:r,width:r,height:r}]},Texture.cubemapFromURL=function(t,e,n){(e=e||{}).texture_type=gl.TEXTURE_CUBE_MAP;var a=e.texture||new r.Texture(1,1,e);e=Object.create(e),a.bind(),Texture.setUploadOptions(e);for(var i=e.temp_color||[0,0,0,255],o=(i=e.type==gl.FLOAT?new Float32Array(i):new Uint8Array(i),0);6>o;o++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,a.format,1,1,0,a.format,a.type,i);return gl.bindTexture(a.texture_type,null),a.ready=!1,(i=new Image).src=t,i.onload=function(){e.texture=a,(a=r.Texture.cubemapFromImage(this,e))&&delete a.ready,n&&n(a)},a},Texture.prototype.getPixels=function(t,e,r){var n=(e=this.gl).getViewport(),a=e.getParameter(e.FRAMEBUFFER_BINDING);if(t=t||this.type,this.format==e.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";e.disable(e.DEPTH_TEST);var i=e.__copy_fbo;return i||(i=e.__copy_fbo=e.createFramebuffer()),e.bindFramebuffer(e.FRAMEBUFFER,i),i=null,e.viewport(0,0,this.width,this.height),this.texture_type==e.TEXTURE_2D?e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.handler,0):this.texture_type==e.TEXTURE_CUBE_MAP&&e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+(r||0),this.handler,0),r=this.format==e.RGB?3:4,r=4,i=t==e.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*r):new Float32Array(this.width*this.height*r),e.readPixels(0,0,this.width,this.height,3==r?e.RGB:e.RGBA,t,i),e.bindFramebuffer(e.FRAMEBUFFER,a),e.viewport(n[0],n[1],n[2],n[3]),i},Texture.prototype.toCanvas=function(t,e,n){n=n||8192;var a=this.gl,i=Math.min(this.width,n),o=Math.min(this.height,n);this.texture_type==a.TEXTURE_CUBE_MAP&&(i*=4,o*=3),(t=t||createCanvas(i,o)).width!=i&&(t.width=i),t.height!=o&&(t.height=o);var s=null;if(this.texture_type==a.TEXTURE_2D){this.width!=i||this.height!=o?(s=new r.Texture(i,o,{format:a.RGBA,filter:a.NEAREST}),this.copyTo(s),s=s.getPixels(a.UNSIGNED_BYTE,!0)):s=this.getPixels(a.UNSIGNED_BYTE,!0);var u=(n=t.getContext("2d")).getImageData(0,0,i,o);u.data.set(s),n.putImageData(u,0,0),e&&((e=(s=createCanvas(i,o)).getContext("2d")).translate(0,s.height),e.scale(1,-1),e.drawImage(t,0,0,s.width,s.height),n.drawImage(s,0,0))}else if(this.texture_type==a.TEXTURE_CUBE_MAP){e=(i=createCanvas(this.width,this.height)).getContext("2d"),o=r.Texture.generateCubemapCrossFacesInfo(t.width,1),(n=t.getContext("2d")).fillStyle="black",n.fillRect(0,0,t.width,t.height);for(var c=0;6>c;c++)s=this.getPixels(a.UNSIGNED_BYTE,!0,c),(u=e.getImageData(0,0,i.width,i.height)).data.set(s),e.putImageData(u,0,0),n.drawImage(i,o[c].x,o[c].y,i.width,i.height)}return t},Texture.prototype.toBlob=function(t,e){for(var r=(n=this.toCanvas(null,t).toDataURL(e)).indexOf(","),n=n.substr(r+1),a=(r=(n=atob(n)).length,new Uint8Array(r)),i=0;i<r;++i)a[i]=n.charCodeAt(i);return new Blob([a],{type:e||"image/png"})},Texture.prototype.toBlobAsync=function(t,e,r){var n=this.toCanvas(null,t);n.toBlob?n.toBlob(r,e):(t=this.toBlob(t,e),r&&r(t))},Texture.prototype.toBase64=function(t){var e=this.width,r=this.height,n=this.getPixels(),a=createCanvas(e,r),i=a.getContext("2d"),o=i.getImageData(0,0,e,r);return o.data.set(n),i.putImageData(o,0,0),t&&((e=(t=createCanvas(e,r)).getContext("2d")).translate(0,r),e.scale(1,-1),e.drawImage(a,0,0),a=t),a.toDataURL("image/png")},Texture.prototype.generateMetadata=function(){var t={};t.width=this.width,t.height=this.height,this.metadata=t},Texture.compareFormats=function(t,e){return!(!t||!e)&&(t==e||t.width==e.width&&t.height==e.height&&t.type==e.type&&t.format==e.format&&t.texture_type==e.texture_type)},Texture.blend=function(t,e,n,a){if(!t||!e)return!1;if(t==e)return a?t.copyTo(a):t.toViewport(),!0;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var i=r.Shader.getBlendShader(),o=r.Mesh.getScreenQuad();return e.bind(1),i.uniforms({u_texture:0,u_texture2:1,u_factor:n}),a?(a.drawTo((function(){if(t==a||e==a)throw"Blend output cannot be the same as the input";t.bind(0),i.draw(o,gl.TRIANGLES)})),!0):(t.bind(0),i.draw(o,gl.TRIANGLES),!0)},Texture.getWhiteTexture=function(e){var n=(e=e||t.gl).textures[":white"];return n||(n=new Uint8Array([255,255,255,255]),e.textures[":white"]=new r.Texture(1,1,{pixel_data:n}))},Texture.getBlackTexture=function(e){var n=(e=e||t.gl).textures[":black"];return n||(n=new Uint8Array([0,0,0,255]),e.textures[":black"]=new r.Texture(1,1,{pixel_data:n}))},Texture.getTemporary=function(t,e,n){Texture.temporary_pool||(Texture.temporary_pool=[]);var a=Texture.temporary_pool,i=r.TEXTURE_2D,o=Texture.DEFAULT_TYPE,s=Texture.DEFAULT_FORMAT;for(n&&(n.texture_type&&(i=n.texture_type),n.type&&(o=n.type),n.format&&(s=n.format)),n=0;n<a.length;++n){var u=a[n];if(u.width==t&&u.height==e&&u.type==o&&u.texture_type==i&&u.format==s)return a.splice(n,1),u}return new r.Texture(t,e,{type:o,texture_type:i,format:s})},Texture.releaseTemporary=function(t){Texture.temporary_pool||(Texture.temporary_pool=[]),Texture.temporary_pool.push(t)},Texture.nextPOT=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))},r.FBO=e,e.prototype.setTextures=function(t,e,r){if(e&&(e.format!==gl.DEPTH_COMPONENT||e.type!=gl.UNSIGNED_INT))throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";var n=this.depth_texture==e;if(n&&t)if(t.length==this.color_textures.length){for(var a=0;a<t.length;++a)if(t[a]!=this.color_textures[a]){n=!1;break}}else n=!1;if(this._stencil_enabled!==this.stencil&&(n=!1),!n){if(this.color_textures.length=t?t.length:0,t)for(a=0;a<t.length;++a)this.color_textures[a]=t[a];this.depth_texture=e,this.update(r)}},e.prototype.update=function(t){this._old_fbo=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler||(this.handler=gl.createFramebuffer());var e=-1,r=-1,n=null,a=this.color_textures,i=this.depth_texture;if(a&&a.length)for(var o=0;o<a.length;o++){var s=a[o];if(-1==e)e=s.width;else if(e!=s.width)throw"Cannot bind textures with different dimensions";if(-1==r)r=s.height;else if(r!=s.height)throw"Cannot bind textures with different dimensions";if(null==n)n=s.type;else if(n!=s.type)throw"Cannot bind textures to a FBO with different pixel formats";if(s.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO"}else e=i.width,r=i.height;if(this.width=e,this.height=r,gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),i&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";if(!(n=gl.extensions.WEBGL_draw_buffers)&&a&&1<a.length)throw"Rendering to several textures not supported by your browser";if(i?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,i.handler,0):((o=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer()).width=e,o.height=r,gl.bindRenderbuffer(gl.RENDERBUFFER,o),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,e,r),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,o)),a&&a.length)for(this.order=[],o=0;o<a.length;o++)s=a[o],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+o,gl.TEXTURE_2D,s.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+o);else(o=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer()).width=e,o.height=r,gl.bindRenderbuffer(gl.RENDERBUFFER,o),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,e,r),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,o);for(o=i=a?a.length:0;o<this._num_binded_textures;++o)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+o,gl.TEXTURE_2D,null,0);if(this._num_binded_textures=i,this.stencil?(o=this._stencil_buffer=this._stencil_buffer||gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,o),gl.renderbufferStorage(gl.RENDERBUFFER,gl.STENCIL_INDEX8,e,r),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.STENCIL_ATTACHMENT,gl.RENDERBUFFER,o),this._stencil_enabled=!0):this._stencil_enabled=!1,a&&1<a.length&&n.drawBuffersWEBGL(this.order),(e=gl.checkFramebufferStatus(gl.FRAMEBUFFER))!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+e;gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),t||gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo)},e.prototype.bind=function(t){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data),this._old_fbo=t?gl.getParameter(gl.FRAMEBUFFER_BINDING):null,this._old_fbo!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.viewport(0,0,this.width,this.height)},e.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo),this._old_fbo=null,gl.setViewport(this._old_viewport)},t.Shader=r.Shader=function e(n,a,i){r.debug&&console.log("GL.Shader created"),this._context_id=t.gl.context_id;var o=this.gl=t.gl;if(i=e.expandMacros(i),this.program=o.createProgram(),n=n.constructor===String?r.Shader.compileSource(o.VERTEX_SHADER,i+n):n,a=a.constructor===String?r.Shader.compileSource(o.FRAGMENT_SHADER,i+a):a,o.attachShader(this.program,n,o),o.attachShader(this.program,a,o),o.linkProgram(this.program),!o.getProgramParameter(this.program,o.LINK_STATUS))throw"link error: "+o.getProgramInfoLog(this.program);this.vs_shader=n,this.fs_shader=a,this.attributes={},this.uniformInfo={},this.samplers={},this.extractShaderInfo()},Shader.expandMacros=function(t){var e="";if(t)for(var r in t)e+="#define "+r+" "+(t[r]?t[r]:"")+"\n";return e},Shader.compileSource=function(e,r,n,a){if(n=n||t.gl,a=a||n.createShader(e),n.shaderSource(a,r),n.compileShader(a),!n.getShaderParameter(a,n.COMPILE_STATUS))throw(e==n.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+n.getShaderInfoLog(a);return a},Shader.prototype.updateShader=function(e,n,a){var i=this.gl||t.gl;if(a=Shader.expandMacros(a),this.program&&(this.program=i.createProgram()),e=e.constructor===String?r.Shader.compileSource(i.VERTEX_SHADER,a+e,i,this.vs_shader):e,n=n.constructor===String?r.Shader.compileSource(i.FRAGMENT_SHADER,a+n,i,this.fs_shader):n,i.attachShader(this.program,e,i),i.attachShader(this.program,n,i),i.linkProgram(this.program),!i.getProgramParameter(this.program,i.LINK_STATUS))throw"link error: "+i.getProgramInfoLog(this.program);this.vs_shader=e,this.fs_shader=n,this.attributes={},this.uniformInfo={},this.samplers={},this.extractShaderInfo()},Shader.prototype.extractShaderInfo=function(){for(var t=this.gl,e=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),r=0;r<e;++r){var n=t.getActiveUniform(this.program,r);if(!n)break;var a=n.name;-1!=(i=a.indexOf("["))&&-1==a.indexOf("].")&&(a=a.substr(0,i)),n.type!=t.SAMPLER_2D&&n.type!=t.SAMPLER_CUBE||(this.samplers[a]=n.type);var i=Shader.getUniformFunc(n),o=!1;n.type!=t.FLOAT_MAT2&&n.type!=t.FLOAT_MAT3&&n.type!=t.FLOAT_MAT4||(o=!0),this.uniformInfo[a]={type:n.type,func:i,size:n.size,is_matrix:o,loc:t.getUniformLocation(this.program,a)}}for(r=0,e=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);r<e&&(n=t.getActiveAttrib(this.program,r));++r)i=Shader.getUniformFunc(n),this.uniformInfo[n.name]={type:n.type,func:i,size:n.size,loc:null},this.attributes[n.name]=t.getAttribLocation(this.program,n.name)},Shader.prototype.hasUniform=function(t){return this.uniformInfo[t]},Shader.prototype.hasAttribute=function(t){return this.attributes[t]},Shader.getUniformFunc=function(t){var e=null;switch(t.type){case gl.FLOAT:e=1==t.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:e=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:e=gl.uniformMatrix3fv;break;case gl.FLOAT_MAT4:e=gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:e=gl.uniform2fv;break;case gl.FLOAT_VEC3:e=gl.uniform3fv;break;case gl.FLOAT_VEC4:e=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:e=1==t.size?gl.uniform1i:gl.uniform1iv;break;case gl.INT_VEC2:e=gl.uniform2iv;break;case gl.INT_VEC3:e=gl.uniform3iv;break;case gl.INT_VEC4:e=gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:e=gl.uniform1i;break;default:e=gl.uniform1f}return e},Shader.fromURL=function(t,e,n){function a(){var t,e=new r.Shader(o,s);for(t in e)i[t]=e[t];i.ready=!0}var i=new r.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");i.ready=!1;var o=null,s=null;return HttpRequest(t,null,(function(t){o=t,s&&a()})),HttpRequest(e,null,(function(t){s=t,o&&a()})),i},Shader.prototype.bind=function(){var t=this.gl;t.useProgram(this.program),t._current_shader=this},Shader.prototype.getLocation=function(t){return this.uniformInfo[t]?this.uniformInfo[t].loc:null},Shader._temp_uniform=new Float32Array(16),Shader.prototype.uniforms=function(t){var e=this.gl;for(var r in e.useProgram(this.program),e._current_shader=this,t)this.uniformInfo[r]&&this._setUniform(r,t[r]);return this},Shader.prototype.uniformsArray=function(t){(e=this.gl).useProgram(this.program),e._current_shader=this;for(var e=0,r=t.length;e<r;++e){var n,a=t[e];for(n in a)this._setUniform(n,a[n])}return this},Shader.prototype.setUniform=function(t,e){this.gl._current_shader!=this&&this.bind();var r=this.uniformInfo[t];r&&null!==r.loc&&null!=e&&(e.constructor===Array&&(e=new Float32Array(e)),r.is_matrix?r.func.call(this.gl,r.loc,!1,e):r.func.call(this.gl,r.loc,e))},Shader.prototype._setUniform=function(t,e){var r=this.uniformInfo[t];r&&null!==r.loc&&null!=e&&(e.constructor===Array&&(e=new Float32Array(e)),r.is_matrix?r.func.call(this.gl,r.loc,!1,e):r.func.call(this.gl,r.loc,e))},Shader.prototype.draw=function(t,e,r){r=void 0===r?e==gl.LINES?"lines":"triangles":r,this.drawBuffers(t.vertexBuffers,r?t.indexBuffers[r]:null,2>arguments.length?gl.TRIANGLES:e)},Shader.prototype.drawRange=function(t,e,r,n,a){a=void 0===a?e==gl.LINES?"lines":"triangles":a,this.drawBuffers(t.vertexBuffers,a?t.indexBuffers[a]:null,e,r,n)};var f=new Uint8Array(16),h=new Uint8Array(16);Shader.prototype.drawBuffers=function(t,e,r,n,a){if(0!=a){var i=this.gl;i.useProgram(this.program);var o=0;for(var s in f.set(h),t){var u=t[s],c=u.attribute||s,l=this.attributes[c];null!=l&&u.buffer&&(f[l]=1,i.bindBuffer(i.ARRAY_BUFFER,u.buffer),i.enableVertexAttribArray(l),i.vertexAttribPointer(l,u.buffer.spacing,u.buffer.gl_type,!1,0,0),o=u.buffer.length/u.buffer.spacing)}for(c in t=0,0<n&&(t=n*(e&&e.data?e.data.constructor.BYTES_PER_ELEMENT:1)),0<a?o=a:e&&(o=e.buffer.length-t),this.attributes)l=this.attributes[c],f[l]||i.disableVertexAttribArray(this.attributes[c]);return!o||e&&!e.buffer||(e?(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.buffer),i.drawElements(r,o,e.buffer.gl_type,t),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null)):i.drawArrays(r,t,o)),this}},Shader.expandImports=function(t,e){e=e||Shader.files;var r={};if(!e)throw"Shader.files not initialized, assign files there";return t.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,(function(t){if(t=t.split('"')[1],r[t])return"//already imported: "+t+"\n";var n=e[t];return r[t]=!0,n?n+"\n":"//import code not found: "+t+"\n"}))},Shader.dumpErrorToConsole=function(t,e,r){console.error(t);var n=null;n=-1!=t.indexOf("Fragment")?r:e;for(var a in t=n.split("\n"))t[a]=a+"| "+t[a];console.groupCollapsed("Shader code"),console.log(t.join("\n")),console.groupEnd()},Shader.validateValue=function(t,e){if(null==t)return!1;switch(e.type){case r.INT:case r.FLOAT:case r.SAMPLER_2D:case r.SAMPLER_CUBE:return isNumber(t);case r.INT_VEC2:case r.FLOAT_VEC2:return 2===t.length;case r.INT_VEC3:case r.FLOAT_VEC3:return 3===t.length;case r.INT_VEC4:case r.FLOAT_VEC4:case r.FLOAT_MAT2:return 4===t.length;case r.FLOAT_MAT3:return 8===t.length;case r.FLOAT_MAT4:return 16===t.length}return!0},Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t",Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t",Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t",Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t",Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t",Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t",Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t",Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t",Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t",Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t",Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t",Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t",Shader.createFX=function(t,e,n){return t={FX_CODE:t,FX_UNIFORMS:e||""},n?(n.updateShader(r.Shader.SCREEN_VERTEX_SHADER,r.Shader.SCREEN_FRAGMENT_FX,t),n):new r.Shader(r.Shader.SCREEN_VERTEX_SHADER,r.Shader.SCREEN_FRAGMENT_FX,t)},Shader.prototype.toViewport=function(t){var e=r.Mesh.getScreenQuad();t&&this.uniforms(t),this.draw(e)},Shader.getScreenShader=function(e){var n=(e=e||t.gl).shaders[":screen"];return n||(n=e.shaders[":screen"]=new r.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER)).uniforms({u_texture:0})},Shader.getColoredScreenShader=function(e){var n=(e=e||t.gl).shaders[":colored_screen"];return n||(n=e.shaders[":colored_screen"]=new r.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER)).uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})},Shader.getQuadShader=function(e){var n=(e=e||t.gl).shaders[":quad"];return n||(e.shaders[":quad"]=new r.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER))},Shader.getPartialQuadShader=function(e){var n=(e=e||t.gl).shaders[":quad2"];return n||(e.shaders[":quad2"]=new r.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER))},Shader.getBlendShader=function(e){var n=(e=e||t.gl).shaders[":blend"];return n||(e.shaders[":blend"]=new r.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER))},Shader.getBlurShader=function(e){var n=(e=e||t.gl).shaders[":blur"];return n||(n=new r.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t"),e.shaders[":blur"]=n)},Shader.getCubemapCopyShader=function(e){var n=(e=e||t.gl).shaders[":copy_cubemap"];return n||(n=new r.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t"),e.shaders[":copy_cubemap"]=n)},Shader.getCubemapBlurShader=function(e){var n=(e=e||t.gl).shaders[":blur_cubemap"];return n||(n=new r.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t"),e.shaders[":blur_cubemap"]=n)},Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n",Shader.getFXAAShader=function(e){if(n=(e=e||t.gl).shaders[":fxaa"])return n;var n=new r.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t"),a=vec2.fromValues(e.viewport_data[2],e.viewport_data[3]),i=vec2.fromValues(1/e.viewport_data[2],1/e.viewport_data[3]);return n.setup=function(){a[0]=e.viewport_data[2],a[1]=e.viewport_data[3],i[0]=1/e.viewport_data[2],i[1]=1/e.viewport_data[3],this.uniforms({u_viewportSize:a,u_iViewportSize:i})},e.shaders[":fxaa"]=n},Shader.getFlatShader=function(e){var n=(e=e||t.gl).shaders[":flat"];return n||((n=new r.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER)).uniforms({u_color:[1,1,1,1]}),e.shaders[":flat"]=n)},r.create=function(e){function n(t){var e=s.mouse.buttons;r.augmentEvent(t,o),t.eventType=t.eventType||t.type;var a=getTime();return c.dragging=t.dragging,c.position[0]=t.canvasx,c.position[1]=t.canvasy,c.x=t.canvasx,c.y=t.canvasy,c.clientx=t.mousex,c.clienty=t.mousey,c.left_button=c.buttons&1<<r.LEFT_MOUSE_BUTTON,c.middle_button=c.buttons&1<<r.MIDDLE_MOUSE_BUTTON,c.right_button=c.buttons&1<<r.RIGHT_MOUSE_BUTTON,"mousedown"==t.eventType?(0==e&&(o.removeEventListener("mousemove",n),(e=o.ownerDocument).addEventListener("mousemove",n),e.addEventListener("mouseup",n)),u=a,s.onmousedown&&s.onmousedown(t),d.trigger(s,"mousedown")):"mousemove"==t.eventType?(s.onmousemove&&s.onmousemove(t),d.trigger(s,"mousemove",t)):"mouseup"==t.eventType?(0==s.mouse.buttons&&(o.addEventListener("mousemove",n),(e=o.ownerDocument).removeEventListener("mousemove",n),e.removeEventListener("mouseup",n)),t.click_time=a-u,s.onmouseup&&s.onmouseup(t),d.trigger(s,"mouseup",t)):"mousewheel"!=t.eventType&&"wheel"!=t.eventType&&"DOMMouseScroll"!=t.eventType||(t.eventType="mousewheel",t.wheel="wheel"==t.type?-t.deltaY:null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=void 0!==t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,s.onmousewheel&&s.onmousewheel(t),d.trigger(s,"mousewheel",t)),s.onmouse&&s.onmouse(t),"mousemove"!=t.eventType&&t.stopPropagation(),t.preventDefault(),!1}function a(t){var e=t.changedTouches,r=e[0],n="";if(!(t.touches.length&&t.changedTouches[0].identifier!==t.touches[0].identifier||1<e)){switch(t.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}(e=document.createEvent("MouseEvent")).initMouseEvent(n,!0,!0,window,1,r.screenX,r.screenY,r.clientX,r.clientY,!1,!1,!1,!1,0,null),r.target.dispatchEvent(e),t.preventDefault()}}function i(t){s.ongesture&&(t.eventType=t.type,s.ongesture(t)),event.preventDefault()}var o=null;if((e=e||{}).canvas)if("string"==typeof e.canvas){if(!(o=document.getElementById(e.canvas)))throw"Canvas element not found: "+e.canvas}else o=e.canvas;else o=createCanvas(e.width||800,e.height||600);"alpha"in e||(e.alpha=!1);try{t.gl=o.getContext("webgl",e)}catch(t){}try{t.gl=t.gl||o.getContext("experimental-webgl",e)}catch(t){}if(!t.gl)throw"WebGL not supported";var s=t.gl;if(o.is_webgl=!0,o.gl=s,s.context_id=this.last_context_id++,s.extensions={},s.extensions.OES_standard_derivatives=s.derivatives_supported=s.getExtension("OES_standard_derivatives")||!1,s.extensions.WEBGL_depth_texture=s.getExtension("WEBGL_depth_texture")||s.getExtension("WEBKIT_WEBGL_depth_texture")||s.getExtension("MOZ_WEBGL_depth_texture"),s.extensions.OES_element_index_uint=s.getExtension("OES_element_index_uint"),s.extensions.WEBGL_draw_buffers=s.getExtension("WEBGL_draw_buffers"),s.extensions.EXT_shader_texture_lod=s.getExtension("EXT_shader_texture_lod"),s.extensions.EXT_sRGB=s.getExtension("EXT_sRGB"),s.extensions.EXT_texture_filter_anisotropic=s.getExtension("EXT_texture_filter_anisotropic")||s.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||s.getExtension("MOZ_EXT_texture_filter_anisotropic"),s.extensions.EXT_frag_depth=s.getExtension("EXT_frag_depth")||s.getExtension("WEBKIT_EXT_frag_depth")||s.getExtension("MOZ_EXT_frag_depth"),s.extensions.WEBGL_lose_context=s.getExtension("WEBGL_lose_context")||s.getExtension("WEBKIT_WEBGL_lose_context")||s.getExtension("MOZ_WEBGL_lose_context"),s.extensions.OES_texture_float_linear=s.getExtension("OES_texture_float_linear"),s.extensions.OES_texture_float_linear&&(s.extensions.OES_texture_float=s.getExtension("OES_texture_float")),s.extensions.OES_texture_half_float_linear=s.getExtension("OES_texture_half_float_linear"),s.extensions.OES_texture_half_float_linear&&(s.extensions.OES_texture_half_float=s.getExtension("OES_texture_half_float")),s.HALF_FLOAT_OES=36193,s.extensions.OES_texture_half_float&&(s.HALF_FLOAT_OES=s.extensions.OES_texture_half_float.HALF_FLOAT_OES),s.HIGH_PRECISION_FORMAT=s.extensions.OES_texture_half_float?s.HALF_FLOAT_OES:s.extensions.OES_texture_float?s.FLOAT:s.UNSIGNED_BYTE,s.max_texture_units=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),s._viewport_func=s.viewport,s.viewport_data=new Float32Array([0,0,s.canvas.width,s.canvas.height]),s.viewport=function(t,e,r,n){var a=this.viewport_data;a[0]=0|t,a[1]=0|e,a[2]=0|r,a[3]=0|n,this._viewport_func(t,e,r,n)},s.getViewport=function(t){return t?(t[0]=s.viewport_data[0],t[1]=s.viewport_data[1],t[2]=s.viewport_data[2],t[3]=s.viewport_data[3],t):new Float32Array(s.viewport_data)},s.setViewport=function(t,e){s.viewport_data.set(t),e&&(s.viewport_data[1]=this.drawingBufferHeight-t[1]-t[3]),this._viewport_func(t[0],s.viewport_data[1],t[2],t[3])},"undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var u=0;s.shaders={},s.textures={},s.meshes={},s.makeCurrent=function(){t.gl=this},s.execute=function(e){var r=t.gl;t.gl=this,e(),t.gl=r},s.animate=function(e){if(!1===e)t.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;else{var r=t.requestAnimationFrame,n=getTime(),a=this;this._requestFrame_id=r((function e(){if(!s.destroyed){a._requestFrame_id=r(e);var i=getTime(),o=.001*(i-n);a.onupdate&&a.onupdate(o),d.trigger(s,"update",o),a.ondraw&&(o=t.gl,t.gl=a,a.ondraw(),d.trigger(s,"draw"),t.gl=o),n=i}}))}},s.destroy=function(){l&&(document.removeEventListener("keydown",l),document.removeEventListener("keyup",l)),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.destroyed=!0,t.gl==this&&(t.gl=null)};var c=s.mouse={buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(t,e,r,n,a){var i=this.y;return a&&(i=s.canvas.height-i),this.x>t&&this.x<t+r&&i>e&&i<e+n},isButtonPressed:function(t){return this.buttons&1<<r.RIGHT_MOUSE_BUTTON}};s.captureMouse=function(t){o.addEventListener("mousedown",n),o.addEventListener("mousemove",n),t&&(o.addEventListener("mousewheel",n,!1),o.addEventListener("wheel",n,!1)),o.addEventListener("contextmenu",(function(t){return t.preventDefault(),!1})),o.addEventListener("touchstart",a,!0),o.addEventListener("touchmove",a,!0),o.addEventListener("touchend",a,!0),o.addEventListener("touchcancel",a,!0),o.addEventListener("gesturestart",i),o.addEventListener("gesturechange",i),o.addEventListener("gestureend",i)},s.keys={};var l=null;s.captureKeys=function(t,e){function n(e){var n=t;if(e.eventType=e.type,"input"!==(a=e.target.nodeName.toLowerCase())&&"textarea"!==a&&"select"!==a){e.character=String.fromCharCode(e.keyCode).toLowerCase();var a=!1,i=r.mapKeyCode(e.keyCode);i||(i=e.character),e.altKey||e.ctrlKey||e.metaKey||(i&&(s.keys[i]="keydown"==e.type),a=s.keys[e.keyCode],s.keys[e.keyCode]="keydown"==e.type),a!=s.keys[e.keyCode]&&("keydown"==e.type&&s.onkeydown?s.onkeydown(e):"keyup"==e.type&&s.onkeyup&&s.onkeyup(e),d.trigger(s,e.type,e)),s.onkey&&s.onkey(e),n&&(e.isChar||r.blockable_keys[e.keyIdentifier||e.key])&&e.preventDefault()}}l||(s.keys={},document.addEventListener("keydown",n),document.addEventListener("keyup",n),l=n)},s.gamepads=null,s.captureGamepads=function(){var t=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;t&&(this.gamepads=t.call(navigator))},s.getGamepads=function(t){var e=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(e){e=e.call(navigator),this.gamepads||(this.gamepads=[]);for(var r=0;4>r;r++){var n=e[r];if(n&&!t){var a=n,i={axes:[],buttons:{},hat:""};i.axes.lx=a.axes[0],i.axes.ly=a.axes[1],i.axes.rx=a.axes[2],i.axes.ry=a.axes[3],i.axes.triggers=a.axes[4];for(var o=0;o<a.buttons.length;o++)switch(o){case 0:i.buttons.a=a.buttons[o].pressed;break;case 1:i.buttons.b=a.buttons[o].pressed;break;case 2:i.buttons.x=a.buttons[o].pressed;break;case 3:i.buttons.y=a.buttons[o].pressed;break;case 4:i.buttons.lb=a.buttons[o].pressed;break;case 5:i.buttons.rb=a.buttons[o].pressed;break;case 6:i.buttons.lt=a.buttons[o].pressed;break;case 7:i.buttons.rt=a.buttons[o].pressed;break;case 8:i.buttons.back=a.buttons[o].pressed;break;case 9:i.buttons.start=a.buttons[o].pressed;break;case 10:i.buttons.ls=a.buttons[o].pressed;break;case 11:i.buttons.rs=a.buttons[o].pressed;break;case 12:a.buttons[o].pressed&&(i.hat+="up");break;case 13:a.buttons[o].pressed&&(i.hat+="down");break;case 14:a.buttons[o].pressed&&(i.hat+="left");break;case 15:a.buttons[o].pressed&&(i.hat+="right");break;case 16:i.buttons.home=a.buttons[o].pressed}a.xbox=i}if(!(a=this.gamepads[r])&&n?((i=new CustomEvent("gamepadconnected")).eventType=i.type,i.gamepad=n,this.ongamepadconnected&&this.ongamepadconnected(i),d.trigger(s,"gamepadconnected",i)):a&&!n&&((i=new CustomEvent("gamepaddisconnected")).eventType=i.type,i.gamepad=a,this.ongamepaddisconnected&&this.ongamepaddisconnected(i),d.trigger(s,"gamepaddisconnected",i)),n)for(o=0;o<n.buttons.length;++o){var u=n.buttons[o];!u.pressed||a&&a.buttons[o].pressed?!u.pressed&&a&&a.buttons[o].pressed&&((i=new CustomEvent("gamepadButtonUp")).eventType=i.type,i.button=u,i.which=o,i.gamepad=n,s.onbuttondown&&s.onbuttondown(i),d.trigger(s,"buttonup",i)):((i=new CustomEvent("gamepadButtonDown")).eventType=i.type,i.button=u,i.which=o,i.gamepad=n,s.onbuttondown&&s.onbuttondown(i),d.trigger(s,"buttondown",i))}}return this.gamepads=e}},s.fullscreen=function(){var t=this.canvas;t.requestFullScreen?t.requestFullScreen():t.webkitRequestFullScreen?t.webkitRequestFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():console.error("Fullscreen not supported")},s.snapshot=function(t,e,r,n,a){var i=createCanvas(r,n),o=i.getContext("2d"),u=o.getImageData(0,0,i.width,i.height),c=new Uint8Array(r*n*4);return s.readPixels(t,e,i.width,i.height,s.RGBA,s.UNSIGNED_BYTE,c),u.data.set(c),o.putImageData(u,0,0),a?i:((o=(t=createCanvas(r,n)).getContext("2d")).translate(0,n),o.scale(1,-1),o.drawImage(i,0,0),t)};var f={};return s.loadTexture=function(t,e,n){if(this.textures[t])return this.textures[t];if(f[t])return null;var a=new Image;return a.url=t,a.onload=function(){var t=r.Texture.fromImage(this,e);t.img=this,s.textures[this.url]=t,delete f[this.url],n&&n(t)},a.src=t,f[t]=!0,null},s.drawTexture=function(){var t=mat3.create(),e=vec2.create(),r=vec2.create(),n=vec4.create(),a=vec4.fromValues(1,1,1,1),i=vec2.create(),o={u_texture:0,u_position:e,u_color:a,u_size:r,u_texture_area:n,u_viewport:i,u_transform:t};return function(t,a,u,c,l,f,h,d,_,v,p){e[0]=a,e[1]=u,void 0===c&&(c=t.width),void 0===l&&(l=t.height),r[0]=c,r[1]=l,void 0===f&&(f=0),void 0===h&&(h=0),void 0===d&&(d=t.width),void 0===_&&(_=t.height),n[0]=f/t.width,n[1]=h/t.height,n[2]=(f+d)/t.width,n[3]=(h+_)/t.height,i[0]=this.viewport_data[2],i[1]=this.viewport_data[3],v=v||Shader.getPartialQuadShader(this),a=Mesh.getScreenQuad(this),t.bind(0),v.uniforms(o),p&&v.uniforms(p),v.draw(a,s.TRIANGLES)}}(),s.canvas.addEventListener("webglcontextlost",(function(t){t.preventDefault(),s.onlosecontext&&s.onlosecontext(t)}),!1),s.reset=function(){s.viewport(0,0,this.canvas.width,this.canvas.height),s.disable(s.BLEND),s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.frontFace(s.CCW),s._current_texture_drawto=null,s._current_fbo_color=null,s._current_fbo_depth=null},s.reset(),s},r.mapKeyCode=function(t){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[t]||(65<=t&&90>=t?String.fromCharCode(t):null)},r.dragging=!1,r.last_pos=[0,0],r.augmentEvent=function(t,e){var n;n=(e=e||t.target||gl.canvas).getBoundingClientRect(),t.mousex=t.clientX-n.left,t.mousey=t.clientY-n.top,t.canvasx=t.mousex,t.canvasy=n.height-t.mousey,t.deltax=0,t.deltay=0,"mousedown"==t.type?(this.dragging=!0,gl.mouse.buttons|=1<<t.which):"mousemove"!=t.type&&"mouseup"==t.type&&(gl.mouse.buttons&=~(1<<t.which),0==gl.mouse.buttons&&(this.dragging=!1)),t.deltax=t.mousex-this.last_pos[0],t.deltay=t.mousey-this.last_pos[1],this.last_pos[0]=t.mousex,this.last_pos[1]=t.mousey,t.dragging=this.dragging,t.buttons_mask=gl.mouse.buttons,t.leftButton=gl.mouse.buttons&1<<r.LEFT_MOUSE_BUTTON,t.middleButton=gl.mouse.buttons&1<<r.MIDDLE_MOUSE_BUTTON,t.rightButton=gl.mouse.buttons&1<<r.RIGHT_MOUSE_BUTTON,t.isButtonPressed=function(t){return this.buttons_mask&1<<t}};var d=t.LEvent=r.LEvent={bind:function(t,e,r,n){if(!t)throw"cannot bind event to null";if(!r)throw"cannot bind to null callback";if(t.constructor===String)throw"cannot bind event to a string";var a=t.__levents;a||(Object.defineProperty(t,"__levents",{value:{},enumerable:!1}),a=t.__levents),a.hasOwnProperty(e)?a[e].push([r,n]):a[e]=[[r,n]]},unbind:function(t,e,r,n){if(!t)throw"cannot unbind event to null";if(!r)throw"cannot unbind from null callback";if(t.constructor===String)throw"cannot bind event to a string";if((t=t.__levents)&&t.hasOwnProperty(e)){for(var a=0,i=t[e].length;a<i;++a){var o=t[e][a];if(o[0]===r&&o[1]===n){t[e].splice(a,1);break}}0==t[e].length&&delete t[e]}},unbindAll:function(t,e,r){if(!t)throw"cannot unbind events in null";var n=t.__levents;if(n)if(e)for(var a in n)for(var i=(t=n[a]).length-1;0<=i;--i)t[i][1]!=e||r&&r!==t[i][0]||t.splice(i,1);else delete t.__levents},unbindAllEvent:function(t,e){if(!t)throw"cannot unbind events in null";var r=t.__levents;r&&delete r[e]},isBind:function(t,e,r,n){if(!t)throw"LEvent cannot have null as instance";if(t=t.__levents){if(!t.hasOwnProperty(e))return!1;for(var a=0,i=t[e].length;a<i;++a){var o=t[e][a];if(o[0]===r&&o[1]===n)return!0}return!1}},hasBind:function(t,e){if(!t)throw"LEvent cannot have null as instance";var r=t.__levents;return!!(r&&r.hasOwnProperty(e)&&r[e].length)},hasBindTo:function(t,e){if(!t)throw"LEvent cannot have null as instance";var r=t.__levents;if(!r)return!1;for(var n in r)for(var a=r[n],i=0;i<a.length;++i)if(a[i][1]===e)return!0;return!1},trigger:function(t,e,r){if(!t)throw"cannot trigger event from null";if(t.constructor===String)throw"cannot bind event to a string";if(!(t=t.__levents)||!t.hasOwnProperty(e))return!0;for(var n=0,a=(t=t[e]).length;n<a;++n){var i=t[n];if(i&&0==i[0].call(i[1],e,r))return!1}return!0},triggerArray:function(t,e,r){for(var n=0,a=t.length;n<a;++n){var i=t[n];if(!i)throw"cannot trigger event from null";if(i.constructor===String)throw"cannot bind event to a string";if((i=i.__levents)&&i.hasOwnProperty(e))for(var o=0,s=i[e].length;o<s;++o){var u=i[e][o];if(0==u[0].call(u[1],e,r))break}}return!0},extendObject:function(t){t.on=function(t,e,r){if(!e)throw"cannot bind to null callback";var n=this.__levents;this||(Object.defineProperty(this,"__levents",{value:{},enumerable:!1}),n=this.__levents),n.hasOwnProperty(t)?n[t].push([e,r]):n[t]=[[e,r]]},t.trigger=function(t,e){if(!(r=this.__levents)||!r.hasOwnProperty(t))return!0;for(var r,n=0,a=(r=r[t]).length;n<a;++n){var i=r[n];if(i&&0==i[0].call(i[1],t,e))return!1}return!0},t.unbind=function(t,e,r){if(!e)throw"cannot unbind from null callback";var n=this.__levents;if(n&&n.hasOwnProperty(t)){for(var a=0,i=n[t].length;a<i;++a){var o=n[t][a];if(o[0]===e&&o[1]===r){n[t].splice(a,1);break}}0==n[t].length&&delete n[t]}}},extendClass:function(t){this.extendObject(t.prototype)}};t.CLIP_INSIDE=r.CLIP_INSIDE=0,t.CLIP_OUTSIDE=r.CLIP_OUTSIDE=1,t.CLIP_OVERLAP=r.CLIP_OVERLAP=2,t.geo={createPlane:function(t,e){return new Float32Array([e[0],e[1],e[2],-vec3.dot(t,e)])},distancePointToPlane:function(t,e){return(vec3.dot(t,e)+e[3])/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},distance2PointToPlane:function(t,e){return(vec3.dot(t,e)+e[3])/(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},projectPointOnPlane:function(t,e,r,n){return n=n||vec3.create(),e=vec3.subtract(vec3.create(),t,e),e=vec3.dot(e,r),vec3.subtract(n,t,vec3.scale(vec3.create(),r,e))},reflectPointInPlane:function(t,e,r){return e=-(-1*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])+r[0]*t[0]+r[1]*t[1]+r[2]*t[2])/(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),vec3.fromValues(t[0]+e*r[0]*2,t[1]+e*r[1]*2,t[2]+e*r[2]*2)},testRayPlane:function(t,e,r,n,a){return r=vec3.dot(r,n)-vec3.dot(n,t),n=vec3.dot(n,e),!(Math.abs(n)<EPSILON)&&(!(0>(n=r/n))&&(a&&vec3.add(a,t,vec3.scale(a,e,n)),!0))},testSegmentPlane:function(){var t=vec3.create();return function(e,r,n,a,i){return n=vec3.dot(n,a)-vec3.dot(a,e),r=vec3.sub(t,r,e),a=vec3.dot(a,r),!(Math.abs(a)<EPSILON)&&(!(0>(a=n/a)||1<a)&&(i&&vec3.add(i,e,vec3.scale(i,r,a)),!0))}}(),testRaySphere:function(){var t=vec3.create();return function(e,r,n,a,i,o){var s=vec3.subtract(t,e,n),u=r[0]*r[0]+r[1]*r[1]+r[2]*r[2];if(0>(a=(n=2*s[0]*r[0]+2*s[1]*r[1]+2*s[2]*r[2])*n-4*u*(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]-a*a)))return!1;if(i){if((n=(u=(-n+(a=Math.sqrt(a)))*(s=1/(2*u)))<(n=(-n-a)*s)?u:n)>o)return!1;vec3.add(i,e,vec3.scale(i,r,n))}return!0}}(),testRayCylinder:function(t,e,r,n,a,i){var o=vec3.clone(t);t=vec3.add(vec3.create(),t,vec3.scale(vec3.create(),e,1e5));var s=0;e=vec3.subtract(vec3.create(),n,r);var u=vec3.subtract(vec3.create(),o,r);if(r=vec3.subtract(vec3.create(),t,o),n=vec3.dot(u,e),t=vec3.dot(r,e),e=vec3.dot(e,e),0>n&&0>n+t||n>e&&n+t>e)return!1;var c=vec3.dot(r,r),l=vec3.dot(u,r),f=(s=e*c-t*t,e*(a=vec3.dot(u,u)-a*a)-n*n);return Math.abs(s)<EPSILON?!(0<f)&&(s=0>n?-l/c:n>e?(t-l)/c:0,i&&vec3.add(i,o,vec3.scale(vec3.create(),r,s)),!0):!(0>(f=(u=e*l-t*n)*u-s*f))&&(!(0>(s=(-u-Math.sqrt(f))/s)||1<s)&&(0>n+s*t?!(0>=t)&&(s=-n/t,i&&vec3.add(i,o,vec3.scale(vec3.create(),r,s)),0>=a+2*s*(l+s*c)):n+s*t>e?!(0<=t)&&(s=(e-n)/t,i&&vec3.add(i,o,vec3.scale(vec3.create(),r,s)),0>=a+e-2*n+s*(2*(l-t)+s*c)):(i&&vec3.add(i,o,vec3.scale(vec3.create(),r,s)),!0)))},testRayBox:function(t,e,r,n,a,i){a=a||vec3.create(),i=i||Number.MAX_VALUE;var o=!0,s=new Float32Array(3),u=0,c=new Float32Array(3),l=new Float32Array(3);for(u=0;3>u;++u)t[u]<r[u]?(s[u]=1,l[u]=r[u],o=!1):t[u]>n[u]?(s[u]=0,l[u]=n[u],o=!1):s[u]=2;if(o)return vec3.copy(a,t),!0;for(u=0;3>u;++u)c[u]=2!=s[u]&&0!=e[u]?(l[u]-t[u])/e[u]:-1;for(o=0,u=1;3>u;u++)c[o]<c[u]&&(o=u);if(0>c[o]||c[o]>i)return!1;for(u=0;3>u;++u)if(o!=u){if(a[u]=t[u]+c[o]*e[u],a[u]<r[u]||a[u]>n[u])return!1}else a[u]=l[u];return!0},testRayBBox:function(t,e,r,n,a,i){if(n){var o=mat4.invert(mat4.create(),n);e=vec3.add(vec3.create(),t,e),t=vec3.transformMat4(vec3.create(),t,o),vec3.transformMat4(e,e,o),vec3.sub(e,e,t),e=vec3.normalize(e,e)}return t=this.testRayBox(t,e,r.subarray(6,9),r.subarray(9,12),a,i),n&&vec3.transformMat4(a,a,n),t},testPointBBox:function(t,e){return!(t[0]<e[6]||t[0]>e[9]||t[1]<e[7]||t[0]>e[10]||t[2]<e[8]||t[0]>e[11])},testBBoxBBox:function(t,e){if(Math.abs(e[0]-t[0])>t[3]+e[3]||Math.abs(e[1]-t[1])>t[4]+e[4]||Math.abs(e[2]-t[2])>t[5]+e[5])return!1;var r=BBox.getMin(e);return geo.testPointBBox(r,t)&&(r=BBox.getMax(e),geo.testPointBBox(r,t)),!0},testSphereBBox:function(t,e,r){for(var n=0,a=BBox.getMin(r),i=BBox.getMax(r),o=0;3>o;++o)t[o]<a[o]?n+=(r=t[o]-a[o])*r:t[o]>i[o]&&(n+=(r=t[o]-i[o])*r);return n<=e*e},closestPointBetweenLines:function(t,e,r,n,a,i){e=vec3.subtract(vec3.create(),e,t),n=vec3.subtract(vec3.create(),n,r);var o,s=vec3.subtract(vec3.create(),t,r),u=vec3.dot(e,e),c=vec3.dot(e,n),l=vec3.dot(n,n),f=vec3.dot(e,s),h=vec3.dot(n,s),d=u*l-c*c;return d<EPSILON?(o=0,u=c>l?f/c:h/l):(o=(c*h-l*f)/d,u=(u*h-c*f)/d),a&&vec3.add(a,t,vec3.scale(vec3.create(),e,o)),i&&vec3.add(i,r,vec3.scale(vec3.create(),n,u)),t=vec3.add(vec3.create(),s,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),e,o),vec3.scale(vec3.create(),n,u))),vec3.length(t)},extractPlanes:function(t,e){function r(t){var r=e.subarray(t,t+3);0!==(r=vec3.length(r))&&(r=1/r,e[t]*=r,e[t+1]*=r,e[t+2]*=r,e[t+3]*=r)}return(e=e||new Float32Array(24)).set([t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]],0),r(0),e.set([t[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]],4),r(4),e.set([t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]],8),r(8),e.set([t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]],12),r(12),e.set([t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14]],16),r(16),e.set([t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]],20),r(20),e},frustumTestBox:function(t,e){var r=0,n=0;return(r=planeBoxOverlap(t.subarray(0,4),e))==CLIP_OUTSIDE?CLIP_OUTSIDE:(n+=r,(r=planeBoxOverlap(t.subarray(4,8),e))==CLIP_OUTSIDE?CLIP_OUTSIDE:(n+=r,(r=planeBoxOverlap(t.subarray(8,12),e))==CLIP_OUTSIDE?CLIP_OUTSIDE:(n+=r,(r=planeBoxOverlap(t.subarray(12,16),e))==CLIP_OUTSIDE?CLIP_OUTSIDE:(n+=r,(r=planeBoxOverlap(t.subarray(16,20),e))==CLIP_OUTSIDE?CLIP_OUTSIDE:(n+=r,(r=planeBoxOverlap(t.subarray(20,24),e))==CLIP_OUTSIDE?CLIP_OUTSIDE:0==n+r?CLIP_INSIDE:CLIP_OVERLAP)))))},frustumTestSphere:function(t,e,r){var n,a=!1;return(n=distanceToPlane(t.subarray(0,4),e))<-r?CLIP_OUTSIDE:(n>=-r&&n<=r&&(a=!0),(n=distanceToPlane(t.subarray(4,8),e))<-r?CLIP_OUTSIDE:(n>=-r&&n<=r&&(a=!0),(n=distanceToPlane(t.subarray(8,12),e))<-r?CLIP_OUTSIDE:(n>=-r&&n<=r&&(a=!0),(n=distanceToPlane(t.subarray(12,16),e))<-r?CLIP_OUTSIDE:(n>=-r&&n<=r&&(a=!0),(n=distanceToPlane(t.subarray(16,20),e))<-r?CLIP_OUTSIDE:(n>=-r&&n<=r&&(a=!0),(n=distanceToPlane(t.subarray(20,24),e))<-r?CLIP_OUTSIDE:(n>=-r&&n<=r&&(a=!0),a?CLIP_OVERLAP:CLIP_INSIDE))))))},testPoint2DInPolygon:function(t,e){for(var r=!1,n=-1,a=t.length,i=a-1;++n<a;i=n)(t[n][1]<=e[1]&&e[1]<t[i][1]||t[i][1]<=e[1]&&e[1]<t[n][1])&&e[0]<(t[i][0]-t[n][0])*(e[1]-t[n][1])/(t[i][1]-t[n][1])+t[n][0]&&(r=!r);return r}},t.BBox=r.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},clone:function(t){return new Float32Array(t)},copy:function(t,e){return t.set(e),t},fromPoint:function(t){var e=this.create();return e.set(t,0),e.set(t,6),e.set(t,9),e},fromMinMax:function(t,e){var r=this.create();return this.setMinMax(r,t,e),r},fromCenterHalfsize:function(t,e){var r=this.create();return this.setCenterHalfsize(r,t,e),r},fromPoints:function(t){var e=this.create();return this.setFromPoints(e,t),e},setFromPoints:function(t,e){var r=t.subarray(6,9),n=t.subarray(9,12);r.set(e.subarray(0,3)),n.set(r);for(var a=0,i=3,o=e.length;i<o;i+=3)a=e.subarray(i,i+3),vec3.min(r,a,r),vec3.max(n,a,n);return r=vec3.add(t.subarray(0,3),r,n),vec3.scale(r,r,.5),vec3.subtract(t.subarray(3,6),n,r),t[12]=vec3.length(t.subarray(3,6)),t},setMinMax:function(t,e,r){t[6]=e[0],t[7]=e[1],t[8]=e[2],t[9]=r[0],t[10]=r[1],t[11]=r[2];var n=t.subarray(3,6);return vec3.sub(n,r,e),vec3.scale(n,n,.5),t[0]=r[0]-n[0],t[1]=r[1]-n[1],t[2]=r[2]-n[2],t[12]=vec3.length(t.subarray(3,6)),t},setCenterHalfsize:function(t,e,r,n){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=r[0],t[4]=r[1],t[5]=r[2],vec3.sub(t.subarray(6,9),t.subarray(0,3),t.subarray(3,6)),vec3.add(t.subarray(9,12),t.subarray(0,3),t.subarray(3,6)),t[12]=n||vec3.length(r),t},transformMat4:function(t,e,r){var n=e.subarray(3,6),a=this.tmp_corners;a.set(this.corners);for(var i=0;8>i;++i){var o=a.subarray(3*i,3*i+3);vec3.multiply(o,n,o),vec3.add(o,o,e),mat4.multiplyVec3(o,r,o)}return this.setFromPoints(t,a)},getCorners:function(t,e){var r=t.subarray(3,6),n=null;e?(e.set(this.corners),n=e):n=new Float32Array(this.corners);for(var a=0;8>a;++a){var i=n.subarray(3*a,3*a+3);vec3.multiply(i,r,i),vec3.add(i,i,t)}return n},merge:function(t,e,r){var n=t.subarray(6,9),a=t.subarray(9,12);return vec3.min(n,e.subarray(6,9),r.subarray(6,9)),vec3.max(a,e.subarray(9,12),r.subarray(9,12)),BBox.setMinMax(t,n,a)},extendToPoint:function(t,e){e[0]<t[6]?t[6]=e[0]:e[0]>t[9]&&(t[9]=e[0]),e[1]<t[7]?t[7]=e[1]:e[1]>t[10]&&(t[10]=e[1]),e[2]<t[8]?t[8]=e[2]:e[2]>t[11]&&(t[11]=e[2]);var r=t.subarray(6,9),n=t.subarray(9,12);r=vec3.add(t.subarray(0,3),r,n);return vec3.scale(r,r,.5),vec3.subtract(t.subarray(3,6),n,r),t[12]=vec3.length(t.subarray(3,6)),t},getCenter:function(t){return t.subarray(0,3)},getHalfsize:function(t){return t.subarray(3,6)},getMin:function(t){return t.subarray(6,9)},getMax:function(t){return t.subarray(9,12)},getRadius:function(t){return t[12]}},t.distanceToPlane=r.distanceToPlane=function(t,e){return vec3.dot(t,e)+t[3]},t.planeBoxOverlap=r.planeBoxOverlap=function(t,e){var r=t[3],n=(n=vec3.fromValues(Math.abs(e[3]*t[0]),Math.abs(e[4]*t[1]),Math.abs(e[5]*t[2])))[0]+n[1]+n[2];return(r=vec3.dot(t,e)+r)<=-n?CLIP_OUTSIDE:r<=n?CLIP_OVERLAP:CLIP_INSIDE},t.Octree=r.Octree=function(t){this.root=null,this.total_nodes=this.total_depth=0,t&&(this.buildFromMesh(t),this.total_nodes=this.trim())},Octree.MAX_NODE_TRIANGLES_RATIO=.1,Octree.MAX_OCTREE_DEPTH=8,Octree.OCTREE_MARGIN_RATIO=.01,Octree.OCTREE_MIN_MARGIN=.1,Octree.prototype.buildFromMesh=function(t){this.total_nodes=this.total_depth=0;var e=t.getBuffer("vertices").data;(t=t.getIndexBuffer("triangles"))&&(t=t.data);var r=this.computeAABB(e);this.root=r,this.total_nodes=1,this.total_triangles=t?t.length/3:e.length/9,this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var n=vec3.create();if(vec3.scale(n,r.size,Octree.OCTREE_MARGIN_RATIO),n[0]<Octree.OCTREE_MIN_MARGIN&&(n[0]=Octree.OCTREE_MIN_MARGIN),n[1]<Octree.OCTREE_MIN_MARGIN&&(n[1]=Octree.OCTREE_MIN_MARGIN),n[2]<Octree.OCTREE_MIN_MARGIN&&(n[2]=Octree.OCTREE_MIN_MARGIN),vec3.sub(r.min,r.min,n),vec3.add(r.max,r.max,n),r.faces=[],r.inside=0,t)for(n=0;n<t.length;n+=3){var a=new Float32Array([e[3*t[n]],e[3*t[n]+1],e[3*t[n]+2],e[3*t[n+1]],e[3*t[n+1]+1],e[3*t[n+1]+2],e[3*t[n+2]],e[3*t[n+2]+1],e[3*t[n+2]+2]]);this.addToNode(a,r,0)}else for(n=0;n<e.length;n+=9)a=new Float32Array(e.subarray(n,n+9)),this.addToNode(a,r,0);return r},Octree.prototype.addToNode=function(t,e,r){if(e.inside+=1,e.c){var n,a=this.computeAABB(t),i=!1;for(n in e.c){var o=e.c[n];if(Octree.isInsideAABB(a,o)){this.addToNode(t,o,r+1),i=!0;break}}i||(null==e.faces&&(e.faces=[]),e.faces.push(t))}else if(null==e.faces&&(e.faces=[]),e.faces.push(t),e.faces.length>this.max_node_triangles&&r<Octree.MAX_OCTREE_DEPTH){this.splitNode(e),this.total_depth<r+1&&(this.total_depth=r+1);var s=e.faces.concat();for(n in e.faces=null,s){t=s[n];var u;a=this.computeAABB(t),i=!1;for(u in e.c)if(o=e.c[u],Octree.isInsideAABB(a,o)){this.addToNode(t,o,r+1),i=!0;break}i||(null==e.faces&&(e.faces=[]),e.faces.push(t))}}},Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],Octree.prototype.splitNode=function(t){t.c=[];var e,r=[.5*(t.max[0]-t.min[0]),.5*(t.max[1]-t.min[1]),.5*(t.max[2]-t.min[2])];for(e in this.octree_pos_ref){var n=this.octree_pos_ref[e],a={};this.total_nodes+=1,a.min=[t.min[0]+r[0]*n[0],t.min[1]+r[1]*n[1],t.min[2]+r[2]*n[2]],a.max=[a.min[0]+r[0],a.min[1]+r[1],a.min[2]+r[2]],a.faces=null,a.inside=0,t.c.push(a)}},Octree.prototype.computeAABB=function(t){for(var e=new Float32Array([t[0],t[1],t[2]]),r=new Float32Array([t[0],t[1],t[2]]),n=0;n<t.length;n+=3)for(var a=0;3>a;a++)e[a]>t[n+a]&&(e[a]=t[n+a]),r[a]<t[n+a]&&(r[a]=t[n+a]);return{min:e,max:r,size:vec3.sub(vec3.create(),r,e)}},Octree.prototype.trim=function(t){if(!(t=t||this.root).c)return 1;for(var e=1,r=[],n=t.c,a=0;a<n.length;++a)n[a].inside&&(r.push(n[a]),e+=this.trim(n[a]));return t.c=r,e},Octree.prototype.testRay=function(){var t=vec3.create(),e=vec3.create(),r=vec3.create(),n=vec3.create();return function(a,i,o,s){if(!this.root)throw"Error: octree not build";return t.set(a),e.set(i),r.set(this.root.min),n.set(this.root.max),(o=Octree.hitTestBox(t,e,r,n))&&null!=(o=Octree.testRayInNode(this.root,t,e))?(i=vec3.scale(vec3.create(),i,o.t),vec3.add(i,i,a),o.pos=i,o):null}}(),Octree.prototype.testSphere=function(t,e){if(t=vec3.clone(t),!this.root)throw"Error: octree not build";var r=e*e;return!!Octree.testSphereBox(t,r,vec3.clone(this.root.min),vec3.clone(this.root.max))&&Octree.testSphereInNode(this.root,t,r)},Octree.testRayInNode=function(t,e,r){var n=null,a=null;if(t.faces)for(var i=0,o=t.faces.length;i<o;++i){var s=t.faces[i];null!=(n=Octree.hitTestTriangle(e,r,s.subarray(0,3),s.subarray(3,6),s.subarray(6,9)))&&(n.face=s,a?a.mergeWith(n):a=n)}var u;o=vec3.create(),s=vec3.create();if(t.c)for(i=0;i<t.c.length;++i)u=t.c[i],o.set(u.min),s.set(u.max),null==(n=Octree.hitTestBox(e,r,o,s))||a&&n.t>a.t||null!=(n=Octree.testRayInNode(u,e,r))&&(a?a.mergeWith(n):a=n);return a},Octree.testSphereInNode=function(t,e,r){if(t.faces)for(var n=0,a=t.faces.length;n<a;++n){var i=t.faces[n];if(Octree.testSphereTriangle(e,r,i.subarray(0,3),i.subarray(3,6),i.subarray(6,9)))return!0}var o;a=vec3.create(),i=vec3.create();if(t.c)for(n=0;n<t.c.length;++n)if(o=t.c[n],a.set(o.min),i.set(o.max),Octree.testSphereBox(e,r,a,i)&&Octree.testSphereInNode(o,e,r))return!0;return!1},Octree.isInsideAABB=function(t,e){return!(t.min[0]<e.min[0]||t.min[1]<e.min[1]||t.min[2]<e.min[2]||t.max[0]>e.max[0]||t.max[1]>e.max[1]||t.max[2]>e.max[2])},Octree.hitTestBox=function(){var t=vec3.create(),e=vec3.create(),r=vec3.create(),n=vec3.create(),a=vec3.create(),i=vec3.create(),o=vec3.fromValues(1e-6,1e-6,1e-6);return function(s,u,c,l){if(vec3.subtract(t,c,s),vec3.subtract(e,l,s),0>vec3.maxValue(t)&&0<vec3.minValue(e))return new HitTest(0,s,u);r[0]=1/u[0],r[1]=1/u[1],r[2]=1/u[2],vec3.multiply(t,t,r),vec3.multiply(e,e,r),vec3.min(n,t,e),vec3.max(a,t,e);var f=vec3.maxValue(n),h=vec3.minValue(a);return 0<f&&f<h?(s=vec3.add(vec3.create(),vec3.scale(i,u,f),s),vec3.add(c,c,o),vec3.subtract(c,c,o),new HitTest(f,s,vec3.fromValues((s[0]>l[0])-(s[0]<c[0]),(s[1]>l[1])-(s[1]<c[1]),(s[2]>l[2])-(s[2]<c[2])))):null}}(),Octree.hitTestTriangle=function(){var t=vec3.create(),e=vec3.create(),r=vec3.create(),n=vec3.create();return function(a,i,o,s,u){if(vec3.subtract(t,s,o),vec3.subtract(e,u,o),s=vec3.cross(vec3.create(),t,e),vec3.normalize(s,s),0<vec3.dot(s,i))return null;if(0<(u=vec3.dot(s,vec3.subtract(n,o,a))/vec3.dot(s,i))){i=vec3.scale(vec3.create(),i,u),vec3.add(i,i,a),vec3.subtract(r,i,o),a=vec3.dot(e,e),o=vec3.dot(e,t);var c=vec3.dot(e,r),l=vec3.dot(t,t),f=vec3.dot(t,r),h=a*l-o*o;if(a=(a*f-o*c)/h,0<=(l=(l*c-o*f)/h)&&0<=a&&1>=l+a)return new HitTest(u,i,s)}return null}}(),Octree.testSphereTriangle=function(){var t=vec3.create(),e=vec3.create(),r=vec3.create(),n=vec3.create(),a=vec3.create(),i=vec3.create(),o=vec3.create(),s=vec3.create();return function(u,c,l,f,h){vec3.sub(t,l,u),vec3.sub(e,f,u),vec3.sub(r,h,u),vec3.sub(n,e,t),vec3.sub(a,r,t),vec3.cross(s,n,a),u=(u=vec3.dot(t,s))*u>c*(l=vec3.dot(s,s));var d=vec3.dot(t,t),_=vec3.dot(t,e),v=vec3.dot(t,r),p=vec3.dot(e,e),m=vec3.dot(e,r);l=d>c&_>d&v>d,f=p>c&_>p&m>p,h=(E=vec3.dot(r,r))>c&v>E&m>E;d=_-d,_=m-p;var g=v-E;vec3.sub(i,r,e),vec3.sub(o,t,r),p=vec3.dot(n,n),E=vec3.dot(i,i),v=vec3.dot(o,o),m=vec3.scale(vec3.create(),t,p),vec3.sub(m,m,vec3.scale(vec3.create(),n,d)),d=vec3.scale(vec3.create(),e,E),vec3.sub(d,d,vec3.scale(vec3.create(),i,_)),_=vec3.scale(vec3.create(),r,v),vec3.sub(_,_,vec3.scale(vec3.create(),o,g));var E,x=vec3.scale(vec3.create(),r,p),T=(x=vec3.sub(x,x,m),vec3.scale(vec3.create(),t,E));T=vec3.sub(T,T,d),g=vec3.scale(vec3.create(),e,v),g=vec3.sub(g,g,_);return!(u|l|f|h|(p=vec3.dot(m,m)>c*p*p&0<vec3.dot(m,x))|(E=vec3.dot(d,d)>c*E*E&0<vec3.dot(d,T))|(c=vec3.dot(_,_)>c*v*v&0<vec3.dot(_,g)))}}(),Octree.testSphereBox=function(t,e,r,n){for(var a,i=0,o=0;3>o;++o)t[o]<r[o]?i+=(a=t[o]-r[o])*a:t[o]>n[o]&&(i+=(a=t[o]-n[o])*a);return i<=e},t.HitTest=r.HitTest=function(t,e,r){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=e,this.normal=r,this.face=null},HitTest.prototype={mergeWith:function(t){0<t.t&&t.t<this.t&&(this.t=t.t,this.hit=t.hit,this.normal=t.normal,this.face=t.face)}},t.Raytracer=r.Raytracer=function(t,e){this.viewport=vec4.create(),this.ray00=vec3.create(),this.ray10=vec3.create(),this.ray01=vec3.create(),this.ray11=vec3.create(),this.eye=vec3.create(),this.setup(t,e)},Raytracer.prototype.setup=function(t,e){e=e||gl.viewport_data,this.viewport.set(e);var r=e[0],n=r+e[2],a=e[1],i=a+e[3];vec3.set(this.ray00,r,a,1),vec3.set(this.ray10,n,a,1),vec3.set(this.ray01,r,i,1),vec3.set(this.ray11,n,i,1),vec3.unproject(this.ray00,this.ray00,t,e),vec3.unproject(this.ray10,this.ray10,t,e),vec3.unproject(this.ray01,this.ray01,t,e),vec3.unproject(this.ray11,this.ray11,t,e),r=this.eye,vec3.unproject(r,r,t,e),vec3.subtract(this.ray00,this.ray00,r),vec3.subtract(this.ray10,this.ray10,r),vec3.subtract(this.ray01,this.ray01,r),vec3.subtract(this.ray11,this.ray11,r)},Raytracer.prototype.getRayForPixel=function(){var t=vec3.create(),e=vec3.create();return function(r,n,a){return a=a||vec3.create(),r=(r-this.viewport[0])/this.viewport[2],n=1-(n-this.viewport[1])/this.viewport[3],vec3.lerp(t,this.ray00,this.ray10,r),vec3.lerp(e,this.ray01,this.ray11,r),vec3.lerp(a,t,e,n),vec3.normalize(a,a)}}();var _=mat4.create();Raytracer.hitTestBox=function(t,e,r,n,a){var i=new Float32Array(30);a&&(a=mat4.invert(_,a),t=mat4.multiplyVec3(i.subarray(3,6),a,t),e=mat4.rotateVec3(i.subarray(6,9),a,e));var o=vec3.subtract(i.subarray(9,12),r,t);vec3.divide(o,o,e);var s=vec3.subtract(i.subarray(12,15),n,t);return vec3.divide(s,s,e),a=vec3.min(i.subarray(15,18),o,s),o=vec3.max(i.subarray(18,21),o,s),a=vec3.maxValue(a),o=vec3.minValue(o),0<a&&a<=o?(e=vec3.scale(i.subarray(21,24),e,a),vec3.add(e,t,e),vec3.addValue(i.subarray(24,27),r,1e-6),vec3.subValue(i.subarray(27,30),n,1e-6),new HitTest(a,e,vec3.fromValues((e[0]>n[0])-(e[0]<r[0]),(e[1]>n[1])-(e[1]<r[1]),(e[2]>n[2])-(e[2]<r[2])))):null},Raytracer.hitTestSphere=function(t,e,r,n){var a=vec3.subtract(vec3.create(),t,r),i=vec3.dot(e,e),o=2*vec3.dot(e,a);return 0<(a=o*o-4*i*(a=vec3.dot(a,a)-n*n))?(i=(-o-Math.sqrt(a))/(2*i),t=vec3.add(vec3.create(),t,vec3.scale(vec3.create(),e,i)),new HitTest(i,t,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),t,r),1/n))):null},Raytracer.hitTestTriangle=function(t,e,r,n,a){var i=vec3.subtract(vec3.create(),n,r),o=vec3.subtract(vec3.create(),a,r);if(a=vec3.cross(vec3.create(),i,o),vec3.normalize(a,a),0<(n=vec3.dot(a,vec3.subtract(vec3.create(),r,t))/vec3.dot(a,e))){t=vec3.add(vec3.create(),t,vec3.scale(vec3.create(),e,n));var s=vec3.subtract(vec3.create(),t,r);r=vec3.dot(o,o),e=vec3.dot(o,i);o=vec3.dot(o,s);var u=((u=vec3.dot(i,i))*o-e*(i=vec3.dot(i,s)))/(s=r*u-e*e);i=(r*i-e*o)/s;if(0<=u&&0<=i&&1>=u+i)return new HitTest(n,t,a)}return null},Mesh.parseOBJ=function(t,e){for(var r=[],n=[],a=[],i=[],o=[],s=[],u=[],c={},l=0,f=null,h=null,d=0,_=0,v=h=0,p=0,m=0,g=null,E=!1,x=!1,T=!1,b=!1,y=0,A=(e=e||{}).noindex?e.noindex:1e7<t.length,w=e.flipAxis,M=w||e.flipNormals,R=null,F=[],S=t.split("\n"),B=S.length,C=0;C<B;++C)if("#"!=(f=S[C].replace(/[ \t]+/g," ").replace(/\s\s*$/,""))[0]&&""!=f)if(g=f.split(" "),b&&"v"==g[0]&&(b=!1),"v"==g[0])w?o.push(-1*parseFloat(g[1]),parseFloat(g[3]),parseFloat(g[2])):o.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]));else if("vt"==g[0])s.push(parseFloat(g[1]),parseFloat(g[2]));else if("vn"==g[0])M?u.push(-parseFloat(g[2]),-parseFloat(g[3]),parseFloat(g[1])):u.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]));else if("f"==g[0]){if(b=!0,!(4>g.length)){var I=[];for(f=1;f<g.length;++f){if(!(g[f]in c)||A){if(1==(h=g[f].split("/")).length)h=_=d=parseInt(h[0])-1;else if(2==h.length)d=parseInt(h[0])-1,_=parseInt(h[1])-1,h=-1;else{if(3!=h.length)return console.err("Problem parsing: unknown number of values per face"),!1;d=parseInt(h[0])-1,_=parseInt(h[1])-1,h=parseInt(h[2])-1}3<f&&A&&(v=r.length,r.push(r[v-9*(f-3)],r[v-9*(f-3)+1],r[v-9*(f-3)+2]),r.push(r[v-3],r[v-2],r[v-1]),v=n.length,n.push(n[v-6*(f-3)],n[v-6*(f-3)+1]),n.push(n[v-2],n[v-1]),v=a.length,a.push(a[v-9*(f-3)],a[v-9*(f-3)+1],a[v-9*(f-3)+2]),a.push(a[v-3],a[v-2],a[v-1])),m=p=v=0,3*d+2<o.length&&(E=!0,v=o[3*d+0],p=o[3*d+1],m=o[3*d+2]),r.push(v,p,m),p=v=0,2*_+1<s.length&&(x=!0,v=s[2*_+0],p=s[2*_+1]),n.push(v,p),p=v=0,m=1,-1!=h&&(3*h+2<u.length&&(T=!0,v=u[3*h+0],p=u[3*h+1],m=u[3*h+2]),a.push(v,p,m)),A||(c[g[f]]=l++)}A||(d=c[g[f]],I.push(d),y<d&&(y=d))}if(!A)for(f=2;f<I.length;f++)i.push(I[0],I[f-1],I[f])}}else"g"==g[0]||"usemtl"==g[0]?1<g.length&&(null!=R&&(R.length=i.length-R.start,0<R.length&&F.push(R)),R={name:g[1],start:i.length,length:-1,material:""}):"usemtl"==g[0]&&R&&(R.material=g[1]);if(!o.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;if(R&&1<i.length-R.start&&(R.length=i.length-R.start,F.push(R)),(65536<y||A)&&0<i.length){for(console.log("Deindexing mesh..."),o=new Float32Array(3*i.length),s=a&&a.length?new Float32Array(3*i.length):null,u=n&&n.length?new Float32Array(2*i.length):null,f=0;f<i.length;f+=1)o.set(r.slice(3*i[f],3*i[f]+3),3*f),s&&s.set(a.slice(3*i[f],3*i[f]+3),3*f),u&&u.set(n.slice(2*i[f],2*i[f]+2),2*f);r=o,s&&(a=s),u&&(n=u),i=null}return f={},E&&(f.vertices=new Float32Array(r)),T&&0<a.length&&(f.normals=new Float32Array(a)),x&&0<n.length&&(f.coords=new Float32Array(n)),i&&0<i.length&&(f.triangles=new Uint16Array(i)),r={},1<F.length&&(r.groups=F),f.info=r,F=null,(F=Mesh.load(f,null,e.mesh)).updateBounding(),F},Mesh.parsers.obj=Mesh.parseOBJ.bind(Mesh),Mesh.encoders.obj=function(t,e){if(!(n=t.getBuffer("vertices")))return null;for(var r="# Generated with liteGL.js by Javi Agenjo\n\n",n=n.data,a=0;a<n.length;a+=3)r+="v "+n[a].toFixed(4)+" "+n[a+1].toFixed(4)+" "+n[a+2].toFixed(4)+"\n";if(a=t.getBuffer("normals")){r=r+"\n";var i=a.data;for(a=0;a<i.length;a+=3)r+="vn "+i[a].toFixed(4)+" "+i[a+1].toFixed(4)+" "+i[a+2].toFixed(4)+"\n"}if(a=t.getBuffer("coords"))for(r+="\n",i=a.data,a=0;a<i.length;a+=2)r+="vt "+i[a].toFixed(4)+" "+i[a+1].toFixed(4)+"  0.0000\n";if(r+="\ng mesh\n",a=t.getIndexBuffer("triangles"))for(n=a.data,a=0;a<n.length;a+=3)r+="f "+(n[a]+1)+"/"+(n[a]+1)+"/"+(n[a]+1)+" "+(n[a+1]+1)+"/"+(n[a+1]+1)+"/"+(n[a+1]+1)+" "+(n[a+2]+1)+"/"+(n[a+2]+1)+"/"+(n[a+2]+1)+"\n";else for(a=0;a<n.length/3;a+=3)r+="f "+(a+1)+"/"+(a+1)+"/"+(a+1)+" "+(a+2)+"/"+(a+2)+"/"+(a+2)+" "+(a+3)+"/"+(a+3)+"/"+(a+3)+"\n";return r}}("undefined"!=typeof window?window:"undefined"!=typeof self?self:global),"undefined"==typeof GL)throw"litegl.js must be included to use enableWebGLCanvas";export default function enableWebGLCanvas(t,e){var r;if(e=e||{},t.is_webgl)r=t.gl;else{e.canvas=t,e.alpha=!0,e.stencil=!0;try{r=GL.create(e)}catch(n){return console.log("This canvas cannot be used as WebGL, maybe WebGL is not supported or this canvas has already a 2D context associated"),r=t.getContext("2d",e)}}if(t.canvas2DtoWebGL_enabled)return r;t.canvas2DtoWebGL_enabled=!0;var n=null,a=t.ctx=r;a.WebGLCanvas={};vec4.fromValues(1,1,1,1);var i=0,o=new Float32Array(3e4),s=new GL.Mesh,u=s.createVertexBuffer("vertices",null,null,o,r.STREAM_DRAW),c=GL.Mesh.getScreenQuad(),l=GL.Mesh.circle({size:1}),f=mat4.create(),h=void 0!==e.anisotropic?e.anisotropic:2,d={u_texture:0},_={};e.allow3D&&(_.EXTRA_PROJECTION="");var v=r.WebGLCanvas.textures_atlas={};r.WebGLCanvas.clearAtlas=function(){v=r.WebGLCanvas.textures_atlas={}};var p=null,m=null,g=null,E=null,x=null,T=null,b=null,y=null,A=null,w=null;function M(){p="\n\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tuniform vec2 u_viewport;\n\t\t\t\tuniform mat3 u_transform;\n\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\tuniform bool u_projection_enabled;\n\t\t\t\t\tuniform mat4 u_projection;\n\t\t\t\t#endif\n\t\t\t\tvarying float v_visible;\n\t\t\t\tvoid main() { \n\t\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\t\tv_visible = pos.z;\n\t\t\t\t\tpos = u_transform * vec3(pos.xy,1.0);\n\t\t\t\t\tpos.z = 0.0;\n\t\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\t\tif(u_projection_enabled)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tgl_Position = u_projection * vec4(pos.xy,0.0,1.0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\t//normalize\n\t\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t\t}\n\t\t\t\t",m="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\tuniform bool u_projection_enabled;\n\t\t\t\tuniform mat4 u_projection;\n\t\t\t#endif\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\tif(u_projection_enabled)\n\t\t\t\t\t{\n\t\t\t\t\t\tgl_Position = u_projection * vec4(pos.xy,0.0,1.0);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t",g=new GL.Shader(m,"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t",_),E=new GL.Shader(m,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = u_color * texture2D( u_texture, v_coord );\n\t\t\t\t}\n\t\t\t",_),x=new GL.Shader(m,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color * texture2D( u_texture, v_coord );\n\t\t\t\t\tif(color.a <= 0.0)\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\tgl_FragColor = color;\n\t\t\t\t}\n\t\t\t",_),T=new GL.Shader(p,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying float v_visible;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t\tif (v_visible == 0.0)\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\tgl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t",_),b=new GL.Shader(GL.Shader.QUAD_VERTEX_SHADER,"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform vec4 u_texture_transform;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);\n\t\t\t\t\tuv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);\n\t\t\t\t\tuv = clamp(uv,vec2(0.0),vec2(1.0));\n\t\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t\t}\n\t\t\t",_),y=new GL.Shader(p,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying float v_visible;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tuniform vec4 u_texture_transform;\n\t\t\t\tuniform vec2 u_viewport;\n\t\t\t\tuniform mat3 u_itransform;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;\n\t\t\t\t\tpos *= vec2( (u_viewport.x * u_texture_transform.z), (u_viewport.y * u_texture_transform.w) );\n\t\t\t\t\tvec2 uv = fract(pos / u_viewport) + u_texture_transform.xy;\n\t\t\t\t\tuv.y = 1.0 - uv.y;\n\t\t\t\t\tgl_FragColor = u_color * texture2D( u_texture, uv);\n\t\t\t\t}\n\t\t\t",_),A=new GL.Shader(p,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying float v_visible;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tuniform vec4 u_gradient;\n\t\t\t\tuniform vec2 u_viewport;\n\t\t\t\tuniform mat3 u_itransform;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;\n\t\t\t\t\t//vec2 pos = vec2( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t);\n\t\t\t\t\tvec2 AP = pos - u_gradient.xy;\n\t\t\t\t\tvec2 AB = u_gradient.zw - u_gradient.xy;\n\t\t\t\t\tfloat dotAPAB = dot(AP,AB);\n\t\t\t\t\tfloat dotABAB = dot(AB,AB);\n\t\t\t\t\tfloat x = dotAPAB / dotABAB;\n\t\t\t\t\tvec2 uv = vec2( x, 0.0 );\n\t\t\t\t\tgl_FragColor = u_color * texture2D( u_texture, uv );\n\t\t\t\t}\n\t\t\t",_);w=new GL.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\tuniform bool u_projection_enabled;\n\t\t\t\tuniform mat4 u_projection;\n\t\t\t#endif\n\t\t\tuniform float u_pointSize;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\tif(u_projection_enabled)\n\t\t\t\t\t{\n\t\t\t\t\t\tgl_Position = u_projection * vec4(pos.xy,0.0,1.0);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t\tgl_PointSize = ceil(u_pointSize);\n\t\t\t\tv_coord = a_coord;\n\t\t\t}\n\t\t\t","\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_iCharSize;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform float u_pointSize;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform vec2 u_angle_sincos;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2(1.0 - gl_PointCoord.s, gl_PointCoord.t);\n\t\t\t\tuv = vec2( ((uv.y - 0.5) * u_angle_sincos.y - (uv.x - 0.5) * u_angle_sincos.x) + 0.5, ((uv.x - 0.5) * u_angle_sincos.y + (uv.y - 0.5) * u_angle_sincos.x) + 0.5);\n\t\t\t\tuv = v_coord - uv * u_iCharSize + vec2(u_iCharSize*0.5);\n\t\t\t\tuv.y = 1.0 - uv.y;\n\t\t\t\tgl_FragColor = vec4(u_color.xyz, u_color.a * texture2D(u_texture, uv, -1.0  ).a);\n\t\t\t}\n\t\t\t",_)}r.WebGLCanvas.set3DMatrix=function(t){t?f.set(t):mat4.identity(f),null==_.EXTRA_PROJECTION&&(_.EXTRA_PROJECTION="",M(),d.u_projection=f),d.u_projection_enabled=!!t},M(),a.createImageShader=function(t){return new GL.Shader(GL.Shader.QUAD_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_transform;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);\n\t\t\t\tuv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);\n\t\t\t\tuv = clamp(uv,vec2(0.0),vec2(1.0));\n\t\t\t\tvec4 color = u_color * texture2D(u_texture, uv);\n\t\t\t\t"+t+";\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t",_)},a.WebGLCanvas.vertex_shader=p,a._matrix=mat3.create();var R=mat3.create(),F=vec2.create(),S=vec4.create(),B=vec4.create(),C=vec2.create();a._stack=[],a._stack_size=0;var I=0,N=a.viewport_data.subarray(2,4);a.translate=function(t,e){F[0]=t,F[1]=e,mat3.translate(this._matrix,this._matrix,F)},a.rotate=function(t){mat3.rotate(this._matrix,this._matrix,t),I+=t},a.scale=function(t,e){F[0]=t,F[1]=e,mat3.scale(this._matrix,this._matrix,F)},a.resetTransform=function(){r._stack_size=0,this._matrix.set([1,0,0,0,1,0,0,0,1]),I=0},a.save=function(){if(!(this._stack_size>=32)){var t=null;t=this._stack_size==this._stack.length?this._stack[this._stack_size]={matrix:mat3.create(),fillColor:vec4.create(),strokeColor:vec4.create(),shadowColor:vec4.create(),globalAlpha:1,font:"",fontFamily:"",fontSize:14,fontMode:"",textAlign:"",clip_level:0}:this._stack[this._stack_size],this._stack_size++,t.matrix.set(this._matrix),t.fillColor.set(this._fillcolor),t.strokeColor.set(this._strokecolor),t.shadowColor.set(this._shadowcolor),t.globalAlpha=this._globalAlpha,t.font=this._font,t.fontFamily=this._font_family,t.fontSize=this._font_size,t.fontMode=this._font_mode,t.textAlign=this.textAlign,t.clip_level=this.clip_level}},a.restore=function(){if(0==this._stack_size)return mat3.identity(this._matrix),void(I=0);this._stack_size--;var t=this._stack[this._stack_size];this._matrix.set(t.matrix),this._fillcolor.set(t.fillColor),this._strokecolor.set(t.strokeColor),this._shadowcolor.set(t.shadowColor),this._globalAlpha=t.globalAlpha,this._font=t.font,this._font_family=t.fontFamily,this._font_size=t.fontSize,this._font_mode=t.fontMode,this.textAlign=t.textAlign;var e=this.clip_level;this.clip_level=t.clip_level,I=Math.atan2(this._matrix[3],this._matrix[4]),e==this.clip_level||(0==this.clip_level?(r.enable(r.STENCIL_TEST),r.clearStencil(0),r.clear(r.STENCIL_BUFFER_BIT),r.disable(r.STENCIL_TEST)):(r.stencilFunc(r.LEQUAL,this.clip_level,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)))},a.clip=function(){this.clip_level,this.clip_level++,r.colorMask(!1,!1,!1,!1),r.depthMask(!1),r.enable(r.STENCIL_TEST),r.stencilFunc(r.EQUAL,this.clip_level-1,255),r.stencilOp(r.KEEP,r.KEEP,r.INCR),this.fill(),r.colorMask(!0,!0,!0,!0),r.depthMask(!0),r.stencilFunc(r.EQUAL,this.clip_level,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)},a.clipImage=function(t,e,n,a,i){this.clip_level++,r.colorMask(!1,!1,!1,!1),r.depthMask(!1),r.enable(r.STENCIL_TEST),r.stencilFunc(r.EQUAL,this.clip_level-1,255),r.stencilOp(r.KEEP,r.KEEP,r.INCR),this.drawImage(t,e,n,a,i,x),r.colorMask(!0,!0,!0,!0),r.depthMask(!0),r.stencilFunc(r.EQUAL,this.clip_level,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)},a.transform=function(t,e,r,n,a,i){var o=R;o[0]=t,o[1]=e,o[2]=0,o[3]=r,o[4]=n,o[5]=0,o[6]=a,o[7]=i,o[8]=1,mat3.multiply(this._matrix,this._matrix,o),I=Math.atan2(this._matrix[0],this._matrix[1])},a.setTransform=function(t,e,r,n,a,i){var o=this._matrix;o[0]=t,o[1]=e,o[2]=0,o[3]=r,o[4]=n,o[5]=0,o[6]=a,o[7]=i,o[8]=1,I=Math.atan2(this._matrix[0],this._matrix[1])};function O(t){var e=null;if(t.constructor===GL.Texture)return t._context_id==r.context_id?t:null;if(t.gl||(t.gl={}),t.src){var n=r.REPEAT;return(e=t.gl[r.context_id])?(t.mustUpdate&&(e.uploadData(t),t.mustUpdate=!1),e):t.gl[r.context_id]=GL.Texture.fromImage(t,{magFilter:r.LINEAR,minFilter:r.LINEAR_MIPMAP_LINEAR,wrap:n,ignore_pot:!0,premultipliedAlpha:!0,anisotropic:h})}return(e=t.gl[r.context_id])?(t.mustUpdate&&(e.uploadData(t),t.mustUpdate=!1),e):t.gl[r.context_id]=GL.Texture.fromImage(t,{minFilter:r.LINEAR,magFilter:r.LINEAR,anisotropic:h})}function D(t,e,r,n){this.id=a._last_gradient_id++%a._max_gradients,this.points=new Float32Array([t,e,r,n]),this.stops=[],this._must_update=!0}a.drawImage=function(t,e,n,a,i,o){if(t){var s=t.videoWidth||t.width,u=t.videoHeight||t.height;if(0!=s&&0!=u){var l=O(t);l&&(9==arguments.length?(B.set([e/s,n/u,a/s,i/u]),e=arguments[5],n=arguments[6],a=arguments[7],i=arguments[8],o=b):B.set([0,0,1,1]),F[0]=e,F[1]=n,C[0]=void 0===a?l.width:a,C[1]=void 0===i?l.height:i,l.bind(0),l!==t&&r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.imageSmoothingEnabled?r.LINEAR:r.NEAREST),this.tintImages||(S[0]=S[1]=S[2]=1,S[3]=this._globalAlpha),d.u_color=this.tintImages?this._fillcolor:S,d.u_position=F,d.u_size=C,d.u_transform=this._matrix,d.u_texture_transform=B,d.u_viewport=N,(o=o||E).uniforms(d).draw(c),f[14]-=.001)}}},a.createPattern=function(t){return O(t)},a._last_gradient_id=0,a._max_gradients=16,a._gradients_pool=[],D.prototype.addColorStop=function(t,e){var r=hexColorToRGBA(e),n=new Uint8Array(4);n[0]=255*Math.clamp(r[0],0,1),n[1]=255*Math.clamp(r[1],0,1),n[2]=255*Math.clamp(r[2],0,1),n[3]=255*Math.clamp(r[3],0,1),this.stops.push([t,n]),this.stops.sort((function(t,e){return t[0]>e[0]?1:e[0]>t[0]?-1:0})),this._must_update=!0},D.prototype.toTexture=function(){if(this._texture||(-1!=this.id&&(this._texture=a._gradients_pool[this.id]),this._texture||(this._texture=new GL.Texture(128,1,{format:r.RGBA,magFilter:r.LINEAR,wrap:r.CLAMP_TO_EDGE,minFilter:r.NEAREST}),-1!=this.id&&(a._gradients_pool[this.id]=this._texture))),!this._must_update)return this._texture;if(this._must_update=!1,this.stops.length<1)return this._texture;if(this.stops.length<2)return this._texture.fill(this.stops[0][1]),this._texture;for(var t=0,e=this.stops[t],n=this.stops[t+1],i=new Uint8Array(512),o=0;o<128;o+=1){var s=i.subarray(4*o,4*o+4),u=o/128;if(e[0]>u)if(0==t)s.set(e[1]);else{if(t+=1,e=this.stops[t],!(n=this.stops[t+1]))break;o-=1}else if(e[0]<=u&&u<n[0]){var c=(u-e[0])/(n[0]-e[0]);vec4.lerp(s,e[1],n[1],c)}else if(n[0]<=u){if(t+=1,e=this.stops[t],!(n=this.stops[t+1]))break;o-=1}}if(o<128)for(var l=o;l<128;l+=1)i.set(e[1],4*l);return this._texture.uploadData(i),this._texture},a.createLinearGradient=function(t,e,r,n){return new D(t,e,r,n)},a.beginPath=function(){i=0},a.closePath=function(){i<3||(o[i]=o[0],o[i+1]=o[1],o[i+2]=1,i+=3)},a.moveTo=function(t,e){0==i?(o[i]=t,o[i+1]=e,o[i+2]=1,i+=3):(o[i]=o[i-3],o[i+1]=o[i-2],o[i+2]=0,o[i+=3]=t,o[i+1]=e,o[i+2]=0,i+=3)},a.lineTo=function(t,e){o[i]=t,o[i+1]=e,o[i+2]=1,i+=3},a.bezierCurveTo=function(t,e,r,n,a,s){if(!(i<3))for(var u=[[o[i-3],o[i-2]],[t,e],[r,n],[a,s]],c=0;c<=50;c++){var l,f,h,d,_,v,p,m,g=c/50;h=3*(u[1][0]-u[0][0]),f=3*(u[2][0]-u[1][0])-h,l=u[3][0]-u[0][0]-h-f,v=3*(u[1][1]-u[0][1]),_=3*(u[2][1]-u[1][1])-v,d=u[3][1]-u[0][1]-v-_;var E=l*(m=(p=g*g)*g)+f*p+h*g+u[0][0],x=d*m+_*p+v*g+u[0][1];o[i]=E,o[i+1]=x,o[i+2]=1,i+=3}},a.quadraticCurveTo=function(t,e,r,n){if(!(i<3))for(var a=o[i-3],s=o[i-2],u=0;u<=50;u++){var c=u/50,l=1-c,f=a*l+t*c,h=s*l+e*c,d=t*l+r*c,_=e*l+n*c;o[i]=f*l+d*c,o[i+1]=h*l+_*c,o[i+2]=1,i+=3}},a.fill=function(){if(!(i<9)){u.uploadRange(0,4*i),d.u_viewport=N;var t=T;this._shadowcolor[3]>0&&(d.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),t.uniforms(d).drawRange(s,r.TRIANGLE_FAN,0,i/3),this.restore()),d.u_color=this._fillcolor,d.u_transform=this._matrix;var e=this._fillStyle;if(e.constructor===D){var n=e,a=n.toTexture();d.u_color=[1,1,1,this.globalAlpha],d.u_gradient=n.points,d.u_texture=0,d.u_itransform=mat3.invert(R,this._matrix),a.bind(0),t=A}else if(e.constructor===GL.Texture){a=e;d.u_color=[1,1,1,this._globalAlpha],d.u_texture=0,S.set([0,0,1/a.width,1/a.height]),d.u_texture_transform=S,d.u_itransform=mat3.invert(R,this._matrix),a.bind(0),t=y}t.uniforms(d).drawRange(s,r.TRIANGLE_FAN,0,i/3),f[14]-=.001}},a.strokeThin=function(){i<6||(u.uploadRange(0,4*i),r.setLineWidth(this.lineWidth),d.u_color=this._strokecolor,d.u_transform=this._matrix,d.u_viewport=N,T.uniforms(d).drawRange(s,r.LINE_STRIP,0,i/3))};var L=new Float32Array(3e4),U=new GL.Mesh,P=U.createVertexBuffer("vertices",null,null,L,r.STREAM_DRAW);a.stroke=function(){if(!(i<6)){if(F[0]=this._matrix[0],F[1]=this._matrix[1],this.lineWidth*vec2.length(F)<=1)return this.strokeThin();var t=L,e=i,n=.5*this.lineWidth,a=o,u=0,c=0,l=0,h=0,_=0,v=0,p=0,m=0;if(a[0]==a[i-3]&&a[1]==a[i-2])u=a[i-3]-a[i-6],c=a[i-2]-a[i-5],0!=(x=Math.sqrt(u*u+c*c))&&(u/=x,c/=x);var g,E=0;for(g=0;g<e-3;g+=3){var x;l=u,h=c,u=a[g+3]-a[g],c=a[g+4]-a[g+1],0!=(x=Math.sqrt(u*u+c*c))&&(u/=x,c/=x),0==g&&(p=u,m=c),_=u+l,v=c+h,0!=(x=Math.sqrt(_*_+v*v))&&(_/=x,v/=x),t[E+0]=a[g]-v*n,t[E+1]=a[g+1]+_*n,t[E+2]=1,t[E+3]=a[g]+v*n,t[E+4]=a[g+1]-_*n,t[E+5]=1,E+=6}if(a[0]==a[i-3]&&a[1]==a[i-2])_=u+p,v=c+m,0!=(x=Math.sqrt(_*_+v*v))&&(_/=x,v/=x),t[E+0]=a[g]-v*n,t[E+1]=a[g+1]+_*n,t[E+2]=1,t[E+3]=a[g]+v*n,t[E+4]=a[g+1]-_*n,t[E+5]=1;else 0!=(x=Math.sqrt(u*u+c*c))&&(_=u/x,v=c/x),t[E+0]=a[g]-(v-_)*n,t[E+1]=a[g+1]+(_+v)*n,t[E+2]=1,t[E+3]=a[g]+(v+_)*n,t[E+4]=a[g+1]-(_-v)*n,t[E+5]=1;E+=6,P.upload(r.STREAM_DRAW),P.uploadRange(0,4*E),d.u_transform=this._matrix,d.u_viewport=N,this._shadowcolor[3]>0&&(d.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),T.uniforms(d).drawRange(s,r.TRIANGLE_STRIP,0,E/3),this.restore()),d.u_color=this._strokecolor,T.uniforms(d).drawRange(U,r.TRIANGLE_STRIP,0,E/3),f[14]-=.001}},a.rect=function(t,e,r,n){o[i]=t,o[i+1]=e,o[i+2]=1,o[i+3]=t+r,o[i+4]=e,o[i+5]=1,o[i+6]=t+r,o[i+7]=e+n,o[i+8]=1,o[i+9]=t,o[i+10]=e+n,o[i+11]=1,o[i+12]=t,o[i+13]=e,o[i+14]=1,i+=15},a.roundRect=function(t,e,r,n,a,s){var u=0,c=0,l=0,f=0;if(0!==a){if(void 0===s&&(s=a),null!=a&&a.constructor===Array)if(1==a.length)u=c=l=f=a[0];else if(2==a.length)u=f=a[0],c=l=a[1];else{if(4!=a.length)return;u=a[0],c=a[1],l=a[2],f=a[3]}else u=a||0,c=a||0,l=s||0,f=s||0;var h=o,d=i;if(u>0)for(var _=0;_<10;++_){var v=_/10*Math.PI*.5;h[d]=t+u*(1-Math.cos(v)),h[d+1]=e+u*(1-Math.sin(v)),h[d+2]=1,d+=3}if(h[d+0]=t+u,h[d+1]=e,h[d+2]=1,h[d+3]=t+r-c,h[d+4]=e,h[d+5]=1,d+=6,c>0)for(_=0;_<10;++_){v=_/10*Math.PI*.5;h[d+0]=t+r-c*(1-Math.sin(v)),h[d+1]=e+c*(1-Math.cos(v)),h[d+2]=1,d+=3}if(h[d+0]=t+r,h[d+1]=e+c,h[d+2]=1,h[d+3]=t+r,h[d+4]=e+n-f,h[d+5]=1,d+=6,f>0)for(_=0;_<10;++_){v=_/10*Math.PI*.5;h[d+0]=t+r-f*(1-Math.cos(v)),h[d+1]=e+n-f*(1-Math.sin(v)),h[d+2]=1,d+=3}if(h[d+0]=t+r-f,h[d+1]=e+n,h[d+2]=1,h[d+3]=t+l,h[d+4]=e+n,h[d+5]=1,d+=6,l>0)for(_=0;_<10;++_){v=_/10*Math.PI*.5;h[d+0]=t+l*(1-Math.sin(v)),h[d+1]=e+n-l*(1-Math.cos(v)),h[d+2]=1,d+=3}h[d+0]=t,h[d+1]=e+u,h[d+2]=1,i=d+3}else this.rect(t,e,r,n)},a.arc=function(t,e,r,n,a){var i=Math.max(Math.abs(this._matrix[0]),Math.abs(this._matrix[1]),Math.abs(this._matrix[3]),Math.abs(this._matrix[4])),o=Math.ceil(2*r*i+1);if(!(o<1)){o=Math.min(o,1024),n=void 0===n?0:n;for(var s=((a=void 0===a?2*Math.PI:a)-n)/o,u=0;u<=o;u++){var c=n+u*s;this.lineTo(t+Math.cos(c)*r,e+Math.sin(c)*r)}}},a.strokeRect=function(t,e,r,n){this.beginPath(),this.rect(t,e,r,n),this.stroke()},a.fillRect=function(t,e,r,n){if(i=0,this._fillStyle.constructor==GL.Texture||this._fillStyle.constructor===D)return this.beginPath(),this.rect(t,e,r,n),void this.fill();d.u_color=this._fillcolor,F[0]=t,F[1]=e,C[0]=r,C[1]=n,d.u_position=F,d.u_size=C,d.u_transform=this._matrix,d.u_viewport=N,g.uniforms(d).draw(c),f[14]-=.001},a.clearRect=function(e,n,a,i){0==e&&0==n&&a==t.width&&i==t.height||(r.enable(r.SCISSOR_TEST),r.scissor(e,n,a,i)),r.clear(r.COLOR_BUFFER_BIT);var o=r.viewport_data;r.scissor(o[0],o[1],o[2],o[3]),r.disable(r.SCISSOR_TEST)},a.fillCircle=function(t,e,r){if(i=0,this._fillStyle.constructor==GL.Texture||this._fillStyle.constructor===D)return this.beginPath(),this.arc(t,e,r,0,2*Math.PI),void this.fill();d.u_color=this._fillcolor,F[0]=t,F[1]=e,C[0]=r,C[1]=r,d.u_position=F,d.u_size=C,d.u_transform=this._matrix,d.u_viewport=N,g.uniforms(d).draw(l),f[14]-=.001},a.start2D=function(){n=window.gl,window.gl=this;var t=this;t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.blendEquation(t.FUNC_ADD),t.lineWidth=1,i=0,mat4.identity(f),this.clip_level=0},a.finish2D=function(){i=0,r.lineWidth=1,window.gl=n,r.disable(r.STENCIL_TEST)};var G=new Float32Array(3e3),X=new Float32Array(2e3),V=new GL.Mesh,z=V.createVertexBuffer("vertices",null,null,G,r.STREAM_DRAW),k=V.createVertexBuffer("coords",null,null,X,r.STREAM_DRAW);function H(t,e,n){t=t||"monospace",e=e||"normal";getTime();var a=this.imageSmoothingEnabled,i=enableWebGLCanvas.useInternationalFont,o=1024,s=":font_"+t+":"+e+":"+i,u=v[s];if(u&&!n)return u;var c=200,l=10;i&&(c=400,l=20);var f=o/l|0,h=.95*f|0,d=createCanvas(o,o),_=d.getContext("2d");_.fillStyle="white",_.imageSmoothingEnabled=this.imageSmoothingEnabled,_.clearRect(0,0,d.width,d.height),_.font=e+" "+h+"px "+t,_.textAlign="center";var p=0,m=0,g=-.3*h,E={font_size:h,char_size:f,spacing:.6*f,space:_.measureText(" ").width/h};g+=enableWebGLCanvas.fontOffsetY*f;for(var x=E.kernings={},T=33;T<c;T++){var b=String.fromCharCode(T),y={width:M=_.measureText(b).width,nwidth:M/h};x[b]=y}for(T=33;T<c;++T){if((w=x[b=String.fromCharCode(T)])&&w.width&&(E[T]=[b,(p+.5*f)/d.width,(m+.5*f)/d.height],_.save(),_.beginPath(),_.rect(Math.floor(p)+.5,Math.floor(m)+.5,f-2,f-2),_.clip(),_.fillText(b,Math.floor(p+.5*f),Math.floor(m+f+g),f),_.restore(),(p+=f)+f>d.width&&(p=0,m+=f)),m+f>d.height)break}var A=T;for(T=33;T<A;++T)for(var w,M=(w=x[b=String.fromCharCode(T)]).width,R=33;R<A;++R){var F=String.fromCharCode(R),S=x[F].width;if(S){var B=_.measureText(b+F).width;w[F]=(1.45*B-M-S)/h}}return(u=GL.Texture.fromImage(d,{format:r.ALPHA,magFilter:a?r.LINEAR:r.NEAREST,minFilter:a?r.NEAREST_MIPMAP_LINEAR:r.NEAREST,premultiply_alpha:!1,anisotropic:8})).info=E,v[s]=u}a.fillText=a.strokeText=function(t,e,n){if(null!=t){t.constructor!==String&&(t=String(t));var a=H.call(this,this._font_family,this._font_mode),i=a.info,o=G,s=X,u=1.1*this._font_size;u<1&&(u=1);i.char_size;for(var c=0,l=0,f=t.length,h=(i.spacing,i.char_size,i.kernings),_=(i.font_size,this._font_size,!0),v=0,p=0,m=0;m<f;m++){var g=i[t.charCodeAt(m)];if(g){var E=h[t[m]];_&&(c-=u*E.nwidth*.25,_=!1),o[v+0]=e+c+.5*u,o[v+1]=n+l-.25*u,o[v+2]=1,v+=3,s[p+0]=g[1],s[p+1]=g[2],p+=2;var x=E[t[m+1]];c+=x?u*x:u*i.space}else 10==t.charCodeAt(m)?(c=0,l+=u,_=!0):c+=.5*u}var T=0;if("right"==this.textAlign?T=c+.5*u:"center"==this.textAlign&&(T=.5*(c+.5*u)),T)for(m=0;m<o.length;m+=3)o[m]-=T;return a.bind(0),z.uploadRange(0,4*v),k.uploadRange(0,4*p),d.u_color=this._fillcolor,d.u_pointSize=u*vec2.length(this._matrix),d.u_iCharSize=i.char_size/a.width,d.u_transform=this._matrix,d.u_viewport=N,d.u_angle_sincos||(d.u_angle_sincos=vec2.create()),d.u_angle_sincos[1]=Math.sin(-I),d.u_angle_sincos[0]=-Math.cos(-I),w.uniforms(d).drawRange(V,r.POINTS,0,v/3),{x:c,y:l}}},a.measureText=function(t){for(var e=H.call(this,this._font_family,this._font_mode).info,r=Math.ceil(1.1*this._font_size),n=0,a=r*e.spacing/e.char_size-1,i=0;i<t.length;++i){var o=e.kernings[t[i]];n+=o?o.nwidth:a/e.char_size}return{width:n*=r,height:r}},a.getImageData=function(t,e,n,a){var i=new Uint8Array(n*a*4);return r.readPixels(t,e,n,a,r.RGBA,r.UNSIGNED_BYTE,i),{data:i,width:n,height:a,resolution:1}},a.putImageData=function(t,e,n){var a=new GL.Texture(t.width,t.height,{filter:r.NEAREST,pixel_data:t.data});a.renderQuad(e,n,a.width,a.height)},Object.defineProperty(r,"fillStyle",{get:function(){return this._fillStyle},set:function(t){t&&(this._fillStyle=t,hexColorToRGBA(t,this._fillcolor,this._globalAlpha))}}),Object.defineProperty(r,"strokeStyle",{get:function(){return this._strokeStyle},set:function(t){t&&(this._strokeStyle=t,hexColorToRGBA(t,this._strokecolor,this._globalAlpha))}}),Object.defineProperty(r,"fillColor",{get:function(){return this._fillcolor},set:function(t){t&&(t.length<5?this._fillcolor.set(t):console.error("fillColor value has more than 4 components"))}}),Object.defineProperty(r,"strokeColor",{get:function(){return this._strokecolor},set:function(t){t&&(t.length<5?this._strokecolor.set(t):console.error("strokeColor value has more than 4 components"))}}),Object.defineProperty(r,"shadowColor",{get:function(){return this._shadowcolor},set:function(t){t&&hexColorToRGBA(t,this._shadowcolor,this._globalAlpha)}}),Object.defineProperty(r,"globalAlpha",{get:function(){return this._globalAlpha},set:function(t){this._globalAlpha=t,this._strokecolor[3]=this._fillcolor[3]=t}}),Object.defineProperty(r,"globalCompositeOperation",{get:function(){return this._globalCompositeOperation},set:function(t){switch(this._globalCompositeOperation=t,r.blendEquation(r.FUNC_ADD),t){case"source-over":r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);break;case"difference":r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.blendEquation(r.FUNC_REVERSE_SUBTRACT)}}}),Object.defineProperty(r,"font",{get:function(){return this._font},set:function(t){this._font=t;var e=t.split(" ");3==e.length?(this._font_mode=e[0],this._font_size=parseFloat(e[1]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<10&&(this._font_size=10),this._font_family=e[2]):2==e.length?(this._font_mode="normal",this._font_size=parseFloat(e[0]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<10&&(this._font_size=10),this._font_family=e[1]):(this._font_mode="normal",this._font_family=e[0])}}),a._fillcolor=vec4.fromValues(0,0,0,1),a._strokecolor=vec4.fromValues(0,0,0,1),a._shadowcolor=vec4.fromValues(0,0,0,0),a._globalAlpha=1,a._font="14px monospace",a._font_family="monospace",a._font_size="14px",a._font_mode="normal",a.clip_level=0,a.strokeStyle="rgba(0,0,0,1)",a.fillStyle="rgba(0,0,0,1)",a.shadowColor="transparent",a.shadowOffsetX=a.shadowOffsetY=0,a.globalAlpha=1,a.globalCompositeOperation="source-over",a.setLineWidth=a.lineWidth,a.lineWidth=4,a.imageSmoothingEnabled=!0,a.tintImages=!1;var q=["arcTo","isPointInPath","createImageData"],W=function(){};for(var j in q)a[q[j]]=W;return a}enableWebGLCanvas.useInternationalFont=!1,enableWebGLCanvas.fontOffsetY=0;